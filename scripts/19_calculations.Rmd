---
title: "Calculating raw materials demands across scenarios"
author: "Rich Cottrell"
date: "20/02/2023"
output: html_document
---

Set up
```{r}

library(tidyverse)
library(here)
library(terra)

#ALLOCATION METHOD (un-comment preference)
this_allocation_method <- "econ_allocation"
# this_allocation_method <- "ge_allocation"
# this_allocation_method <- "mass_allocation"


```

```{r}

crop_demand <- 
  readRDS(here("data/tidy_data/demand/total_crop_demand.rds")) |> 
  filter(total_crop_demand >0 ) |>
  rename(demand_from = ingredients,
         demand = total_crop_demand,
         type=FAOSTAT_name) |> 
  select(diet, demand_from, type, demand)

fish_demand <- 
  bind_rows(readRDS(here("data/tidy_data/demand/embodied_trimmingsfish_demand_by_source_diet.rds")) |> mutate(type="Trimmings"),
                         readRDS(here("data/tidy_data/demand/embodied_foragefish_demand_by_source_diet.rds")) |> mutate(type= "Wild-caught") |> rename(embodied_fish = embodied_foragefish)) |> 
  rename(demand = embodied_fish) |> select(diet, demand_from, fao_area_code, type, demand)


```



Basic calculations of diet vs.marine/terrestrial
```{r}


raw_material_iteration <- 
  map_df(.x = unique(fish_demand$fao_area_code), .f = \(this_area){
  
  return(bind_rows(fish_demand |> 
  filter(fao_area_code == this_area) |> 
  group_by(demand_from, fao_area_code, diet) |> 
  summarise(demand = sum(demand, na.rm=TRUE)) |> 
  ungroup()  |>
  rename(type = demand_from),
  
crop_demand |> 
  group_by(diet, type) |> 
  summarise(demand = sum(demand, na.rm=TRUE)) |>
  mutate(fao_area_code = this_area))|> 
    arrange(diet, fao_area_code, type)) 
  
})
  

raw_material_totals <- 
  raw_material_iteration |> 
  filter(type!="Total") |> 
  group_by(diet, fao_area_code) |>
  summarise(total_biomass = sum(demand)) |> 
  ungroup() |> 
  group_by(diet) |> 
  summarise(mean_biomass = mean(total_biomass, na.rm=TRUE),
            sd_biomass = sd(total_biomass, na.rm=TRUE))

saveRDS(raw_material_totals, file = sprintf(here("data/tidy_data/demand/total_raw_material_demand_%s.rds"), this_allocation_method))
  



raw_material_totals_by_origin <- 
  raw_material_iteration |> 
  mutate(origin = case_when(type %in% c("Fishmeal", "Fish oil") ~ "Marine",
                            TRUE ~ "Terrestrial")) |> 
  group_by(diet, origin, fao_area_code) |>
  summarise(total_biomass_by_origin = sum(demand)) |> 
  ungroup() |> 
  group_by(diet, origin) |> 
  summarise(mean_biomass_by_origin = mean(total_biomass_by_origin, na.rm=TRUE),
            sd_biomass_by_origin = sd(total_biomass_by_origin, na.rm=TRUE))


saveRDS(raw_material_totals_by_origin, file = sprintf(here("data/tidy_data/demand/total_raw_material_demand_by_origin_%s.rds"), this_allocation_method))

  
```

```{r}
raw_material_iteration |> 
  filter(type %in%  c("Fishmeal", "Fish oil", "Total")) |>
  mutate(fao_area_code = factor(fao_area_code),
         diet = case_when(diet == "marine_diet" ~ "Fish-dominant diet", TRUE ~ "Plant-dominant diet")) |> 
  ggplot(aes(x = type, y = demand/1000, fill = fao_area_code))+
  geom_bar(stat = "identity", position = "dodge")+
  facet_grid(cols = vars(diet))+
  theme_bw()+
  scale_fill_manual(values = RColorBrewer::brewer.pal(n=8, name = "BuPu")[3:8])+
  theme(legend.position =  c(0.66,0.76),
        legend.background = element_rect(fill="transparent"),
        panel.grid = element_blank(),
        axis.title.x= element_blank(),
        text = element_text(size=8),
        legend.text = element_text(size=7),
        legend.title = element_text(size=7),
        legend.key.size = unit(0.3, "cm"))+
  labs(y = "Embodied fish demand (1000s tonnes)", fill = "FAO fishing area")

ggsave(filename = sprintf(here("figures/embodied_fish_demand_%s.jpeg"), this_allocation_method), dpi = 600, device = "jpeg", width = 9, height = 6, units = "cm")




#calculations

raw_material_iteration |> 
  filter(type %in%  c("Total") & diet == "marine_diet") |> pull(demand) |> sort() |> pluck(2)-raw_material_iteration |> 
  filter(type %in%  c("Total") & diet == "marine_diet") |> pull(demand) |> sort() |> pluck(1)
  

```




```{r}

all_data <- readRDS(file = sprintf(here("data/tidy_data/pressures/marine_plant_disaggregated_pressures_by_ingredient_combined_df_%s.rds"),this_allocation_method))


summary_by_pressure <- 
  all_data |> 
  group_by(diet, source, pressure) |> 
  summarise(cpi_cont = sum(sum, na.rm=TRUE)) |> 
   ungroup() |> 
   group_by(pressure, diet) |> 
   summarise(median = median(cpi_cont),
             mean = mean(cpi_cont),
             min = min(cpi_cont),
             max = max(cpi_cont))


#how much higher is median disturbance pressure in fish-dominant scenario?

summary_by_pressure |> filter(pressure == "Disturbance") |> pull(median) |> pluck(1)/summary_by_pressure |> filter(pressure == "Disturbance") |> pull(median) |> pluck(2)

#how much higher is median GHG, nutrients, and water in plant-dominant feed?
summary_by_pressure |> filter(pressure == "GHG") |> pull(median) |> pluck(2)/summary_by_pressure |> filter(pressure == "GHG") |> pull(median) |> pluck(1)
summary_by_pressure |> filter(pressure == "Nutrients") |> pull(median) |> pluck(2)/summary_by_pressure |> filter(pressure == "Nutrients") |> pull(median) |> pluck(1)
summary_by_pressure |> filter(pressure == "Water") |> pull(median) |> pluck(2)/summary_by_pressure |> filter(pressure == "Water") |> pull(median) |> pluck(1)


#How much do minimum and maximum scores vary across different diets and pressures
summary_by_pressure |> filter(pressure == "GHG" & diet == "marine diet") |> pull(max)/summary_by_pressure |> filter(pressure == "GHG" & diet == "marine diet") |> pull(min)

summary_by_pressure |> filter(pressure == "GHG" & diet == "marine diet") |> pull(max)/summary_by_pressure |> filter(pressure == "GHG" & diet == "plant diet") |> pull(min)


summary_by_pressure |> filter(pressure == "Nutrients" & diet == "plant diet") |> pull(min)/summary_by_pressure |> filter(pressure == "Nutrients" & diet == "marine diet") |> pull(max)


```


Some statistics on the number of species/crop raw materials/countries/marine regions needed to support demand. 

```{r}
forage_fish <- data.table::fread(here("data/tidy_data/demand/embodied_fish_per_cell.csv"))
forage_fish_md <- forage_fish |> filter(diet == "marine_diet") |> as_tibble()
unique(forage_fish$CommonName)
sum(forage_fish_md$total_catch)


#Number of countries for crops
countries_regions <-
  c(list.files("/mnt/rdsi/github/feed_pressure_mapping/data/spatial/marine_diet/pressures", full.names = TRUE), list.files("/mnt/rdsi/github/feed_pressure_mapping/data/spatial/plant_diet/pressures", full.names = TRUE)) |>
  map(.f = \(this_element){
    sans_ext <- tools::file_path_sans_ext(this_element)
    
    last_3 <-  str_sub(string = sans_ext, start = nchar(sans_ext)-2, end = nchar(sans_ext))
    return(last_3)
  }) |> 
  unlist() |> 
  unique() 


length(countries_regions[!countries_regions %in% c("EPC", "NAT", "OTH")]) # 18 countries used and 3 marine regions


#number of crop types
total_crop_demand <- readRDS("/mnt/rdsi/github/feed_pressure_mapping/data/tidy_data/demand/total_crop_demand.rds") 
total_crop_demand |> pull(FAOSTAT_name) |> unique()
total_crop_demand |> filter(FAOSTAT_name == "Pulses nes")

#forage fish embodied demand by regions
embodied_fish_bysource <- readRDS(here("data/tidy_data/demand/embodied_fish_demand_by_source_diet.rds")) |> 
  mutate(source_code = case_when(source_code == "EPC" ~ "Eastern Pacific",
                                 source_code == "NAT" ~ "North Atlantic",
                                 source_code == "OTH" ~ "All other regions")) |> 
  mutate(source_code = factor(source_code, levels = c("Eastern Pacific", "North Atlantic", "All other regions"))) |> 
  mutate(diet = if_else(diet=="marine_diet", true = "Fish-dominant\nfeed", false = "Plant-dominant\nfeed"))

#how much more embodied fish does a marine diet create relative to plant?
source_codes <- unique(embodied_fish_bysource$source_code) |> as.character()
diff_list_ge <- list()
diff_list_mass <- list()
amount_list <- list()

for(s in source_codes){
 
  marine_plant_ratio_ge <-  
    (embodied_fish_bysource |> filter(source_code == s & allocation == "Energetic allocation" & diet == "Fish-dominant\nfeed" & demand_from == "Total") |> pull(embodied_fish))/(embodied_fish_bysource |> filter(source_code == s & allocation == "Energetic allocation" & diet == "Plant-dominant\nfeed" & demand_from == "Total") |> pull(embodied_fish))
  
  marine_plant_ratio_mass <-  
    (embodied_fish_bysource |> filter(source_code == s & allocation == "Mass allocation" & diet == "Fish-dominant\nfeed" & demand_from == "Total") |> pull(embodied_fish))/(embodied_fish_bysource |> filter(source_code == s & allocation == "Mass allocation" & diet == "Plant-dominant\nfeed" & demand_from == "Total") |> pull(embodied_fish))
  
  
 diff_list_ge[which(source_codes==s)] <- marine_plant_ratio_ge
 
 diff_list_mass[which(source_codes==s)] <- marine_plant_ratio_mass
 
}

unlist(diff_list_ge) #~2.2 across all regions and allocation methods=
unlist(diff_list_mass)

#Differences among regions within marine-dominant feed
embodied_fish_bysource |> 
  filter(diet == "Fish-dominant\nfeed" & demand_from == "Total") |> 
  arrange(-embodied_fish) |> 
  mutate(region_diff = max(embodied_fish)-embodied_fish)

embodied_fish_bysource |>
  filter(demand_from =="Total") |> 
  group_by(diet, allocation) |> 
  summarise(mean = mean(embodied_fish, na.rm=TRUE),
            sd = sd(embodied_fish, na.rm=TRUE))


ggplot(data = embodied_fish_bysource) +
  aes(x = demand_from, y = embodied_fish/1000, fill = source_code)+
  geom_bar(stat= "identity", position = "dodge")+
  facet_grid(rows = vars(diet), cols = vars(allocation), scales = "fixed")+
  
  labs(fill = "Origin", y = "Embodied fish demand (1000s T)")+
  scale_fill_manual(values = c("#edf8b1", "#7fcdbb", "#2c7fb8"))+
  theme_bw()+
  theme(legend.position = c(0.65, 0.35),
        legend.background = element_rect(fill="transparent"), 
        axis.title.x = element_blank(),
        panel.grid = element_blank(), 
        text = element_text(size=12),
        legend.text = element_text(size = 10))+
  guides(fill = guide_legend(title.position = "top"))

ggsave(filename = here("figures/presos/embodied_forage_fish_demand.jpg"), device="jpg", dpi = 600, width = 18, height = 15, units="cm")
ggsave(filename = here("figures/supplementary/embodied_forage_fish_demand.jpg"), device="jpg", dpi = 600, width = 18, height = 15, units="cm")



#find reasons for differences in demand
#blue whiting looks like the main reason with European sprat also. Comparing the embodied fish versus the catch both Sprat and Whiting rank as higher in embodied fish than for catch
(embodied_fish_rank <- 
  fread("/mnt/rdsi/github/feed_pressure_mapping/data/tidy_data/demand/embodied_fish_per_cell.csv") |> 
  lazy_dt() |> 
  group_by(diet, source_code, TaxonName, CommonName) |> 
  summarise(total_demand_ge = sum(total_embodied_fish_ge, na.rm = TRUE),
            total_demand_mass = sum(total_embodied_fish_mass, na.rm = TRUE)) |> 
  filter(diet == "marine_diet") |> 
  arrange(-total_demand_mass) |> 
  as_tibble())


(fish_catch_rank <- 
  fread("/mnt/rdsi/github/feed_pressure_mapping/data/tidy_data/demand/embodied_fish_per_cell.csv") |> 
  lazy_dt() |> 
  group_by(diet, source_code, TaxonName, CommonName) |> 
  summarise(total_catch = sum(total_catch, na.rm = TRUE)) |> 
  filter(diet == "marine_diet") |> 
  arrange(-total_catch) |> 
  as_tibble())


left_join(embodied_fish_rank, fish_catch_rank) |> mutate(disproportion_mass =  total_demand_mass/total_catch) |> arrange(-disproportion_mass)
```

