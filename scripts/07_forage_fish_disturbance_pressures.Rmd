---
title: "Spatial Allocation of Forage fish demand from each diet and source"
output: html_document
---

The disturbance metric established in Halpern et al is composed of two elements:

- Benthic destruction - hours of fishing effort from bottom trawlers and dredgers to catch forage fish species
- Biomass removal i.e. the appropriated portion net primary productivity
  
```{r}

library(tidyverse)
library(here)
library(terra)
library(sf)
library(data.table)
library(dtplyr)

source(here("src/directories.R"))
source(here("src/spatial.R"))

```

To understand the benthic component of disturbance, we need to know if there are any destrcutive fishing gears associated withe forage fish catch. 

Here we join the gear classification data from Halpern et al of destructive or non destructive/ pelagic or demersal to the catch data.

```{r}

#create the list of gear relevant to the forage fish catch data

forage_gears <- readRDS(here("data/raw_data/fisheries/spatial_forage_catch_2017.rds")) |> 
  select(Gear, VBDesc) |> distinct()

write_csv(x = forage_gears, file = here("data/raw_data/fisheries/forage_gears.csv"))

#join the categories from Halpern et al to the gears relevant for forage fish only

gears_to_cat <- read_csv(here("data/raw_data/fisheries/gears_to_cat.csv"))


forage_gear_cats <- forage_gears |> left_join(gears_to_cat, by = c("Gear", "VBDesc"))

#assign categories to existing classifcation of pelagic
forage_catch_w_cats <- 
  readRDS(here("data/raw_data/fisheries/spatial_forage_catch_2017.rds")) |> 
  left_join(forage_gear_cats, by = c("Gear", "VBDesc")) |> 
  mutate(type = case_when(grepl("pelagic|krill", Descript) ~ "pelagic",
                          grepl("benthopelagic|demersal", Descript) ~ "demersal"))
  

saveRDS(object = forage_catch_w_cats, file = here("data/raw_data/fisheries/spatial_forage_catch_2017_w_cats.rds"))

#some checks throughout
unique(forage_catch_w_cats$Descript)
forage_catch_w_cats |> filter(Descript == "krill") |> pull(VBDesc) |> unique()
forage_catch_w_cats |> filter(is.na(type))# no NA values
forage_catch_w_cats |> filter(is.na(bycatch)) #no na values
```


We  have effort rasters for all fishing for destructive gears (trawling and dredge) but we need to know how much of that forage fish represent in each cell.  


To do this we need to know what proportion of all trawling (the resolution in the GW dataset) bottom trawling for forage fish species represent:

- Create catch rasters for all trawling 
- Create rasters for all bottom trawling and dredging for forage fish species.
- Multiply the proportion of of bottom trawling or dredging from forage fish species



```{r}

total_catch <- fread(file.path(watson_dir, "v5.0/watson_2017_fisheries_catch.csv"))

gears_to_cat <- read_csv(here("data/raw_data/fisheries/gears_to_cat.csv")) |> mutate(bycatch = if_else(is.na(bycatch), true = "low", false = bycatch))

total_catch_w_cat <- total_catch |> 
  lazy_dt(immutable = FALSE) |> 
  left_join(gears_to_cat, by = c("Gear", "VBDesc"))  |>  
  mutate(type = case_when(grepl("pelagic|krill", Descript) ~ "pelagic",
                          grepl("benthopelagic|demersal", Descript) ~ "demersal")) |> 
  as.data.table()
  
fwrite(x = total_catch_w_cat, file =  file.path(watson_dir, "v5.0/watson_2017_fisheries_catch_w_cat.csv"))

#Now create some rasters of the proportion of trawling that is bottom trawling and non-hand dredging to allow us to get a raster of bottom trawling in effort

#First we need to know what the types of trawl and dredge are in teh fisheries data
trawl_types <- unique(total_catch_w_cat$VBDesc)[grep("trawl", unique(total_catch_w_cat$VBDesc))]
dredge_types <- unique(total_catch_w_cat$VBDesc)[grep("dredg", unique(total_catch_w_cat$VBDesc))]


all_trawl_fishing <- 
  total_catch |>
  lazy_dt(immutable = FALSE) |> 
  filter(VBDesc %in% trawl_types) |> 
  group_by(LonCentre, LatCentre) |> 
  summarise(total_catch = sum(ReportedNIND+ReportedIND+IUUIND+IUUNIND, na.rm = TRUE)) |> 
  drop_na(LonCentre, LatCentre) |> 
  as.data.table()



## all bottom trawling for forage fish

forage_catch <- readRDS(file = here("data/raw_data/fisheries/spatial_forage_catch_2017_w_cats.rds"))


forage_bottom_trawl_fishing <- 
  forage_catch |> 
  as.data.table() |> 
  lazy_dt(immutable = FALSE) |> 
  filter(VBDesc == "bottom trawls") |> 
  group_by(LonCentre, LatCentre) |> 
  summarise(total_catch = sum(ReportedNIND+ReportedIND+IUUIND+IUUNIND, na.rm = TRUE)) |> 
  drop_na(LonCentre, LatCentre) |> 
  as.data.table()
  

all_trawl_r <- rast(all_trawl_fishing, type="xyz", crs = "EPSG:4326")
forage_bottom_trawl_r <- rast(forage_bottom_trawl_fishing, type="xyz", crs = "EPSG:4326")
ext(forage_bottom_trawl_r) <- ext(all_trawl_r)
test_r <- rast()
values(test_r) <- 0
plot(all_trawl_r)  
plot(bottom_trawl_r) 

prop_bottom_trawl_r <-  forage_bottom_trawl_r/all_trawl_r
plot(prop_bottom_trawl_r)




#now so the same for dredge fishing

all_trawl_fishing <- 
  total_catch |>
  lazy_dt(immutable = FALSE) |> 
  filter(VBDesc %in% trawl_types) |> 
  group_by(LonCentre, LatCentre) |> 
  summarise(total_catch = sum(ReportedNIND+ReportedIND+IUUIND+IUUNIND, na.rm = TRUE)) |> 
  drop_na(LonCentre, LatCentre) |> 
  as.data.table()


bottom_trawl_fishing <- 
   total_catch |>
  lazy_dt(immutable = FALSE) |> 
  filter(VBDesc == "bottom trawls") |> 
  group_by(LonCentre, LatCentre) |> 
  summarise(total_catch = sum(ReportedNIND+ReportedIND+IUUIND+IUUNIND, na.rm = TRUE)) |> 
  drop_na(LonCentre, LatCentre) |> 
  as.data.table()
  

all_trawl_r <- rast(all_trawl_fishing, type="xyz")
bottom_trawl_r <- rast(bottom_trawl_fishing, type="xyz")
plot(all_trawl_r)  
plot(bottom_trawl_r) 

prop_bottom_trawl_r <-  bottom_trawl_r/all_trawl_r
plot(prop_bottom_trawl_r)





```




