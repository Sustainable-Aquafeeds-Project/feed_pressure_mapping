---
title: "Spatial Allocation of Forage fish demand from each diet and source"
output: html_document
---

The disturbance metric established in Halpern et al is composed of two elements:

- Benthic destruction - hours of fishing effort from bottom trawlers and dredgers to catch forage fish species
- Biomass removal i.e. the appropriated portion net primary productivity
  
```{r}

library(tidyverse)
library(here)
library(terra)
library(sf)
library(data.table)
library(dtplyr)
library(future)
library(furrr)

source(here("src/directories.R"))
source(here("src/spatial.R"))

```

To understand the benthic component of disturbance, we need to know if there are any destrcutive fishing gears associated withe forage fish catch. 

Here we also join the gear classification data from Halpern et al of destructive or non destructive/ pelagic or demersal to the catch data which helps with the next step of isolating all trawling and dredging, and the trawling and dredging that forage fish represent.

```{r}

#create the list of gear relevant to the forage fish catch data

forage_gears <- readRDS(here("data/raw_data/fisheries/spatial_forage_catch_2017.rds")) |> 
  select(Gear, VBDesc) |> distinct()

write_csv(x = forage_gears, file = here("data/raw_data/fisheries/forage_gears.csv"))

#join the categories from Halpern et al to the gears relevant for forage fish only

gears_to_cat <- read_csv(here("data/raw_data/fisheries/gears_to_cat.csv"))


forage_gear_cats <- forage_gears |> left_join(gears_to_cat, by = c("Gear", "VBDesc"))

#assign categories to existing classification of pelagic or demersal
forage_catch_w_cats <- 
  readRDS(here("data/raw_data/fisheries/spatial_forage_catch_2017.rds")) |> 
  left_join(forage_gear_cats, by = c("Gear", "VBDesc")) |> 
  mutate(type = case_when(grepl("pelagic|krill", Descript) ~ "pelagic",
                          grepl("benthopelagic|demersal", Descript) ~ "demersal"))
  

saveRDS(object = forage_catch_w_cats, file = here("data/raw_data/fisheries/spatial_forage_catch_2017_w_cats.rds"))

#some checks throughout
unique(forage_catch_w_cats$Descript)
forage_catch_w_cats |> filter(Descript == "krill") |> pull(VBDesc) |> unique()
forage_catch_w_cats |> filter(is.na(type))# no NA values
forage_catch_w_cats |> filter(is.na(bycatch)) #no na values
```


We  have effort rasters for all fishing for destructive gears (trawling and dredge) but we need to know how much of that forage fish represent in each cell for each demand scenario in each diet.

To do this we need to know what proportion of all trawling (the resolution in the GW dataset) is bottom trawling for forage fish species represented in each diet and sourcing scenario:

- Create catch rasters for all trawling 
- Create rasters for all bottom trawling and dredging for forage fish species.
- Multiply the proportion of of bottom trawling or dredging from forage fish species

So first lets create catch rasters for all trawling.

```{r}
total_catch <- fread(file.path(watson_dir, "v5.0/watson_2017_fisheries_catch.csv"))

gears_to_cat <- read_csv(here("data/raw_data/fisheries/gears_to_cat.csv")) |> mutate(bycatch = if_else(is.na(bycatch), true = "low", false = bycatch))

#join the gear categories to the fisheries catch to isolate trawling

total_catch_w_cat <- total_catch |> 
  lazy_dt(immutable = FALSE) |> 
  left_join(gears_to_cat, by = c("Gear", "VBDesc"))  |>  
  mutate(type = case_when(grepl("pelagic|krill", Descript) ~ "pelagic",
                          grepl("benthopelagic|demersal", Descript) ~ "demersal")) |> 
  as.data.table()

#this could be useful so save for later  
fwrite(x = total_catch_w_cat, file =  file.path(watson_dir, "v5.0/watson_2017_fisheries_catch_w_cat.csv"))

#Now create some rasters of the proportion of trawling that is bottom trawling and non-hand dredging to allow us to get a raster of bottom trawling in effort

#First we need to know what the types of trawl and dredge are in teh fisheries data
trawl_types <- unique(total_catch_w_cat$VBDesc)[grep("trawl", unique(total_catch_w_cat$VBDesc))]
dredge_types <- unique(total_catch_w_cat$VBDesc)[grep("dredg", unique(total_catch_w_cat$VBDesc))]


#isolate data for all fish trawling

all_trawl_fishing <- 
  total_catch |>
  lazy_dt(immutable = FALSE) |> 
  filter(VBDesc %in% trawl_types) |> 
  group_by(LonCentre, LatCentre) |> 
  summarise(total_catch = sum(ReportedNIND+ReportedIND+IUUIND+IUUNIND, na.rm = TRUE)) |> 
  drop_na(LonCentre, LatCentre) |> 
  as.data.frame()


all_trawl_r <- rast(all_trawl_fishing, type = "xyz", crs = "EPSG:4326")
writeRaster(x = all_trawl_r, filename = here("data/spatial/03-fisheries-effort/all_trawling_catch.tif"), overwrite=TRUE)

```

Next step is to understand  what proportion of all trawling the forage catch needed for each deamnd scenario represents so we can convert it into hours of effort for each diet/sourcing combination. So first we can prep the embodied forage fish demand per cell into raster form for the trawling component.

First we'll isolate which gears are destructive for forage fish.
```{r}
#create the list of gear relevant to the forage fish catch data

forage_gears <- fread(here("data/tidy_data/demand/embodied_fish_per_cell.csv")) |> 
  lazy_dt(immutable = FALSE) |> 
  select(Gear, VBDesc) |> 
  distinct() |> 
  as_tibble()

write_csv(x = forage_gears, file = here("data/raw_data/fisheries/forage_gears.csv"))

#join the categories from Halpern et al to the gears relevant for forage fish only

gears_to_cat <- read_csv(here("data/raw_data/fisheries/gears_to_cat.csv"))


#So for forage fish we are only interested "bottom trawls" as a destrcutive method
forage_gear_cats <- forage_gears |> left_join(gears_to_cat, by = c("Gear", "VBDesc"))


```

For pressures all we are interested is the bottom trawl component so now we isolate the embodied demand (catch) estimates and filter to just bottom trawls and sum catch per cell, and export the rasters.

```{r}

#create list of dataframe of trawling for forage fish by diet and sourcing
trawl_forage_catch_list <- 
  fread(here("data/tidy_data/demand/embodied_fish_per_cell.csv")) |> 
  lazy_dt(immutable = FALSE) |> 
  filter(VBDesc == "bottom trawls") |> 
  as_tibble() |> 
  group_split(diet, source_code)

#summarise the data by cell and write to data folder

map(trawl_forage_catch_list, \(this_df){
  
  this_diet <- unique(this_df$diet)
  
  this_source <- unique(this_df$source_code)
  
  this_summary_df <- 
    this_df |> 
    group_by(LonCentre, LatCentre) |> 
    summarise(forage_catch = sum(adj_embodied_fish, na.rm=TRUE))
  
  
  this_rast <- rast(this_summary_df, type="xyz", crs="EPSG:4326")
  this_rast_resampled <- resample(this_rast, rast(res=0.5))
  plot(this_rast)
  
  writeRaster(x = this_rast_resampled, filename = sprintf(here("data/spatial/03-fisheries-effort/forage_trawl_catch_%s_%s.tif"), this_diet, this_source), overwrite=TRUE)
  
})

# now look at dredging - but there is no catch for dredging so we can disregard

trawl_forage_catch_list <- fread(here("data/tidy_data/demand/embodied_fish_per_cell.csv")) |> 
  lazy_dt(immutable = FALSE) |> 
  filter(VBDesc %in% dredge_types) |> 
  as_tibble()



```

Now we need to work out what proportion of all trawling each one of the trawling for forage fish catch rasters represents across diets and sources so we can create a proportional raster to multiply by effort.

```{r}
forage_catch_r_list_int <- list.files(path = here("data/spatial/03-fisheries-effort"), pattern = "forage_trawl_catch", full.names = TRUE)
forage_catch_r_list <- forage_catch_r_list_int[!grepl("_prop", forage_catch_r_list_int)]

#calculate the proportion of all trawl catch is this diet scenario
map(.x = forage_catch_r_list, .f = \(this_file){
  
  message("processing ", tools::file_path_sans_ext(basename(this_file)))
  
  saveName <- paste0(tools::file_path_sans_ext(basename(this_file)), "_prop")
  
  this_r <- rast(this_file)
  
  all_trawL_r <- rast(here("data/spatial/03-fisheries-effort/all_trawling_catch.tif"))
  all_trawl_r <- extend(all_trawl_r, ext(rast(res=0.5)))
  
  
  this_stack_r <- c(this_r, all_trawl_r)
  
  lapp(x= this_stack_r, fun = \(x,y){x/y}, filename = sprintf(here("data/spatial/03-fisheries-effort/%s.tif"), saveName), overwrite=TRUE)
  
  
})


```

With proportions of all forage fish trawling now available for each diet and source, we can now resample the proportional rasters to the res and extent of the effort data and multiply them together to get hours of trawling for forage fish per diet and source.


```{r}
#proportional catch raster for forage fish trawling
prop_raster_files <- list.files(path = here("data/spatial/03-fisheries-effort"), pattern = "_prop.tif", full.names = TRUE)

# the total trawling effort
gfw_native_r <- rast(here("data/spatial/03-fisheries-effort/gfw_annual_effort_2017_trawlers.tif"))


#bring in the shapefile for cropping effort rasters by relevant source area
FAO_regions_shp <- read_sf("https://www.fao.org/fishery/geoserver/fifao/ows?service=WFS&request=GetFeature&version=1.0.0&typeName=fifao:FAO_AREAS_CWP_NOCOASTLINE&outputFormat=json") |> filter(F_LEVEL == "MAJOR") |> 
  mutate(F_AREA = as.numeric(F_AREA)) |> 
  mutate(source_code = case_when(NAME_EN == "Atlantic, Northeast" ~ "NAT",
                                 NAME_EN %in% c("Pacific, Northeast", "Pacific, Eastern Central", "Pacific, Southeast") ~ "EPC",
                                                      TRUE ~ "OTH")) 


# now crop each proportional catch raster by the source shapefile and multiply the trawl effort raster 

map(.x = prop_raster_files, .f = \(this_file){
  
  fileName <- gsub(pattern = "catch", replacement = "effort", tools::file_path_sans_ext(basename(this_file)))
  fileName <- gsub(pattern = "_prop", replacement = "", fileName)
  
  saveName <- sprintf(here("data/spatial/03-fisheries-effort/%s.tif"), fileName)
  
  if(!file.exists(saveName)){
    
  this_source <- substr(fileName, nchar(fileName)-3+1, nchar(fileName) )
  
  #get the FAO regions shp for masking the raster to the relevant ones
  this_shp_extent <- FAO_regions_shp |> filter(source_code ==this_source)
  
  message("processing ", tools::file_path_sans_ext(basename(this_file)))
  
  this_rast <- rast(this_file)
  
  #add average value where 
  avg_trawl_correction <- terra::global(this_rast, na.rm = TRUE) |> pull(mean)
  
  this_rast[is.na(this_rast)] <- avg_trawl_correction
  
  this_cropped_rast <- terra::mask(this_rast, vect(this_shp_extent))
   
  this_resampled_rast <- resample(this_cropped_rast, gfw_native_r)
  
  this_stack_r <- c(this_resampled_rast, gfw_native_r) 
  
  this_effort_raster <- lapp(this_stack_r, fun = \(x, y){x * y}, filename = saveName , overwrite=TRUE)
    
  }
})
```


Now we need to bring in the effort rasters and aggregate to half a degree and adjust to effort per km2.

```{r}

forage_effort_files_int <- list.files(here("data/spatial/03-fisheries-effort"), pattern = "forage_trawl_effort", full.names=TRUE)
forage_effort_files <- forage_effort_files_int[!grepl("0.5D_km2", forage_effort_files_int)]

#this_file <- forage_effort_files[[3]]

#aggregate the effort data to 0;5 degrees and adjust to effort for km2

map(.x = forage_effort_files, .f = \(this_file){
  
  fileName <- paste0(gsub(pattern = "catch", replacement = "effort", tools::file_path_sans_ext(basename(this_file))), "_0.5D_km2")
  
  saveName <- sprintf(here("data/spatial/03-fisheries-effort/%s.tif"), fileName)
  
  message("Processing ", fileName)
  
  if(!file.exists(saveName)){
    
    this_r <- rast(this_file)
    
    this_aggregate_r <- terra::aggregate(this_r, fact = 50, fun = sum, na.rm = TRUE)
    
    this_xy <- terra::as.data.frame(this_aggregate_r, xy = TRUE) |> mutate(x = round((x+0.25)*2)/2-0.25,
                                                                           y = round((y+0.25)*2)/2-0.25)
    
    this_new_r <- rast(this_xy, type = "xyz", crs = "EPSG:4326") |> extend(rast(res=0.5))
    
    this_new_km2_r <- this_new_r/cellSize(this_new_r, unit = "km")
    
    writeRaster(x = this_new_km2_r, filename = saveName, overwrite = TRUE)
  }
})

```

For the final step in the destruction layer of disturbance, we need to normalise the effort between 0 and 1. The 99th percentile is used to rescale to avoid the undue influence of outliers

```{r}

forage_effort_km2_r_files <- list.files(path = here("data/spatial/03-fisheries-effort"), pattern = "_0.5D_km2", full.names = TRUE) 

#get all the values for the forage trawl effort rasters

forage_effort_km2_r_list <- map(forage_effort_km2_r_files, \(this_file){
  
  this_rast <- rast(this_file)
  
  these_values <- c(terra::values(this_rast, na.rm=TRUE))
  
  return(these_values)
})



#this run returns "Error in (function (x) : attempt to apply non-function" the first time. It is related to this issue with terra https://github.com/rspatial/terra/issues/30. It can be ignored everything runs fine. Also rasters should be there on cloned project.

rescaled_benthic_list <- 
  
map(.x = forage_effort_km2_r_files, .f = \(this_file){
  
  fileName <- gsub("_0.5D_km2", "", gsub(pattern = "trawl_effort", replacement = "benthic_destruction_rescaled", tools::file_path_sans_ext(basename(this_file))))
  
  this_diet <- if_else(grepl("marine_diet", fileName), true = "marine_diet", false = "plant_diet")
  
  saveName <- sprintf(here("data/spatial/%s/%s.tif"),this_diet, fileName)
  
  if(!file.exists(saveName)){
    
    all_effort_values <- unlist(forage_effort_km2_r_list)
    
    this_rast <- rast(this_file)
    
    rescale_value <- quantile(all_effort_values, 0.9999, na.rm=TRUE)
    
    this_rescaled_rast <- 
      app(x = this_rast, fun = \(x){
        if_else(x<0, true = 0, false = if_else(x>rescale_value, true = 1, false = x/rescale_value))})
    
    
    writeRaster(x = this_rescaled_rast, filename = saveName, overwrite = TRUE)
    
    return(this_rescaled_rast)
  }
  
})

#check the rasters
plot(rast(rescaled_benthic_list))
```

The next step is understand the biomass removal component of disturbance. To do this we will bring in each forage fish catch scenario from each source and diet and adjust the biomass taken by the NPP and then rescale between 0-1.

```{r}

#Create catch rasters for all diets and sources

#split the embodied fish xy file by diet and source
catch_list <- fread(here("data/tidy_data/demand/embodied_fish_per_cell.csv")) |> 
  lazy_dt(immutable = FALSE) |> 
  group_by(diet, source_code, LonCentre, LatCentre) |> 
  summarise(catch = sum(adj_embodied_fish, na.rm=TRUE)) |> 
  as_tibble() |> 
  group_split(diet, source_code)
  

#create the rasters
map(catch_list, \(this_df){
  
  this_diet <- unique(this_df$diet)
  
  this_source <- unique(this_df$source_code)
  
  saveName <- sprintf(here("data/spatial/fisheries-catch/forage_fish_catch_%s_%s.tif"), this_diet, this_source)
  
  if(!file.exists(saveName)){
    
    this_xy <- this_df |> select(-c(diet, source_code))
  
    this_r <- rast(this_xy, type = "xyz", crs = crs(rast(res=0.5))) |> extend(ext(rast(res=0.5)))
    
    writeRaster(x = this_r, filename = saveName, overwrite=TRUE)
    
  }
})
  
  
#import npp raster
npp <- rast(here("data/spatial/00-net-primary-productivity/annal_mean_npp_2015_gf_wgs.tif"))

#import the catch rasters
catch_r_list_int <- list.files(here("data/spatial/fisheries-catch"), full.names = TRUE)
catch_r_list <- catch_r_list_int[!grepl("ea_npp", catch_r_list_int)]


#Convert to equal area, adjust by npp and save
map(catch_r_list, \(this_file){
  
  saveName <- gsub(pattern = ".tif", replacement = "_ea_npp.tif", basename(this_file))
  
  if(!file.exists(saveName)){
    
  this_r <- rast(this_file)
    
  this_ea_r <- this_r/cellSize(this_r, unit = "km")
  
  this_ea_npp_r <- this_ea_r/npp
  
  writeRaster(this_ea_npp_r, filename = saveName, overwrite=TRUE)
  
  }

})

#bring the npp adjusted catch back in and rescale it
adjusted_catch_r_list <- list.files(here("data/spatial/fisheries-catch"), pattern = "ea_npp", full.names = TRUE) |> map(rast)


#rescale and save rescaled rasters for biomass removal
rescaled_biomass_list <- 
  
  map(adjusted_catch_r_list, \(this_r){
  
  this_diet <- if_else(grepl("marine_diet", sources(this_r)), true = "marine_diet", false = "plant_diet")
  
  fileName <- tools::file_path_sans_ext(basename(gsub(pattern = "_ea_npp", replacement = "", sources(this_r))))
  
  this_source <- substr(fileName, nchar(fileName)-3+1, nchar(fileName))
  
  saveName <- sprintf(here("data/spatial/%s/forage_biomass_removal_rescaled_%s_%s.tif"), this_diet, this_diet, this_source)
  
  if(file.exists(saveName)){
    
    all_catch_values <- unlist(map(adjusted_catch_r_list, \(this_r){return(c(terra::values(this_r, na.rm=TRUE)))}))

    rescale_value <- quantile(x = all_catch_values, 0.9999)
    
    this_rescaled_rast <- 
      app(x = this_r, fun = \(x){
        if_else(x<0, true = 0, false = 
                  if_else(x>rescale_value, true = 1, false = x/rescale_value))})
    
    writeRaster(x = this_rescaled_rast, filename = saveName, overwrite = TRUE)
    
    return(this_rescaled_rast)
  }
  
})
  
plot(rast(rescaled_biomass_list))
```

Finally, combine benthic disturbance with biomass removal to get a joint pressure metric.

```{r}

#marine-diet
benthic_destruction_md <- list.files(here("data/spatial/marine_diet"), pattern = "benthic", full=TRUE) |> map(rast)
biomass_removal_md <- list.files(here("data/spatial/marine_diet"), pattern = "biomass", full=TRUE) |> map(rast)

combined_raster_list <- 
  map2(.x = benthic_destruction_md, .y = biomass_removal_md, .f = \(this_benthic_file, this_biomass_file){
  
  this_source <- substr(tools::file_path_sans_ext(this_benthic_file), nchar(tools::file_path_sans_ext(this_benthic_file))-2, nchar(tools::file_path_sans_ext(this_benthic_file)))  
    
  this_benthic_r <- rast(this_benthic_file)
  this_biomass_r <- rast(this_biomass_file)
  
  this_combined_r <- (this_benthic_r+this_biomass_r)/2
  
  writeRaster(x = this_combined_r, filename = sprintf(here("data/spatial/marine_diet/pressures/forage_fish_disturbance_pressure_marine_diet_%s.tif"), this_source), overwrite=TRUE)
  
  return(this_combined_r)
  
})



#plant-diet 
benthic_destruction_pd <- list.files(here("data/spatial/plant_diet"), pattern = "benthic", full=TRUE)
biomass_removal_pd <- list.files(here("data/spatial/plant_diet"), pattern = "biomass", full=TRUE) 



combined_raster_list2 <- 
  map2(.x = benthic_destruction_pd, .y = biomass_removal_pd, .f = \(this_benthic_file, this_biomass_file){
  
  this_source <- substr(tools::file_path_sans_ext(this_benthic_file), nchar(tools::file_path_sans_ext(this_benthic_file))-2, nchar(tools::file_path_sans_ext(this_benthic_file)))  
      
    
  this_benthic_r <- rast(this_benthic_file)
  this_biomass_r <- rast(this_biomass_file)
  
  this_combined_r <- (this_benthic_r+this_biomass_r)/2
  
 writeRaster(x = this_combined_r, filename = sprintf(here("data/spatial/plant_diet/pressures/forage_fish_disturbance_pressure_plant_diet_%s.tif"), this_source), overwrite=TRUE)
  
  
  return(this_combined_r)
  
})


#quick check
plot(rast(combined_raster_list))
plot(rast(combined_raster_list2))
```


