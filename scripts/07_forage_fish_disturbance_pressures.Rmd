---
title: "Spatial Allocation of Forage fish demand from each diet and source"
output: html_document
---

The disturbance metric established in Halpern et al is composed of two elements:

- Benthic destruction - hours of fishing effort from bottom trawlers and dredgers to catch forage fish species
- Biomass removal i.e. the appropriated portion net primary productivity
  
```{r}

library(tidyverse)
library(here)
library(terra)
library(sf)
library(data.table)
library(dtplyr)
library(future)
library(furrr)

source(here("src/directories.R"))
source(here("src/spatial.R"))

```

To understand the benthic component of disturbance, we need to know if there are any destrcutive fishing gears associated withe forage fish catch. 

Here we also join the gear classification data from Halpern et al of destructive or non destructive/ pelagic or demersal to the catch data which helps with the next step of isolating all trawling and dredging, and the trawling and dredging that forage fish represent.

```{r}

#create the list of gear relevant to the forage fish catch data

forage_gears <- readRDS(here("data/raw_data/fisheries/spatial_forage_catch_2017.rds")) |> 
  select(Gear, VBDesc) |> distinct()

write_csv(x = forage_gears, file = here("data/raw_data/fisheries/forage_gears.csv"))

#join the categories from Halpern et al to the gears relevant for forage fish only

gears_to_cat <- read_csv(here("data/raw_data/fisheries/gears_to_cat.csv"))


forage_gear_cats <- forage_gears |> left_join(gears_to_cat, by = c("Gear", "VBDesc"))

#assign categories to existing classification of pelagic or demersal
forage_catch_w_cats <- 
  readRDS(here("data/raw_data/fisheries/spatial_forage_catch_2017.rds")) |> 
  left_join(forage_gear_cats, by = c("Gear", "VBDesc")) |> 
  mutate(type = case_when(grepl("pelagic|krill", Descript) ~ "pelagic",
                          grepl("benthopelagic|demersal", Descript) ~ "demersal"))
  

saveRDS(object = forage_catch_w_cats, file = here("data/raw_data/fisheries/spatial_forage_catch_2017_w_cats.rds"))

#some checks throughout
unique(forage_catch_w_cats$Descript)
forage_catch_w_cats |> filter(Descript == "krill") |> pull(VBDesc) |> unique()
forage_catch_w_cats |> filter(is.na(type))# no NA values
forage_catch_w_cats |> filter(is.na(bycatch)) #no na values
```


We  have effort rasters for all fishing for destructive gears (trawling and dredge) but we need to know how much of that forage fish represent in each cell for each demand scenario in each diet.

To do this we need to know what proportion of all trawling (the resolution in the GW dataset) is bottom trawling for forage fish species represented in each diet and sourcing scenario:

- Create catch rasters for all trawling 
- Create rasters for all bottom trawling and dredging for forage fish species.
- Multiply the proportion of of bottom trawling or dredging from forage fish species

So first lets create catch rasters for all trawling.

```{r}
total_catch <- fread(file.path(watson_dir, "v5.0/watson_2017_fisheries_catch.csv"))

gears_to_cat <- read_csv(here("data/raw_data/fisheries/gears_to_cat.csv")) |> mutate(bycatch = if_else(is.na(bycatch), true = "low", false = bycatch))

#join the gear categories to the fisheries catch to isolate trawling

total_catch_w_cat <- total_catch |> 
  lazy_dt(immutable = FALSE) |> 
  left_join(gears_to_cat, by = c("Gear", "VBDesc"))  |>  
  mutate(type = case_when(grepl("pelagic|krill", Descript) ~ "pelagic",
                          grepl("benthopelagic|demersal", Descript) ~ "demersal")) |> 
  as.data.table()

#this could be useful so save for later  
fwrite(x = total_catch_w_cat, file =  file.path(watson_dir, "v5.0/watson_2017_fisheries_catch_w_cat.csv"))

#Now create some rasters of the proportion of trawling that is bottom trawling and non-hand dredging to allow us to get a raster of bottom trawling in effort

#First we need to know what the types of trawl and dredge are in teh fisheries data
trawl_types <- unique(total_catch_w_cat$VBDesc)[grep("trawl", unique(total_catch_w_cat$VBDesc))]
dredge_types <- unique(total_catch_w_cat$VBDesc)[grep("dredg", unique(total_catch_w_cat$VBDesc))]


#isolate data for all fish trawling

all_trawl_fishing <- 
  total_catch |>
  lazy_dt(immutable = FALSE) |> 
  filter(VBDesc %in% trawl_types) |> 
  group_by(LonCentre, LatCentre) |> 
  summarise(total_catch = sum(ReportedNIND+ReportedIND+IUUIND+IUUNIND, na.rm = TRUE)) |> 
  drop_na(LonCentre, LatCentre) |> 
  as.data.frame()


all_trawl_r <- rast(all_trawl_fishing, type = "xyz", crs = "EPSG:4326")
writeRaster(x = all_trawl_r, filename = here("data/spatial/03-fisheries-effort/all_trawling_catch.tif"))

```

Next step is to understand  what proportion of all trawling the forage catch needed for each deamnd scenario represents so we can convert it into hours of effort for each diet/sourcing combination. So first we can prep the embodied forage fish demand per cell into raster form for the trawling component.

First we'll isolate which gears are destructive for forage fish.
```{r}
#create the list of gear relevant to the forage fish catch data

forage_gears <- fread(here("data/tidy_data/demand/embodied_fish_per_cell.csv")) |> 
  lazy_dt(immutable = FALSE) |> 
  select(Gear, VBDesc) |> 
  distinct() |> 
  as_tibble()

write_csv(x = forage_gears, file = here("data/raw_data/fisheries/forage_gears.csv"))

#join the categories from Halpern et al to the gears relevant for forage fish only

gears_to_cat <- read_csv(here("data/raw_data/fisheries/gears_to_cat.csv"))


#So for forage fish we are only interested "bottom trawls" as a destrcutive method
forage_gear_cats <- forage_gears |> left_join(gears_to_cat, by = c("Gear", "VBDesc"))


```

For pressures all we are interested is the bottom trawl component so now we isolate the embodied demand (catch) estimates and filter to just bottom trawls and sum catch per cell, and export the rasters.

```{r}

#create list of dataframe of trawling for forage fish by diet and sourcing
trawl_forage_catch_list <- fread(here("data/tidy_data/demand/embodied_fish_per_cell.csv")) |> 
  lazy_dt(immutable = FALSE) |> 
  filter(VBDesc == "bottom trawls") |> 
  as_tibble() |> 
  group_split(diet, source_code)

#summarise the data by cell and write to data folder

map(trawl_forage_catch_list, \(this_df){
  
  this_diet <- unique(this_df$diet)
  
  this_source <- unique(this_df$source_code)
  
  this_summary_df <- 
    this_df |> 
    group_by(LonCentre, LatCentre) |> 
    summarise(forage_catch = sum(adj_embodied_fish, na.rm=TRUE))
  
  
  this_rast <- rast(this_summary_df, type="xyz", crs="EPSG:4326")
  this_rast_resampled <- resample(this_rast, rast(res=0.5))
  plot(this_rast)
  
  writeRaster(x = this_rast_resampled, filename = sprintf(here("data/spatial/03-fisheries-effort/forage_trawl_catch_%s_%s.tif"), this_diet, this_source), overwrite=TRUE)
  
})

# now look at dredging - but there is no catch for dredging so we can disregard

trawl_forage_catch_list <- fread(here("data/tidy_data/demand/embodied_fish_per_cell.csv")) |> 
  lazy_dt(immutable = FALSE) |> 
  filter(VBDesc %in% dredge_types) |> 
  as_tibble()



```

Now we need to work out what proportion of all trawling each one of the trawling for forage fish catch rasters represents across diets and sources so we can create a proportional raster to multiply by effort.

```{r}
forage_catch_r_list <- list.files(path = here("data/spatial/03-fisheries-effort"), pattern = "forage_trawl_catch_", full.names = TRUE)


#calculate the proportion of all trawl catch is this diet scenario
map(.x = forage_catch_r_list, .f = \(this_file){
  
  message("processing ", tools::file_path_sans_ext(basename(this_file)))
  
  saveName <- paste0(tools::file_path_sans_ext(basename(this_file)), "_prop")
  
  this_r <- rast(this_file)
  
  all_trawL_r <- rast(here("data/spatial/03-fisheries-effort/all_trawling_catch.tif"))
  all_trawl_r <- extend(all_trawl_r, ext(rast(res=0.5)))
  
  
  this_stack_r <- c(this_r, all_trawl_r)
  
  lapp(x= this_stack_r, fun = \(x,y){x/y}, filename = sprintf(here("data/spatial/03-fisheries-effort/%s.tif"), saveName), overwrite=TRUE)
  
  
})


```

With proportions of all forage fish trawling now available for each diet and source, we can now resample the proportional rasters to the res and extent of the effort data and multiply them together to get hours of trawling for forage fish per diet and source.


```{r}
#proportional catch raster for forage fish trawling
prop_raster_files <- list.files(path = here("data/spatial/03-fisheries-effort"), pattern = "_prop.tif", full.names = TRUE)

# the total trawling effort
gfw_native_r <- rast(here("data/spatial/03-fisheries-effort/gfw_annual_effort_2017_trawlers.tif"))


#bring in the shapefile for cropping effort rasters by relevant source area
FAO_regions_shp <- read_sf("https://www.fao.org/fishery/geoserver/fifao/ows?service=WFS&request=GetFeature&version=1.0.0&typeName=fifao:FAO_AREAS_CWP_NOCOASTLINE&outputFormat=json") |> filter(F_LEVEL == "MAJOR") |> 
  mutate(F_AREA = as.numeric(F_AREA)) |> 
  mutate(source_code = case_when(NAME_EN == "Atlantic, Northeast" ~ "NAT",
                                 NAME_EN %in% c("Pacific, Northeast", "Pacific, Eastern Central", "Pacific, Southeast") ~ "EPC",
                                                      TRUE ~ "OTH")) 
this_file <- prop_raster_files[[4]]

map(.x = prop_raster_files, .f = \(this_file){
  
  fileName <- gsub(pattern = "catch", replacement = "effort", tools::file_path_sans_ext(basename(this_file)))
  fileName <- gsub(pattern = "_prop", replacement = "", fileName)
  
  saveName <- sprintf(here("data/spatial/03-fisheries-effort/%s.tif"), fileName)
  
  if(!file.exists(saveName)){
    
  this_source <- substr(fileName, nchar(fileName)-3+1, nchar(fileName) )
  
  #get the FAO regions shp for masking the raster to the relevant ones
  this_shp_extent <- FAO_regions_shp |> filter(source_code ==this_source)
  
  message("processing ", tools::file_path_sans_ext(basename(this_file)))
  
  this_rast <- rast(this_file)
  
  #add average value where 
  avg_trawl_correction <- terra::global(this_rast, na.rm = TRUE) |> pull(mean)
  
  this_rast[is.na(this_rast)] <- avg_trawl_correction
  
  this_cropped_rast <- terra::mask(this_rast, vect(this_shp_extent))
   
  this_resampled_rast <- resample(this_cropped_rast, gfw_native_r)
  
  this_stack_r <- c(this_resampled_rast, gfw_native_r) 
  
  this_effort_raster <- lapp(this_stack_r, fun = \(x, y){x * y}, filename = saveName , overwrite=TRUE)
    
  }
  
  
  
})
```


```{r}
forage_catch <- readRDS(file = here("data/raw_data/fisheries/spatial_forage_catch_2017_w_cats.rds"))

forage_bottom_trawl_fishing <- 
  forage_catch |> 
  as.data.table() |> 
  lazy_dt(immutable = FALSE) |> 
  filter(VBDesc == "bottom trawls") |> 
  group_by(LonCentre, LatCentre) |> 
  summarise(forage_catch = sum(ReportedNIND+ReportedIND+IUUIND+IUUNIND, na.rm = TRUE)) |> 
  drop_na(LonCentre, LatCentre) |> 
  as.data.frame()
  
#combine the two so they have the same extents and just plot NA when data is irrelevant for a cell
combine_trawl_df <- all_trawl_fishing |> full_join(forage_bottom_trawl_fishing)

#generate rasters for all trawling and bottom trawling for forage fish
all_trawl_r <- rast(combine_trawl_df |> select(-forage_catch), type="xyz", crs = "EPSG:4326")
forage_bottom_trawl_r <- rast(combine_trawl_df |> select(-total_catch), type="xyz", crs = "EPSG:4326")

#plot the rasters - seem fine
plot(all_trawl_r)  
plot(forage_bottom_trawl_r) 

prop_forage_bottom_trawl_r <-  forage_bottom_trawl_r/all_trawl_r
plot(prop_forage_bottom_trawl_r)

writeRaster(x = prop_forage_bottom_trawl_r, filename = here("data/spatial/03-fisheries-effort/prop_bottom_trawling_forage.tif"))


#now so the same for dredge fishing for forage fish vs all fish

all_dredge_fishing <- 
  total_catch |>
  lazy_dt(immutable = FALSE) |> 
  filter(VBDesc == "dredges") |> 
  group_by(LonCentre, LatCentre) |> 
  summarise(total_catch = sum(ReportedNIND+ReportedIND+IUUIND+IUUNIND, na.rm = TRUE)) |> 
  drop_na(LonCentre, LatCentre) |> 
  as.data.frame()

#there is no dredging which catches forage fish so we don't need an effort adjustment raster for dredge. We just don't include.
forage_dredge_fishing <- 
  forage_catch |> 
  as.data.table() |> 
  lazy_dt(immutable = FALSE) |> 
  filter(VBDesc %in% dredge_types) |> 
  group_by(LonCentre, LatCentre) |> 
  summarise(forage_catch = sum(ReportedNIND+ReportedIND+IUUIND+IUUNIND, na.rm = TRUE)) |> 
  drop_na(LonCentre, LatCentre) |> 
  as.data.frame()



```
Now we adjust the trawler effort data using the proportional raster for the amount coming from bottom trawling and forage fish. 

```{r}

#global half degree raster
base_raster <- rast(res = 0.5)

#bring in effort data in native resolution (0.01 degree)
gfw_native_r <- rast(here("data/spatial/03-fisheries-effort/gfw_annual_effort_2017_trawlers.tif"))
plot(gfw_native_r)
#gfw_aggregated_df <- terra::as.data.frame(gfw_native_r, xy= TRUE, row.names = FALSE)

#bring in proportional trawl data from catch
prop_forage_bottom_trawl_r <- rast(here("data/spatial/03-fisheries-effort/prop_bottom_trawling_forage.tif"))
avg_trawl_correction <- terra::global(prop_forage_bottom_trawl_r, na.rm = TRUE) |> pull(mean)
prop_forage_bottom_trawl_r[is.na(prop_forage_bottom_trawl_r)] <- avg_trawl_correction 
plot(prop_forage_bottom_trawl_r)

#convert the forage fish tank trawling proportions to the resolution of the effort to combine these layers (as effort patterns are likely closer to reality than catch given remote sensing than otehr way round)
resample(prop_forage_bottom_trawl_r, gfw_native_r, method = "near",  filename = here("data/spatial/03-fisheries-effort/resampled_prop_forage_bottom_trawl.tif"), overwrite = TRUE)

#bring in the resampled catch proportion for forage fish
resampled_forage_bottom_trawl_r <- rast(here("data/spatial/03-fisheries-effort/resampled_prop_forage_bottom_trawl.tif"))

#stack the resampled raster withh all trawl effort
effort_forage_prop_stack <- c(resampled_forage_bottom_trawl_r, gfw_native_r)

#mutliply the rasters together and save
lapp(effort_forage_prop_stack, fun =  \(x, y){ x*y}, filename = here("data/spatial/03-fisheries-effort/_estimated_forage_bottom_trawl_effort.tif"))

#check the new forage fish trawling hours
forage_effort <- rast(here("data/spatial/03-fisheries-effort/_estimated_forage_bottom_trawl_effort.tif"))
plot(log10(forage_effort+1))

```
Now we need to bring in the effort raster and aggregate 

```{r}

forage_trawl_effort_r <- rast(here("data/spatial/03-fisheries-effort/_estimated_forage_bottom_trawl_effort.tif"))
new_extent <- ext(-180.005, 179.995, -89.995, 90.005)
extended_forage_trawl_effort_r <- terra::extend(forage_trawl_effort_r, new_extent)

agg_forage_trawl_effort_r <- terra::aggregate(extended_forage_trawl_effort_r, fact = 50, fun = sum, na.rm = TRUE)
plot(agg_forage_trawl_effort_r)

#check values still match
global(extended_forage_trawl_effort_r, fun = "sum", na.rm=TRUE)
global(agg_forage_trawl_effort_r, fun = "sum", na.rm = TRUE)

adjustment_r <- rast(res=0.5, vals = 0)

adjustment_stack <- c( agg_forage_trawl_effort_r)

lapp(adjustment_stack, fun = \(x,y){x+y}, filename = here("data/spatial/03-fisheries-effort/estimated_forage_bottom_trawl_effort_0.5D_recentred.tif"))

#check new raster
recentred_forage_trawl_effort_r <- rast(here("data/spatial/03-fisheries-effort/estimated_forage_bottom_trawl_effort_0.5D_recentred.tif"))
plot(recentred_forage_trawl_effort_r)

plot(cellSize(recentred_forage_trawl_effort_r, unit="km"))

forage_trawl_effort_km2 <- recentred_forage_trawl_effort_r/cellSize(recentred_forage_trawl_effort_r, unit="km")
plot(forage_trawl_effort_km2)

rescale_value <-  quantile(values(forage_trawl_effort_km2), 0.9999, na.rm=TRUE)


rescaled_forage_trawl_effort_km2_r <- forage_trawl_effort_km2 |> 
  app(fun = \(x){
  if_else(x<0, true = 0, false = 
            if_else(x>rescale_value, true = 1, false = x/rescale_value))})

plot(rescaled_forage_trawl_effort_km2_r)

```

```{r}

```

