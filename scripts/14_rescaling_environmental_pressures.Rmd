---
title: "Rescaling environmental pressures"
author: "Rich Cottrell"
date: "30/06/2022"
output: html_document
---

This file is used to rescale all rasters' values for each pressure so that values among feeds may be compared.

```{r}

library(tidyverse)
library(terra)
library(here)
library(parallel)
library(doParallel)
library(foreach)
library(future)
library(furrr)

select <- dplyr::select
values <- terra::values

source(here("src/fxns.R"))
```

Create equal area projection for rescaling
```{r}

gall_peters <- "+proj=cea +lon_0=0 +x_0=0 +y_0=0 +lat_ts=45 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"
#raster template 
base_rast <- rast(res=0.5)
ext(base_rast) <- c(-180, 180, -90, 90)

eq_area_rast <- project(base_rast, gall_peters, res=10000) # this is down scaling the resolution so creates issues when changing square km values
# values(eq_area_rast) <- 1:ncell(eq_area_rast)

#plot(eq_area_rast)
#cellSize(eq_area_rast, unit="km")

```



## Disturbance

Bring in  forage fish and crop layers for disturbance for both diets. Reproject onto the equal area gall-peters projection and calcute the sum of disturbance for each diet.

```{r}

#ID files for disturbance for marine and plant diets
marine_diet_disturbance <- list.files(here("data/spatial/marine_diet/int"), pattern = "disturbance_km2", full.names = TRUE)
marine_diet_disturbance <- marine_diet_disturbance[!grepl("forage_fish|_gp", marine_diet_disturbance) & grepl("allocation", marine_diet_disturbance)]

#REPROJECT PER KM2 DATA TO GALL PETERS EQUAL AREA

this_file <- marine_diet_disturbance[[1]]

#marine diets
md_reprojected_rasters <- 
  
  map(.x = marine_diet_disturbance, .f = \(this_file){
    
    base <- tools::file_path_sans_ext(basename(this_file))  
    
    this_country <- if_else(grepl("EPC|NAT|OTH", base), true = str_extract(base, "EPC|NAT|OTH"), false = str_sub(base, start = nchar(base)-2, end = nchar(base)))
    
    this_allocation_method <- str_extract(base, "ge_allocation|mass_allocation")
    
    this_ingredient <- str_extract(base, "[^_]+")
    
    saveName <- sprintf(here("data/spatial/marine_diet/int/%s_disturbance_gp_%s_%s.tif"), this_ingredient, this_allocation_method, this_country)
    
    if(!file.exists(saveName)){
      
      message("processing ", basename(saveName))
      
      this_rast <- rast(this_file)
      
      if(!grepl("fishmeal|fish oil", saveName)){
        
        # normalise by cell size for crops to get proportion of cell before reprojecting otherwise reprojection screws up to be larger than cell size. 
        
        this_prop_r <- this_rast/cellSize(this_rast, unit = "km")
        
        this_reprojected_rast <-  project(this_prop_r, gall_peters)
        
        this_adj_reprojected_rast <- this_reprojected_rast*cellSize(this_reprojected_rast, unit = "km")
        names(this_adj_reprojected_rast) <- "km2"
        
        writeRaster(x = this_adj_reprojected_rast, filename = saveName, overwrite = TRUE)
        
        return(this_adj_reprojected_rast)
        
      } else {
        
        writeRaster(this_rast, filename = saveName, overwrite = TRUE)
        
        return(this_rast)
         
       }
      
    }
  })




#plant diets
plant_diet_disturbance <- list.files(here("data/spatial/plant_diet/int"), pattern = "disturbance_km2", full.names = TRUE)
plant_diet_disturbance <- plant_diet_disturbance[!grepl("forage_fish|_gp", plant_diet_disturbance) & grepl("allocation", plant_diet_disturbance)]


this_file <- plant_diet_disturbance[[1]]

pd_reprojected_rasters <- 
  
  map(.x = plant_diet_disturbance, .f = \(this_file){
    
    base <- tools::file_path_sans_ext(basename(this_file))  
    
    this_country <- if_else(grepl("EPC|NAT|OTH", base), true = str_extract(base, "EPC|NAT|OTH"), false = str_sub(base, start = nchar(base)-2, end = nchar(base)))
    
    this_allocation_method <- str_extract(base, "ge_allocation|mass_allocation")
    
    this_ingredient <- str_extract(base, "[^_]+")
    
    saveName <- sprintf(here("data/spatial/plant_diet/int/%s_disturbance_gp_%s_%s.tif"), this_ingredient, this_allocation_method, this_country)
    
    if(!file.exists(saveName)){
      
      message("processing ", basename(saveName))
      
      this_rast <- rast(this_file)
      
      if(!grepl("fishmeal|fish oil", saveName)){
        
        # normalise by cell size for crops to get proportion of cell before reprojecting otherwise reprojection screws up to be larger than cell size. 
        
        this_prop_r <- this_rast/cellSize(this_rast, unit = "km")
        
        this_reprojected_rast <-  project(this_prop_r, gall_peters)
        
        this_adj_reprojected_rast <- this_reprojected_rast*cellSize(this_reprojected_rast, unit = "km")
        names(this_adj_reprojected_rast) <- "km2"
        
        writeRaster(x = this_adj_reprojected_rast, filename = saveName, overwrite = TRUE)
        
        return(this_adj_reprojected_rast)
        
      } else {
        
        writeRaster(this_rast, filename = saveName, overwrite = TRUE)
        
        return(this_rast)
         
      }
    }
  })


#NOW FIND THE MAXIMUM TOTAL SCORES FOR DISTURBANCE INCLUDING ALL INGREDIENTS FOR EACH DIET AND ALLOCATION METHOD - THIS WILL BE USED TO GET A GIVEN CELLS' PROPORTIONAL CONTRIBUTION

#First need to find maximum scores each ingredient (i.e. which origin yields the greatest)

md_reprojected_rasters <- list.files(path = here("data/spatial/marine_diet/int"), pattern = "disturbance_gp", full=TRUE)

md_ingredients_list <- 
  readRDS(here("data/tidy_data/demand/total_ingredient_demand.rds")) |> filter(diet=="marine_diet" & total_ingredient_demand>0) |> mutate(ingredients = sub(pattern="-wild", replacement="", ingredients)) |> arrange(ingredients) |> group_split(ingredients)

this_df <- md_ingredients_list[[1]]

maximum_disturbance_scores_md <-  
  
  map_df(md_ingredients_list, .f = \(this_df){
  
  this_ingredient <- paste0(this_df$ingredients |> unique(),"_")
  
  these_ingredient_rasters_ge <- md_reprojected_rasters[grepl(this_ingredient, md_reprojected_rasters) & grepl("ge_allocation", md_reprojected_rasters)]
  
  these_ingredient_rasters_mass <- md_reprojected_rasters[grepl(this_ingredient, md_reprojected_rasters) & grepl("mass_allocation", md_reprojected_rasters)]
  
  max_disturbance_ge <- these_ingredient_rasters_ge |> map(rast) |> map(no_na_values) |> map(sum) |> unlist() |> max()
  max_disturbance_mass <- these_ingredient_rasters_mass |> map(rast) |> map(no_na_values) |> map(sum) |> unlist() |> max()
  
  this_adj_df <- bind_cols(this_df, max_disturbance_ge = max_disturbance_ge, max_disturbance_mass= max_disturbance_mass)
  
  
})

#get maximum disturbance scores for each allocation method
max_md_disturbance_ge <- maximum_disturbance_scores_md |> pull(max_disturbance_ge) |> sum()
max_md_disturbance_mass <- maximum_disturbance_scores_md |> pull(max_disturbance_mass) |> sum()



pd_reprojected_rasters <- list.files(path = here("data/spatial/plant_diet/int"), pattern = "disturbance_gp", full=TRUE)


pd_ingredients_list <- 
  readRDS(here("data/tidy_data/demand/total_ingredient_demand.rds")) |> filter(diet=="plant_diet" & total_ingredient_demand>0) |> mutate(ingredients = sub(pattern="-wild", replacement="", ingredients)) |> arrange(ingredients) |> group_split(ingredients)

this_df <- md_ingredients_list[[1]]

maximum_disturbance_scores_pd <-  
  
  map_df(pd_ingredients_list, .f = \(this_df){
  
  this_ingredient <- paste0(this_df$ingredients |> unique(),"_")
  
  these_ingredient_rasters_ge <- pd_reprojected_rasters[grepl(this_ingredient, pd_reprojected_rasters) & grepl("ge_allocation", pd_reprojected_rasters)]
  
  these_ingredient_rasters_mass <- pd_reprojected_rasters[grepl(this_ingredient, pd_reprojected_rasters) & grepl("mass_allocation", pd_reprojected_rasters)]
  
  max_disturbance_ge <- these_ingredient_rasters_ge |> map(rast) |> map(no_na_values) |> map(sum) |> unlist() |> max()
  max_disturbance_mass <- these_ingredient_rasters_mass |> map(rast) |> map(no_na_values) |> map(sum) |> unlist() |> max()
  
  this_adj_df <- bind_cols(this_df, max_disturbance_ge = max_disturbance_ge, max_disturbance_mass= max_disturbance_mass)
  
  
})

#get maximum disturbance scores for each allocation method
max_pd_disturbance_ge <- maximum_disturbance_scores_pd |> pull(max_disturbance_ge) |> sum()
max_pd_disturbance_mass <- maximum_disturbance_scores_pd |> pull(max_disturbance_mass) |> sum()

```













#which diet has the highest disturbance values
marine_disturbance_vals_ge <- md_reprojected_rasters[grepl("ge_allocation", md_reprojected_rasters)] |> map(rast) |> map(no_na_values) |> unlist()
plant_disturbance_vals_ge <-  pd_reprojected_rasters[grepl("ge_allocation", pd_reprojected_rasters)] |> map(rast) |> map(no_na_values) |> unlist()

marine_disturbance_vals_mass <- md_reprojected_rasters[grepl("mass_allocation", md_reprojected_rasters)] |> map(rast) |> map(no_na_values) |> unlist()
plant_disturbance_vals_mass <-  pd_reprojected_rasters[grepl("mass_allocation", pd_reprojected_rasters)] |> map(rast) |> map(no_na_values) |> unlist()


marine_diet_total_ge <- sum(marine_disturbance_vals_ge, na.rm = TRUE)
marine_diet_total_mass <- sum(marine_disturbance_vals_mass, na.rm=TRUE)

plant_diet_total_ge <- sum(plant_disturbance_vals_ge, na.rm = TRUE)
plant_diet_total_mass <- sum(plant_disturbance_vals_mass, na.rm=TRUE)



#check marine is appearing more intense (given forage fish disturbance values are much higher)
summary(marine_disturbance_vals_ge)
summary(plant_disturbance_vals_ge)

summary(marine_disturbance_vals_mass)
summary(plant_disturbance_vals_mass)

all_disturbance_vals_ge <- c(marine_disturbance_vals_ge, plant_disturbance_vals_ge) |> unlist()
all_disturbance_vals_mass <- c(marine_disturbance_vals_mass, plant_disturbance_vals_mass) |> unlist()

disturbance_energy_skewness <-  3*(mean(all_disturbance_vals_ge)-median(all_disturbance_vals_ge))/sd(all_disturbance_vals_ge)
disturbance_mass_skewness <- 3*(mean(all_disturbance_vals_mass)-median(all_disturbance_vals_mass))/sd(all_disturbance_vals_mass)

#determine the quantile for rescaling - given the extreme skew - 99.9% seems 
hist((all_disturbance_vals_ge), main = "", xlab = "Disturbance values") |> 
abline(v = quantile(all_disturbance_vals_ge, 0.999), lty=2)

hist((all_disturbance_vals_mass), main = "", xlab = "Disturbance values") |> 
abline(v = quantile(all_disturbance_vals_mass, 0.999), lty=2)

disturbance_rescale_val_ge <- quantile(all_disturbance_vals_ge, 0.999) |> as.numeric()
disturbance_rescale_val_mass <- quantile(all_disturbance_vals_mass, 0.999) |> as.numeric()


#rescale all rasters by the 99.9th percentile

#marine diets

this_file <- md_reprojected_rasters[[1]]


rescaled_marine_disturbance_rasters <- 
  
  map(.x= md_reprojected_rasters, .f = \(this_file){
    
    this_rast <- rast(this_file)
    
    this_basename <- str_replace(basename(this_file), pattern = "_km2_gp", replacement = "")
    
    this_allocation_method <- str_extract(this_file, "ge_allocation|mass_allocation")
    
    saveName <- sprintf(here("data/spatial/marine_diet/pressures/%s"), this_basename)
    
    if(file.exists(saveName)){
      
      message("Processing ", "'", this_basename, "'") 
      
      if(this_allocation_method=="ge_allocation"){
        
        this_rescaled_rast <-  app(x = this_rast, fun = \(x){
                                        if_else(x<0, true = 0, false = if_else(x>disturbance_rescale_val_ge, true = 1, false = x/disturbance_rescale_val_ge))})
        
        names(this_rescaled_rast) <- tools::file_path_sans_ext(this_basename)
      
        writeRaster(x = this_rescaled_rast, filename = saveName, overwrite=TRUE)
      
        return(this_rescaled_rast)
        
        
      } else { 
        
        this_rescaled_rast <- app(x = this_rast, fun = \(x){
                                        if_else(x<0, true = 0, false = if_else(x>disturbance_rescale_val_mass, true = 1, false = x/disturbance_rescale_val_mass))})
        
        names(this_rescaled_rast) <- tools::file_path_sans_ext(this_basename)
      
        writeRaster(x = this_rescaled_rast, filename = saveName, overwrite=TRUE)
      
        return(this_rescaled_rast)
        
        
        
        }
    }
  })


#plant diets

rescaled_plant_disturbance_rasters <- 
  
  map(.x= pd_reprojected_rasters, .f = \(this_file){
  
  this_rast <- rast(this_file)
  
  this_basename <- str_replace(basename(this_file), pattern = "_km2_gp", replacement = "")
  
  this_allocation_method <- str_extract(this_file, "ge_allocation|mass_allocation")
  
  saveName <- sprintf(here("data/spatial/plant_diet/pressures/%s"), this_basename)
  
  if(!file.exists(saveName)){
    
   message("Processing ", "'", this_basename, "'")
    if(this_allocation_method=="ge_allocation"){
        
        this_rescaled_rast <-  app(x = this_rast, fun = \(x){
                                        if_else(x<0, true = 0, false = if_else(x>disturbance_rescale_val_ge, true = 1, false = x/disturbance_rescale_val_ge))})
        
        names(this_rescaled_rast) <- tools::file_path_sans_ext(this_basename)
      
        writeRaster(x = this_rescaled_rast, filename = saveName, overwrite=TRUE)
      
        return(this_rescaled_rast)
        
        
      } else { 
        
        this_rescaled_rast <- app(x = this_rast, fun = \(x){
                                        if_else(x<0, true = 0, false = if_else(x>disturbance_rescale_val_mass, true = 1, false = x/disturbance_rescale_val_mass))})
        
        names(this_rescaled_rast) <- tools::file_path_sans_ext(this_basename)
      
        writeRaster(x = this_rescaled_rast, filename = saveName, overwrite=TRUE)
      
        return(this_rescaled_rast)
        
        }
  }
})


# compare scales on rescaled rasters

plot(rast(rescaled_marine_disturbance_rasters))
plot(rast(rescaled_plant_disturbance_rasters))

```

# Greenhouse gas pressures

```{r}

marine_diet_ghg <- list.files(here("data/spatial/marine_diet/int"), pattern = "ghg", full.names = TRUE)
marine_diet_ghg <- marine_diet_ghg[!grepl("forage_fish|_gp", marine_diet_ghg)]

plant_diet_ghg <- list.files(here("data/spatial/plant_diet/int"), pattern = "ghg", full.names = TRUE)
plant_diet_ghg <- plant_diet_ghg[!grepl("forage_fish|_gp|linseed oil_ghg_km2_GBR|linseed oil_ghg_km2_CHN", plant_diet_ghg)]

# marine_ghg_remove <- marine_diet_ghg[!grepl("allocation", marine_diet_ghg)]
# plant_ghg_remove <- plant_diet_ghg[!grepl("allocation", plant_diet_ghg)]

#REPROJECT PER KM2 DATA TO GALL PETERS EQUAL AREA FOR TOTAL PRESSURES

this_file <- marine_diet_ghg[[1]]


# Marine diets


map(.x = marine_diet_ghg, .f =  \(this_file){
    
    base <- tools::file_path_sans_ext(basename(this_file))  
    
    this_country <- if_else(grepl("EPC|NAT|OTH", base), true = str_extract(base, "EPC|NAT|OTH"), false = str_sub(base, start = nchar(base)-2, end = nchar(base)))
    
    this_allocation_method <- str_extract(base, "ge_allocation|mass_allocation")
    
    this_ingredient <- str_extract(base, "[^_]+")
    
    saveName <- sprintf(here("data/spatial/marine_diet/int/%s_ghg_gp_%s_%s.tif"), this_ingredient, this_allocation_method, this_country)
    
    if(!file.exists(saveName)){
      
      message("Processing ", basename(saveName))
      
      this_rast <- rast(this_file)
      
      this_reprojected_rast <- project(this_rast, eq_area_rast)
      
      this_adj_reproj_rast <- this_reprojected_rast*cellSize(this_reprojected_rast, unit="km") #multiply up the footprints from per km2 to total based on cellsize
      names(this_adj_reproj_rast) <- "kgCO2eq"

      writeRaster(x = this_adj_reproj_rast, filename = saveName, overwrite = TRUE)
      
      return(this_adj_reproj_rast)
    }
})


#Plant diets

this_file <- plant_diet_ghg[[1]]

  
map(.x = plant_diet_ghg, .f = \(this_file){
    
    base <- tools::file_path_sans_ext(basename(this_file))  
    
    this_country <- if_else(grepl("EPC|NAT|OTH", base), true = str_extract(base, "EPC|NAT|OTH"), false = str_sub(base, start = nchar(base)-2, end = nchar(base)))
    
    this_allocation_method <- str_extract(base, "ge_allocation|mass_allocation")
    
    this_ingredient <- str_extract(base, "[^_]+")
    
    saveName <- sprintf(here("data/spatial/plant_diet/int/%s_ghg_gp_%s_%s.tif"), this_ingredient, this_allocation_method, this_country)
    
    if(!file.exists(saveName)){
      
      message("processing ", basename(saveName))
      
      this_rast <- rast(this_file)
      
      this_reprojected_rast <- project(this_rast, gall_peters)
      
      this_adj_reproj_rast <- this_reprojected_rast*cellSize(this_reprojected_rast, unit="km") #multiply up the footprints from per km2 to total based on 100km2
      
      names(this_adj_reproj_rast) <- "kgCO2eq"
      
      writeRaster(x = this_adj_reproj_rast, filename = saveName, overwrite = TRUE)
      
      return(this_adj_reproj_rast)
    }
  })
  





#RESCALE THE TOTAL GHG DATA
  
md_reprojected_rasters_ghg <- list.files(path = here("data/spatial/marine_diet/int"), pattern = "ghg_gp", full=TRUE)
pd_reprojected_rasters_ghg <- list.files(path = here("data/spatial/plant_diet/int"), pattern = "ghg_gp", full=TRUE)

#get the raster values from files
marine_ghg_vals_ge <- md_reprojected_rasters_ghg[grepl("ge_allocation", md_reprojected_rasters_ghg)] |> map(rast) |> map(no_na_values) |> unlist()
plant_ghg_vals_ge <- pd_reprojected_rasters_ghg[grepl("ge_allocation", pd_reprojected_rasters_ghg)] |> map(rast) |> map(no_na_values) |> unlist()

marine_ghg_vals_mass <- md_reprojected_rasters_ghg[grepl("mass_allocation", md_reprojected_rasters_ghg)] |> map(rast) |> map(no_na_values) |> unlist()
plant_ghg_vals_mass <- pd_reprojected_rasters_ghg[grepl("mass_allocation", pd_reprojected_rasters_ghg)] |> map(rast) |> map(no_na_values) |> unlist()

#compare marine and plant ghgs
summary(marine_ghg_vals_ge)
summary(plant_ghg_vals_ge)

summary(marine_ghg_vals_mass)
summary(plant_ghg_vals_mass)

all_ghg_vals_ge <- c(marine_ghg_vals_ge, plant_ghg_vals_ge)
all_ghg_vals_mass <- c(marine_ghg_vals_mass, plant_ghg_vals_mass)

#explore a reasonable rescale value
hist(all_ghg_vals_ge, main = "", xlab = "GHG values") |> 
abline(v=quantile(all_ghg_vals_ge, 0.999), lty = 2)

hist(all_ghg_vals_mass, main = "", xlab = "GHG values") |> 
abline(v=quantile(all_ghg_vals_mass, 0.999), lty = 2)



#select the 99.9th percentile for rescaling
ghg_rescale_vals_ge <- quantile(all_ghg_vals_ge, 0.999) |> as.numeric()
ghg_rescale_vals_mass <- quantile(all_ghg_vals_mass, 0.999) |> as.numeric()


#test file
this_file <- md_reprojected_rasters_ghg[[1]]

#Rescale all ghg rasters to the 99.9th percentile

#MARINE DIETS 

rescaled_marine_ghg_rasters <- 
  
  map(.x= md_reprojected_rasters_ghg, .f = \(this_file){
  
  this_rast <- rast(this_file)
  
  this_basename <- str_replace(basename(this_file), pattern = "_gp", replacement = "")
  
  this_allocation_method <- str_extract(this_file, "ge_allocation|mass_allocation")
  
  saveName <- sprintf(here("data/spatial/marine_diet/pressures/%s"), this_basename)
  
  if(!file.exists(saveName)){
    
  message("Processing ", "'", this_basename, "'") 
   if(this_allocation_method=="ge_allocation"){
        
        this_rescaled_rast <-  app(x = this_rast, fun = \(x){
                                        if_else(x<0, true = 0, false = if_else(x>ghg_rescale_vals_ge, true = 1, false = x/ghg_rescale_vals_ge))})
        
        names(this_rescaled_rast) <- tools::file_path_sans_ext(this_basename)
      
        writeRaster(x = this_rescaled_rast, filename = saveName, overwrite=TRUE)
      
        return(this_rescaled_rast)
        
        
      } else { 
        
        this_rescaled_rast <- app(x = this_rast, fun = \(x){
                                        if_else(x<0, true = 0, false = if_else(x>ghg_rescale_vals_mass, true = 1, false = x/ghg_rescale_vals_mass))})
        
        names(this_rescaled_rast) <- tools::file_path_sans_ext(this_basename)
      
        writeRaster(x = this_rescaled_rast, filename = saveName, overwrite=TRUE)
      
        return(this_rescaled_rast)
        
        }
  }
  
})



#PLANT DIETS

#test file

this_file <- pd_reprojected_rasters_ghg[[1]]

rescaled_plant_ghg_rasters <- 
  
  map(.x= pd_reprojected_rasters_ghg, .f = \(this_file){
  
  this_rast <- rast(this_file)
  
  this_basename <- str_replace(basename(this_file), pattern = "_gp", replacement = "")
  
  this_allocation_method <- str_extract(this_file, "ge_allocation|mass_allocation")
  
  saveName <- sprintf(here("data/spatial/plant_diet/pressures/%s"), this_basename)
  
  if(!file.exists(saveName)){
    
    message("Processing ", "'", this_basename, "'") 
   if(this_allocation_method=="ge_allocation"){
        
        this_rescaled_rast <-  app(x = this_rast, fun = \(x){
                                        if_else(x<0, true = 0, false = if_else(x>ghg_rescale_vals_ge, true = 1, false = x/ghg_rescale_vals_ge))})
        
        names(this_rescaled_rast) <- tools::file_path_sans_ext(this_basename)
      
        writeRaster(x = this_rescaled_rast, filename = saveName, overwrite=TRUE)
      
        return(this_rescaled_rast)
        
        
      } else { 
        
        this_rescaled_rast <- app(x = this_rast, fun = \(x){
                                        if_else(x<0, true = 0, false = if_else(x>ghg_rescale_vals_mass, true = 1, false = x/ghg_rescale_vals_mass))})
        
        names(this_rescaled_rast) <- tools::file_path_sans_ext(this_basename)
      
        writeRaster(x = this_rescaled_rast, filename = saveName, overwrite=TRUE)
      
        return(this_rescaled_rast)
        
        }
    
  }
  
})


#check layers
plot(rast(rescaled_marine_ghg_rasters))
plot(rast(rescaled_plant_ghg_rasters))

length(rescaled_plant_ghg_rasters)
```

# Nutrient pressures
```{r}

marine_diet_N <- list.files(here("data/spatial/marine_diet/int"), pattern = "_N_", full.names = TRUE)
marine_diet_N <- marine_diet_N[!grepl("forage_fish|_gp", marine_diet_N)]

plant_diet_N <- list.files(here("data/spatial/plant_diet/int"), pattern = "_N_", full.names = TRUE)
plant_diet_N <- plant_diet_N[!grepl("forage_fish|_gp|linseed oil_N_km2_GBR|linseed oil_N_km2_CHN", plant_diet_N)]



#REPROJECT PER KM2 DATA TO GALL PETERS EQUAL AREA FOR TOTAL PRESSURES

this_file <- marine_diet_N[[1]]


# Marine diets
  
map(.x = marine_diet_N, .f = \(this_file){
    
    base <- tools::file_path_sans_ext(basename(this_file))  
    
     this_country <- if_else(grepl("EPC|NAT|OTH", base), true = str_extract(base, "EPC|NAT|OTH"), false = str_sub(base, start = nchar(base)-2, end = nchar(base)))
    
    this_allocation_method <- str_extract(base, "ge_allocation|mass_allocation")
    
    this_ingredient <- str_extract(base, "[^_]+")
    
    saveName <- sprintf(here("data/spatial/marine_diet/int/%s_N_gp_%s_%s.tif"), this_ingredient, this_allocation_method, this_country)
    
    if(!file.exists(saveName)){
      
      message("Processing ", basename(saveName))
      
      this_rast <- rast(this_file)
      
      this_reprojected_rast <- project(this_rast, gall_peters)
      
      this_adj_reproj_rast <- this_reprojected_rast*cellSize(this_reprojected_rast, unit = "km") #multiply up the footprints from per km2 to total based on cellsize
      names(this_adj_reproj_rast) <- "N_eq"

      writeRaster(x = this_adj_reproj_rast, filename = saveName, overwrite = TRUE)
      
      return(this_adj_reproj_rast)
    }
  })



#Plant diets

this_file <- plant_diet_N[[1]]

  
map(.x = plant_diet_N, .f = \(this_file){
    
    base <- tools::file_path_sans_ext(basename(this_file))  
    
   this_country <- if_else(grepl("EPC|NAT|OTH", base), true = str_extract(base, "EPC|NAT|OTH"), false = str_sub(base, start = nchar(base)-2, end = nchar(base)))
    
    this_allocation_method <- str_extract(base, "ge_allocation|mass_allocation")
    this_ingredient <- str_extract(base, "[^_]+")
    
    saveName <- sprintf(here("data/spatial/plant_diet/int/%s_N_gp_%s_%s.tif"), this_ingredient, this_allocation_method, this_country)
    
    if(!file.exists(saveName)){
      
      message("processing ", basename(saveName))
      
      this_rast <- rast(this_file)
      
      this_reprojected_rast <- project(this_rast, gall_peters)
      
      this_adj_reproj_rast <- this_reprojected_rast*cellSize(this_reprojected_rast, unit = "km") #multiply up the footprints from per km2 to total based on cellsize
      
      names(this_adj_reproj_rast) <- "N_eq"
      
      writeRaster(x = this_adj_reproj_rast, filename = saveName, overwrite = TRUE)
      
      return(this_adj_reproj_rast)
    }
  })


#Rescale - gross energy and mass allocation
md_reprojected_rasters_N <- list.files(path = here("data/spatial/marine_diet/int"), pattern = "N_gp", full=TRUE)
pd_reprojected_rasters_N <- list.files(path = here("data/spatial/plant_diet/int"), pattern = "N_gp", full=TRUE)



all_N <- c(md_reprojected_rasters_N, pd_reprojected_rasters_N)

this_file <- all_N_ge[[1]]

all_N_vals_ge <- unlist(map(.x = all_N[grepl("ge_allocation", all_N)], .f = \(this_file){
  
  this_rast <- rast(this_file)
  
  these_rast_values <- as.vector(values(this_rast, na.rm=TRUE))
  
  return(these_rast_values)
}))


all_N_vals_mass <- 
  unlist(map(.x = all_N[grepl("mass_allocation", all_N)], .f = \(this_file){
  
  this_rast <- rast(this_file)
  
  these_rast_values <- as.vector(values(this_rast, na.rm=TRUE))
  
  return(these_rast_values)
}))




# rescale by the 99.9th percentile
hist(all_N_vals_ge, main = "", xlab = "Nitrogen values") |> 
abline(v=quantile(all_N_vals_ge, 0.999), lty = 2)

N_rescale_val_ge <- quantile(all_N_vals_ge, 0.999)

hist(all_N_vals_mass, main = "", xlab = "Nitrogen values") |> 
abline(v=quantile(all_N_vals_mass, 0.999), lty = 2)

N_rescale_val_mass <- quantile(all_N_vals_mass, 0.999)



# Now rescale pressure by the rescale value 

#marine diets - Nitrogen - gross energy

this_file <- md_reprojected_rasters_N[[1]]

map(.x= md_reprojected_rasters_N, .f = \(this_file){
  
  this_rast <- rast(this_file)
  
  this_basename <- str_replace(basename(this_file), pattern = "_gp", replacement = "")
  
  this_allocation_method <- str_extract(string = this_basename, pattern = "ge_allocation|mass_allocation")
  
  saveName <- sprintf(here("data/spatial/marine_diet/pressures/%s"), this_basename)
  
  if(!file.exists(saveName)){
    
     message("Processing", "'", this_basename, "'")
    
    if(this_allocation_method == "ge_allocation"){
       
      this_rescaled_rast <- 
        app(x = this_rast, fun = \(x){
          if_else(x<0, true = 0, false = 
                    if_else(x>N_rescale_val_ge, true = 1, false = x/N_rescale_val_ge))})
      
      names(this_rescaled_rast) <- tools::file_path_sans_ext(this_basename)
      
      writeRaster(x = this_rescaled_rast, filename = saveName, overwrite=TRUE)
      
    } else {
      
      this_rescaled_rast <- 
        app(x = this_rast, fun = \(x){
          if_else(x<0, true = 0, false = 
                    if_else(x>N_rescale_val_mass, true = 1, false = x/N_rescale_val_mass))})
      
      names(this_rescaled_rast) <- tools::file_path_sans_ext(this_basename)
      
      writeRaster(x = this_rescaled_rast, filename = saveName, overwrite=TRUE)
      
      
    }
  }
  
})



#plant diets _ Nitrogen

map(.x= pd_reprojected_rasters_N, .f = \(this_file){
  
  this_rast <- rast(this_file)
  
  this_basename <- str_replace(basename(this_file), pattern = "_gp", replacement = "")
  
  this_allocation_method <- str_extract(string = this_basename, pattern = "ge_allocation|mass_allocation")
  
  saveName <- sprintf(here("data/spatial/plant_diet/pressures/%s"), this_basename)
  
  if(file.exists(saveName)){
    
    message("Processing", "'", this_basename, "'")
    
    if(this_allocation_method == "ge_allocation"){
      
      
      this_rescaled_rast <- 
        app(x = this_rast, fun = \(x){
          if_else(x<0, true = 0, false = 
                    if_else(x>N_rescale_val_ge, true = 1, false = x/N_rescale_val_ge))})
      
      names(this_rescaled_rast) <- tools::file_path_sans_ext(this_basename)
      
      writeRaster(x = this_rescaled_rast, filename = saveName, overwrite=TRUE)
      
    } else {
      
      this_rescaled_rast <- 
        app(x = this_rast, fun = \(x){
          if_else(x<0, true = 0, false = 
                    if_else(x>N_rescale_val_mass, true = 1, false = x/N_rescale_val_mass))})
      
      names(this_rescaled_rast) <- tools::file_path_sans_ext(this_basename)
      
      writeRaster(x = this_rescaled_rast, filename = saveName, overwrite=TRUE)
      
      
    }
    
  }
  
})



# Phosphorus
marine_diet_P <- list.files(here("data/spatial/marine_diet/int"), pattern = "_P_", full.names = TRUE)
marine_diet_P <- marine_diet_P[!grepl("forage_fish|_gp", marine_diet_P)]

plant_diet_P <- list.files(here("data/spatial/plant_diet/int"), pattern = "_P_", full.names = TRUE)
plant_diet_P <- plant_diet_P[!grepl("forage_fish|_gp|linseed oil_P_km2_GBR|linseed oil_P_km2_CHN", plant_diet_P)]



#REPROJECT PER KM2 DATA TO GALL PETERS EQUAL AREA FOR TOTAL PRESSURES

this_file <- marine_diet_P[[1]]


# Marine diets
  
map(.x = marine_diet_P, .f = \(this_file){
    
    base <- tools::file_path_sans_ext(basename(this_file))  
    
    this_country <- if_else(grepl("EPC|NAT|OTH", base), true = str_extract(base, "EPC|NAT|OTH"), false = str_sub(base, start = nchar(base)-2, end = nchar(base)))
    
    this_allocation_method <- str_extract(base, "ge_allocation|mass_allocation")
    
    this_ingredient <- str_extract(base, "[^_]+")
    
    saveName <- sprintf(here("data/spatial/marine_diet/int/%s_P_gp_%s_%s.tif"), this_ingredient, this_allocation_method, this_country)
    
    if(!file.exists(saveName)){
      
      message("Processing ", basename(saveName))
      
      this_rast <- rast(this_file)
      
      this_reprojected_rast <- project(this_rast, gall_peters)
      
      this_adj_reproj_rast <- this_reprojected_rast*cellSize(this_reprojected_rast, unit = "km") #multiply up the footprints from per km2 to total based on cellsize
      names(this_adj_reproj_rast) <- "P_eq"

      writeRaster(x = this_adj_reproj_rast, filename = saveName, overwrite = TRUE)
      
      return(this_adj_reproj_rast)
    }
  })



#Plant diets

this_file <- plant_diet_P[[1]]

  
map(.x = plant_diet_P, .f = \(this_file){
    
    base <- tools::file_path_sans_ext(basename(this_file))  
    
    this_country <- if_else(grepl("EPC|NAT|OTH", base), true = str_extract(base, "EPC|NAT|OTH"), false = str_sub(base, start = nchar(base)-2, end = nchar(base)))
    
    this_allocation_method <- str_extract(base, "ge_allocation|mass_allocation")
    
    this_ingredient <- str_extract(base, "[^_]+")
    
    saveName <- sprintf(here("data/spatial/plant_diet/int/%s_P_gp_%s_%s.tif"), this_ingredient, this_allocation_method, this_country)
    
    if(!file.exists(saveName)){
      
      message("processing ", basename(saveName))
      
      this_rast <- rast(this_file)
      
      this_reprojected_rast <- project(this_rast, gall_peters)
      
      this_adj_reproj_rast <- this_reprojected_rast*cellSize(this_reprojected_rast, unit = "km") #multiply up the footprints from per km2 to total based on cellsize
      
      names(this_adj_reproj_rast) <- "P_eq"
      
      writeRaster(x = this_adj_reproj_rast, filename = saveName, overwrite = TRUE)
      
      return(this_adj_reproj_rast)
    }
  })




md_reprojected_rasters_P <- list.files(path = here("data/spatial/marine_diet/int"), pattern = "P_gp", full=TRUE)
pd_reprojected_rasters_P <- list.files(path = here("data/spatial/plant_diet/int"), pattern = "P_gp", full=TRUE)

all_P <- c(md_reprojected_rasters_P, pd_reprojected_rasters_P)

#this_file <- all_P[[1]]

all_P_vals_ge <- 
  
  unlist(map(.x = all_P[grepl("ge_allocation", all_P)], .f = \(this_file){
  
  this_rast <- rast(this_file)
  
  these_rast_values <- as.vector(values(this_rast, na.rm=TRUE))
  
  return(these_rast_values)
}))


all_P_vals_mass <- 
  
  unlist(map(.x = all_P[grepl("mass_allocation", all_P)], .f = \(this_file){
  
  this_rast <- rast(this_file)
  
  these_rast_values <- as.vector(values(this_rast, na.rm=TRUE))
  
  return(these_rast_values)
}))



#determine quantile for rescaling
hist(all_P_vals_ge, main = "", xlab = "Phosphorus values") |> 
abline(v=quantile(all_P_vals_ge, 0.999), lty = 2)

P_rescale_val_ge <- quantile(all_P_vals_ge, 0.999) |> as.numeric()


hist(all_P_vals_mass, main = "", xlab = "Phosphorus values") |> 
abline(v=quantile(all_P_vals_mass, 0.999), lty = 2)

P_rescale_val_mass <- quantile(all_P_vals_mass, 0.999) |> as.numeric()


# Now rescale pressure by the rescale value 

#marine diets - Phosphorus

#this_file <- marine_diet_P[[1]]

map(.x= md_reprojected_rasters_P, .f = \(this_file){
  
  this_rast <- rast(this_file)
  
  this_basename <- str_replace(basename(this_file), pattern = "_gp", replacement = "")
  
  this_allocation_method <- str_extract(this_basename, "ge_allocation|mass_allocation")
  
  saveName <- sprintf(here("data/spatial/marine_diet/pressures/%s"), this_basename)
  
  if(!file.exists(saveName)){
    
     message("Processing", "'", this_basename, "'")
    
    if(this_allocation_method == "ge_allocation"){
      
      this_rescaled_rast <- 
        app(x = this_rast, fun = \(x){
          if_else(x<0, true = 0, false = 
                    if_else(x>P_rescale_val_ge, true = 1, false = x/P_rescale_val_ge))})
      
      names(this_rescaled_rast) <- tools::file_path_sans_ext(this_basename)
      
      writeRaster(x = this_rescaled_rast, filename = saveName, overwrite=TRUE)
    
    } else {
      
      this_rescaled_rast <- 
        app(x = this_rast, fun = \(x){
          if_else(x<0, true = 0, false = 
                    if_else(x>P_rescale_val_mass, true = 1, false = x/P_rescale_val_mass))})
      
      names(this_rescaled_rast) <- tools::file_path_sans_ext(this_basename)
      
      writeRaster(x = this_rescaled_rast, filename = saveName, overwrite=TRUE)
      
    }
    
    
   
  }
  
})



#plant diets - Phosphorus

map(.x= pd_reprojected_rasters_P, .f = \(this_file){
  
  this_rast <- rast(this_file)
  
  this_basename <- str_replace(basename(this_file), pattern = "_gp", replacement = "")
  
  this_allocation_method <- str_extract(this_basename, "ge_allocation|mass_allocation")
  
  saveName <- sprintf(here("data/spatial/plant_diet/pressures/%s"), this_basename)
  
  if(!file.exists(saveName)){
    
     message("Processing", "'", this_basename, "'")
    
    if(this_allocation_method == "ge_allocation"){
      
      this_rescaled_rast <- 
        app(x = this_rast, fun = \(x){
          if_else(x<0, true = 0, false = 
                    if_else(x>P_rescale_val_ge, true = 1, false = x/P_rescale_val_ge))})
      
      names(this_rescaled_rast) <- tools::file_path_sans_ext(this_basename)
      
      writeRaster(x = this_rescaled_rast, filename = saveName, overwrite=TRUE)
    
    } else {
      
      this_rescaled_rast <- 
        app(x = this_rast, fun = \(x){
          if_else(x<0, true = 0, false = 
                    if_else(x>P_rescale_val_mass, true = 1, false = x/P_rescale_val_mass))})
      
      names(this_rescaled_rast) <- tools::file_path_sans_ext(this_basename)
      
      writeRaster(x = this_rescaled_rast, filename = saveName, overwrite=TRUE)
      
    }
    
  }
  
})





```


# Water extraction
```{r}

marine_diet_h2o <- list.files(here("data/spatial/marine_diet/int"), pattern = "_water_", full.names = TRUE)
marine_diet_h2o <- marine_diet_h2o[!grepl("forage_fish|_gp", marine_diet_h2o)]

plant_diet_h2o <- list.files(here("data/spatial/plant_diet/int"), pattern = "_water_", full.names = TRUE)
plant_diet_h2o <- plant_diet_h2o[!grepl("forage_fish|_gp", plant_diet_h2o)]


#REPROJECT PER KM2 DATA TO GALL PETERS EQUAL AREA FOR TOTAL PRESSURES

this_file <- marine_diet_h2o[[1]]


# Marine diets
  
map(.x = marine_diet_h2o, .f = \(this_file){
    
    base <- tools::file_path_sans_ext(basename(this_file))  
    
    this_country <- if_else(grepl("EPC|NAT|OTH", base), true = str_extract(base, "EPC|NAT|OTH"), false = str_sub(base, start = nchar(base)-2, end = nchar(base)))
    
    this_allocation_method <- str_extract(base, "ge_allocation|mass_allocation")
    
    this_ingredient <- str_extract(base, "[^_]+")
    
    saveName <- sprintf(here("data/spatial/marine_diet/int/%s_water_gp_%s_%s.tif"), this_ingredient, this_allocation_method, this_country)
    
    if(!file.exists(saveName)){
      
      message("Processing ", basename(saveName))
      
      this_rast <- rast(this_file)
      
      this_reprojected_rast <- project(this_rast, gall_peters)
      
      this_adj_reproj_rast <- this_reprojected_rast*cellSize(this_reprojected_rast, unit = "km") #multiply up the footprints from per km2 to total based on cellsize
      names(this_adj_reproj_rast) <- "m3"

      writeRaster(x = this_adj_reproj_rast, filename = saveName, overwrite = TRUE)
      
      return(this_adj_reproj_rast)
    }
  })



#Plant diets

this_file <- plant_diet_N[[1]]

  
map(.x = plant_diet_h2o, .f = \(this_file){
    
    base <- tools::file_path_sans_ext(basename(this_file))  
    
    this_country <- if_else(grepl("EPC|NAT|OTH", base), true = str_extract(base, "EPC|NAT|OTH"), false = str_sub(base, start = nchar(base)-2, end = nchar(base)))
    
    this_allocation_method <- str_extract(base, "ge_allocation|mass_allocation")
    
    this_ingredient <- str_extract(base, "[^_]+")
    
    saveName <- sprintf(here("data/spatial/plant_diet/int/%s_water_gp_%s_%s.tif"), this_ingredient, this_allocation_method, this_country)
    
    if(!file.exists(saveName)){
      
      message("processing ", basename(saveName))
      
      this_rast <- rast(this_file)
      
      this_reprojected_rast <- project(this_rast, gall_peters)
      
      this_adj_reproj_rast <- this_reprojected_rast*cellSize(this_reprojected_rast, unit = "km") #multiply up the footprints from per km2 to total based on cellsize
      
      names(this_adj_reproj_rast) <- "m3"
      
      writeRaster(x = this_adj_reproj_rast, filename = saveName, overwrite = TRUE)
      
      return(this_adj_reproj_rast)
    }
  })



md_reprojected_rasters_h2o <- list.files(path = here("data/spatial/marine_diet/int"), pattern = "water_gp", full=TRUE)
pd_reprojected_rasters_h2o <- list.files(path = here("data/spatial/plant_diet/int"), pattern = "water_gp", full=TRUE)


all_h2o <- c(md_reprojected_rasters_h2o, pd_reprojected_rasters_h2o)

this_file <- all_h2o[[1]]

all_h2o_vals_ge <- 
  
  unlist(map(.x = all_h2o[grepl("ge_allocation", all_h2o)], .f = \(this_file){
  
  this_rast <- rast(this_file)
  
  these_rast_values <- as.vector(values(this_rast, na.rm=TRUE))
  
  return(these_rast_values)
}))


all_h2o_vals_mass <- 
  
  unlist(map(.x = all_h2o[grepl("mass_allocation", all_h2o)], .f = \(this_file){
  
  this_rast <- rast(this_file)
  
  these_rast_values <- as.vector(values(this_rast, na.rm=TRUE))
  
  return(these_rast_values)
}))



#determine quantile for rescaling
hist(all_h2o_vals_ge, main = "", xlab = "Water values") |> 
abline(v=quantile(all_h2o_vals_ge, 0.999), lty = 2)


water_rescale_val_ge <- quantile(all_h2o_vals_ge, 0.999) |> as.numeric()


hist(all_h2o_vals_mass, main = "", xlab = "Water values") |> 
abline(v=quantile(all_h2o_vals_mass, 0.999), lty = 2)


water_rescale_val_mass <- quantile(all_h2o_vals_mass, 0.999) |> as.numeric()



#marine diets - Water

map(.x= md_reprojected_rasters_h2o, .f = \(this_file){
  
  this_rast <- rast(this_file)
  
  this_basename <- str_replace(basename(this_file), pattern = "_gp", replacement = "")
  
  this_allocation_method <- str_extract(this_basename, "ge_allocation|mass_allocation")
  
  saveName <- sprintf(here("data/spatial/marine_diet/pressures/%s"), this_basename)
  
  if(!file.exists(saveName)){
    
     message("Processing", "'", this_basename, "'")
    
    if(this_allocation_method == "ge_allocation"){
      
      this_rescaled_rast <- 
        app(x = this_rast, fun = \(x){
          if_else(x<0, true = 0, false = 
                    if_else(x>water_rescale_val_ge, true = 1, false = x/water_rescale_val_ge))})
      
      names(this_rescaled_rast) <- tools::file_path_sans_ext(this_basename)
      
      writeRaster(x = this_rescaled_rast, filename = saveName, overwrite=TRUE)
    
    } else {
      
      this_rescaled_rast <- 
        app(x = this_rast, fun = \(x){
          if_else(x<0, true = 0, false = 
                    if_else(x>water_rescale_val_mass, true = 1, false = x/water_rescale_val_mass))})
      
      names(this_rescaled_rast) <- tools::file_path_sans_ext(this_basename)
      
      writeRaster(x = this_rescaled_rast, filename = saveName, overwrite=TRUE)
      
    }
  }
  
})



#plant diets - water

map(.x= pd_reprojected_rasters_h2o, .f = \(this_file){
  
  this_rast <- rast(this_file)
  
  this_basename <- str_replace(basename(this_file), pattern = "_gp", replacement = "")
  
  saveName <- sprintf(here("data/spatial/plant_diet/pressures/%s"), this_basename)
  
  if(!file.exists(saveName)){
    
     message("Processing", "'", this_basename, "'")
    
     if(this_allocation_method == "ge_allocation"){
      
      this_rescaled_rast <- 
        app(x = this_rast, fun = \(x){
          if_else(x<0, true = 0, false = 
                    if_else(x>water_rescale_val_ge, true = 1, false = x/water_rescale_val_ge))})
      
      names(this_rescaled_rast) <- tools::file_path_sans_ext(this_basename)
      
      writeRaster(x = this_rescaled_rast, filename = saveName, overwrite=TRUE)
    
    } else {
      
      this_rescaled_rast <- 
        app(x = this_rast, fun = \(x){
          if_else(x<0, true = 0, false = 
                    if_else(x>water_rescale_val_mass, true = 1, false = x/water_rescale_val_mass))})
      
      names(this_rescaled_rast) <- tools::file_path_sans_ext(this_basename)
      
      writeRaster(x = this_rescaled_rast, filename = saveName, overwrite=TRUE)
      
    } 
  }
  
})




rm(list = ls())


```







