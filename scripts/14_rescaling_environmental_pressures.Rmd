---
title: "Rescaling environmental pressures"
author: "Rich Cottrell"
date: "30/06/2022"
output: html_document
---

This file is used to rescale all rasters' values for each pressure so that values among feeds may be compared.

```{r}

library(tidyverse)
library(terra)
library(here)
library(parallel)
library(doParallel)
library(foreach)

select <- dplyr::select
values <- terra::values

source(here("src/fxns.R"))
```

Create base mollweide projection for rescaling
```{r}

gall_peters <- "+proj=cea +lon_0=0 +x_0=0 +y_0=0 +lat_ts=45 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"
#raster template 
base_rast <- rast(res=0.5)
ext(base_rast) <- c(-180, 180, -90, 90)

eq_area_rast <- project(base_rast, gall_peters, res=10000) 
values(eq_area_rast) <- 1:ncell(eq_area_rast)

#plot(eq_area_rast)
#cellSize(eq_area_rast, unit="km")

```



## Disturbance

Bring in  forage fish and crop layers for disturbance for both diets. Reproject onto the equal area mollweide projection. These do not need to be normalised by km2 as the units are simply km2. Then look at the values to establish a percentile to use for rescaling.

```{r}

#ID files for disturbance for marine and plant diets
marine_diet_disturbance <- list.files(here("data/spatial/marine_diet/int"), pattern = "disturbance_km2", full.names = TRUE)
marine_diet_disturbance <- marine_diet_disturbance[!grepl("forage_fish|_gp", marine_diet_disturbance)]

#REPROJECT PER KM2 DATA TO GALL PETERS EQUAL AREA

this_file <- marine_diet_disturbance[[2]]


#marine diets
md_reprojected_rasters <- 
  
  map(.x = marine_diet_disturbance, .f = \(this_file){
    
    base <- tools::file_path_sans_ext(basename(this_file))  
    
    this_country <- str_sub(base, start = nchar(base)-2, end = nchar(base))
    
    this_ingredient <- str_extract(base, "[^_]+")
    
    saveName <- sprintf(here("data/spatial/marine_diet/int/%s_disturbance_km2_gp_%s.tif"), this_ingredient, this_country)
    
    if(file.exists(saveName)){
      
      message("processing ", basename(saveName))
      
      this_rast <- rast(this_file)
      
      this_reprojected_rast <- project(this_rast, eq_area_rast)
      
      this_adj_reproj_rast <- app(x = this_reprojected_rast, fun = \(x){if_else(condition = x>100, true = 100, false = x)})
      names(this_adj_reproj_rast) <- names(this_rast)
      
      writeRaster(x = this_adj_reproj_rast, filename = saveName, overwrite = TRUE)
      
      return(this_adj_reproj_rast)
    }
  })


marine_diet_disturbance |> map(rast)


#plant diets
plant_diet_disturbance <- list.files(here("data/spatial/plant_diet/int"), pattern = "disturbance_km2", full.names = TRUE)
plant_diet_disturbance <- plant_diet_disturbance[!grepl("forage_fish|_gp", plant_diet_disturbance)]


this_file <- plant_diet_disturbance[[1]]

pd_reprojected_rasters <- 
  
  map(.x = plant_diet_disturbance, .f = \(this_file){
    
    base <- tools::file_path_sans_ext(basename(this_file))  
    
    this_country <- str_sub(base, start = nchar(base)-2, end = nchar(base))
    
    this_ingredient <- str_extract(base, "[^_]+")
    
    saveName <- sprintf(here("data/spatial/plant_diet/int/%s_disturbance_km2_gp_%s.tif"), this_ingredient, this_country)
    
    
    if(file.exists(saveName)){
      
      message("processing ", basename(saveName))
      
      this_rast <- rast(this_file)
      
      this_reprojected_rast <- project(this_rast, gall_peters, res = 10000)
      
      this_adj_reproj_rast <- app(x = this_reprojected_rast, fun = \(x){
        if_else(condition = x>100, true = 100, false = x)})
       names(this_adj_reproj_rast) <- names(this_rast)
      
      writeRaster(x = this_adj_reproj_rast, filename = saveName, overwrite = TRUE)
      
      return(this_adj_reproj_rast)
    }
  })


md_reprojected_rasters <- list.files(path = here("data/spatial/marine_diet/int"), pattern = "disturbance_km2_gp", full=TRUE)
pd_reprojected_rasters <- list.files(path = here("data/spatial/plant_diet/int"), pattern = "disturbance_km2_gp", full=TRUE)


#which diet has the highest disturbance values
marine_disturbance_vals <- md_reprojected_rasters |> map(rast) |> map(no_na_values) |> unlist()
plant_disturbance_vals <-  pd_reprojected_rasters |> map(rast) |> map(no_na_values) |> unlist()

#check marine is appearing more intense (given forage fish distrubance values are much higher)
summary(marine_disturbance_vals)
summary(plant_disturbance_vals)

all_disturbance_vals <- c(marine_disturbance_vals, plant_disturbance_vals)


#determine the quantile for rescaling
hist(unlist(all_disturbance_vals), main = "", xlab = "Disturbance values") |> 
abline(v = quantile(all_disturbance_vals, 0.999), lty=2)


disturbance_rescale_val <- quantile(all_disturbance_vals, 0.999) |> as.numeric()


#rescale all rasters by the 99.9th percentile

#marine diets

this_file <- md_reprojected_rasters[[1]]


rescaled_marine_disturbance_rasters <- 
  
  map(.x= md_reprojected_rasters, .f = \(this_file){
    
    this_rast <- rast(this_file)
    
    this_basename <- str_replace(basename(this_file), pattern = "_km2_gp", replacement = "")
    
    saveName <- sprintf(here("data/spatial/marine_diet/pressures/%s"), this_basename)
    
    if(file.exists(saveName)){
    
    message("Processing ", "'", this_basename, "'")  
      
      this_rescaled_rast <- 
        app(x = this_rast, fun = \(x){
          if_else(x<0, true = 0, false = if_else(x>disturbance_rescale_val, true = 1, false = x/disturbance_rescale_val))
        })
      
      names(this_rescaled_rast) <- tools::file_path_sans_ext(this_basename)
      
      writeRaster(x = this_rescaled_rast, filename = saveName, overwrite=TRUE)
      
      return(this_rescaled_rast)
    }
  })


#plant diets

rescaled_plant_disturbance_rasters <- 
  
  map(.x= pd_reprojected_rasters, .f = \(this_file){
  
  this_rast <- rast(this_file)
  
  this_basename <- str_replace(basename(this_file), pattern = "_km2_gp", replacement = "")
  
  saveName <- sprintf(here("data/spatial/plant_diet/pressures/%s"), this_basename)
  
  if(file.exists(saveName)){
    
   message("Processing ", "'", this_basename, "'")
    
    this_rescaled_rast <- 
      app(x = this_rast, fun = \(x){
        if_else(x<0, true = 0, false = if_else(x>disturbance_rescale_val, true = 1, false = x/disturbance_rescale_val))
    })
    
    names(this_rescaled_rast) <- tools::file_path_sans_ext(this_basename)
    
    writeRaster(x = this_rescaled_rast, filename = saveName, overwrite=TRUE)
    
    return(this_rescaled_rast)
  }
  
})


# compare rescaled rasters

plot(rast(rescaled_marine_disturbance_rasters))
plot(rast(rescaled_plant_disturbance_rasters))

```

# Greenhouse gas pressures

Need to remove the email raster layers. Due the slow nature of reprojecting rasters

```{r}

marine_diet_ghg <- list.files(here("data/spatial/marine_diet/int"), pattern = "ghg", full.names = TRUE)
marine_diet_ghg <- marine_diet_ghg[!grepl("forage_fish|_gp", marine_diet_ghg)]

plant_diet_ghg <- list.files(here("data/spatial/plant_diet/int"), pattern = "ghg", full.names = TRUE)
plant_diet_ghg <- plant_diet_ghg[!grepl("forage_fish|_gp", plant_diet_ghg)]



#REPROJECT PER KM2 DATA TO GALL PETERS EQUAL AREA FOR TOTAL PRESSURES

this_file <- marine_diet_ghg[[1]]


# Marine diets
  
map(.x = marine_diet_ghg, .f = \(this_file){
    
    base <- tools::file_path_sans_ext(basename(this_file))  
    
    this_country <- str_sub(base, start = nchar(base)-2, end = nchar(base))
    
    this_ingredient <- str_extract(base, "[^_]+")
    
    saveName <- sprintf(here("data/spatial/marine_diet/int/%s_ghg_gp_%s.tif"), this_ingredient, this_country)
    
    if(!file.exists(saveName)){
      
      message("Processing ", basename(saveName))
      
      this_rast <- rast(this_file)
      
      this_reprojected_rast <- project(this_rast, eq_area_rast)
      
      this_adj_reproj_rast <- this_reprojected_rast*100 #multiply up the footprints from per km2 to total based on 100km2
      names(this_adj_reproj_rast) <- "kgCO2eq"

      writeRaster(x = this_adj_reproj_rast, filename = saveName, overwrite = TRUE)
      
      return(this_adj_reproj_rast)
    }
  })



#Plant diets

this_file <- plant_diet_ghg[[1]]

  
map(.x = plant_diet_ghg, .f = \(this_file){
    
    base <- tools::file_path_sans_ext(basename(this_file))  
    
    this_country <- str_sub(base, start = nchar(base)-2, end = nchar(base))
    
    this_ingredient <- str_extract(base, "[^_]+")
    
    saveName <- sprintf(here("data/spatial/plant_diet/int/%s_ghg_gp_%s.tif"), this_ingredient, this_country)
    
    if(!file.exists(saveName)){
      
      message("processing ", basename(saveName))
      
      this_rast <- rast(this_file)
      
      this_reprojected_rast <- project(this_rast, eq_area_rast)
      
      this_adj_reproj_rast <- this_reprojected_rast*100 #multiply up the footprints from per km2 to total based on 100km2
      
      names(this_adj_reproj_rast) <- "kgCO2eq"
      
      writeRaster(x = this_adj_reproj_rast, filename = saveName, overwrite = TRUE)
      
      return(this_adj_reproj_rast)
    }
  })
  





#RESCALE THE TOTAL GHG DATA
  
md_reprojected_rasters_ghg <- list.files(path = here("data/spatial/marine_diet/int"), pattern = "ghg_gp", full=TRUE)
pd_reprojected_rasters_ghg <- list.files(path = here("data/spatial/plant_diet/int"), pattern = "ghg_gp", full=TRUE)

#get the raster values from files
marine_ghg_vals <- md_reprojected_rasters_ghg |> map(rast) |> map(no_na_values) |> unlist()
plant_ghg_vals <- pd_reprojected_rasters_ghg |> map(rast) |> map(no_na_values) |> unlist()

#compare marine and plant ghgs
summary(marine_ghg_vals)
summary(plant_ghg_vals)

all_ghg_vals <- c(marine_ghg_vals, plant_ghg_vals)

#explore a reasonable rescale value
hist(all_ghg_vals, main = "", xlab = "GHG values") |> 
abline(v=quantile(all_ghg_vals, 0.999), lty = 2)

#select the 99.9th percentile for rescaling
ghg_rescale_val <- quantile(all_ghg_vals, 0.999) |> as.numeric()

#test file
this_file <- md_reprojected_rasters_ghg[[1]]

#Rescale all ghg rasters to the 99.99th percentile
rescaled_marine_ghg_rasters <- 
  
  map(.x= md_reprojected_rasters_ghg, .f = \(this_file){
  
  this_rast <- rast(this_file)
  
  this_basename <- str_replace(basename(this_file), pattern = "_gp", replacement = "")
  
  saveName <- sprintf(here("data/spatial/marine_diet/pressures/%s"), this_basename)
  
  if(!file.exists(saveName)){
    
    this_rescaled_rast <- 
      app(x = this_rast, fun = \(x){
        if_else(x<0, true = 0, false = if_else(x>ghg_rescale_val, true = 1, false = x/ghg_rescale_val))
                  })
    names(this_rescaled_rast) <- tools::file_path_sans_ext(this_basename)
    
    writeRaster(x = this_rescaled_rast, filename = saveName, overwrite=TRUE)
    
    return(this_rescaled_rast)
  }
  
})



#PLANT DIETS

#test file

this_file <- pd_reprojected_rasters_ghg[[1]]

rescaled_plant_ghg_rasters <- 
  
  map(.x= pd_reprojected_rasters_ghg, .f = \(this_file){
  
  this_rast <- rast(this_file)
  
  this_basename <- str_replace(basename(this_file), pattern = "_gp", replacement = "")
  
  saveName <- sprintf(here("data/spatial/plant_diet/pressures/%s"), this_basename)
  
  if(!file.exists(saveName)){
    
    this_rescaled_rast <- 
      app(x = this_rast, fun = \(x){
        if_else(x<0, true = 0, false = if_else(x>ghg_rescale_val, true = 1, false = x/ghg_rescale_val))
    })
    
    names(this_rescaled_rast) <- tools::file_path_sans_ext(this_basename)
    
    writeRaster(x = this_rescaled_rast, filename = saveName, overwrite=TRUE)
    
    return(this_rescaled_rast)
    
  }
  
})


#check layers
plot(rast(rescaled_marine_ghg_rasters))
plot(rast(rescaled_plant_ghg_rasters))

length(rescaled_plant_ghg_rasters)
```

# Nutrient pressures
```{r}

marine_diet_N <- list.files(here("data/spatial/marine_diet/int"), pattern = "_N_", full.names = TRUE)
marine_diet_N <- marine_diet_N[!grepl("forage_fish|_gp", marine_diet_N)]

plant_diet_N <- list.files(here("data/spatial/plant_diet/int"), pattern = "_N_", full.names = TRUE)
plant_diet_N <- plant_diet_N[!grepl("forage_fish|_gp", plant_diet_N)]


#REPROJECT PER KM2 DATA TO GALL PETERS EQUAL AREA FOR TOTAL PRESSURES

this_file <- marine_diet_N[[1]]


# Marine diets
  
map(.x = marine_diet_N, .f = \(this_file){
    
    base <- tools::file_path_sans_ext(basename(this_file))  
    
    this_country <- str_sub(base, start = nchar(base)-2, end = nchar(base))
    
    this_ingredient <- str_extract(base, "[^_]+")
    
    saveName <- sprintf(here("data/spatial/marine_diet/int/%s_N_gp_%s.tif"), this_ingredient, this_country)
    
    if(!file.exists(saveName)){
      
      message("Processing ", basename(saveName))
      
      this_rast <- rast(this_file)
      
      this_reprojected_rast <- project(this_rast, eq_area_rast)
      
      this_adj_reproj_rast <- this_reprojected_rast*100 #multiply up the footprints from per km2 to total based on 100km2
      names(this_adj_reproj_rast) <- "N_eq"

      writeRaster(x = this_adj_reproj_rast, filename = saveName, overwrite = TRUE)
      
      return(this_adj_reproj_rast)
    }
  })



#Plant diets

this_file <- plant_diet_N[[1]]

  
map(.x = plant_diet_N, .f = \(this_file){
    
    base <- tools::file_path_sans_ext(basename(this_file))  
    
    this_country <- str_sub(base, start = nchar(base)-2, end = nchar(base))
    
    this_ingredient <- str_extract(base, "[^_]+")
    
    saveName <- sprintf(here("data/spatial/plant_diet/int/%s_N_gp_%s.tif"), this_ingredient, this_country)
    
    if(!file.exists(saveName)){
      
      message("processing ", basename(saveName))
      
      this_rast <- rast(this_file)
      
      this_reprojected_rast <- project(this_rast, eq_area_rast)
      
      this_adj_reproj_rast <- this_reprojected_rast*100 #multiply up the footprints from per km2 to total based on 100km2
      
      names(this_adj_reproj_rast) <- "N_eq"
      
      writeRaster(x = this_adj_reproj_rast, filename = saveName, overwrite = TRUE)
      
      return(this_adj_reproj_rast)
    }
  })


md_reprojected_rasters_N <- list.files(path = here("data/spatial/marine_diet/int"), pattern = "N_gp", full=TRUE)
pd_reprojected_rasters_N <- list.files(path = here("data/spatial/plant_diet/int"), pattern = "N_gp", full=TRUE)

all_N <- c(md_reprojected_rasters_N, pd_reprojected_rasters_N)

this_file <- all_N[[1]]

all_N_vals <- unlist(map(.x = all_N, .f = \(this_file){
  
  this_rast <- rast(this_file)
  
  these_rast_values <- as.vector(values(this_rast, na.rm=TRUE))
  
  return(these_rast_values)
}))


# rescale by the 99.9th percentile
hist(all_N_vals, main = "", xlab = "Nitrogen values")
abline(v=quantile(all_N_vals, 0.999), lty = 2)


N_rescale_val <- quantile(all_N_vals, 0.999)


# Now rescale pressure by the rescale value 

#marine diets - Nitrogen

this_file <- md_reprojected_rasters_N[[1]]

map(.x= md_reprojected_rasters_N, .f = \(this_file){
  
  this_rast <- rast(this_file)
  
  this_basename <- str_replace(basename(this_file), pattern = "_gp", replacement = "")
  
  saveName <- sprintf(here("data/spatial/marine_diet/pressures/%s"), this_basename)
  
  if(!file.exists(saveName)){
    
    message("Processing", "'", this_basename, "'")
    
    this_rescaled_rast <- 
      app(x = this_rast, fun = \(x){
        if_else(x<0, true = 0, false = 
                  if_else(x>N_rescale_val, true = 1, false = x/N_rescale_val))})
    
    names(this_rescaled_rast) <- tools::file_path_sans_ext(this_basename)
    
    writeRaster(x = this_rescaled_rast, filename = saveName, overwrite=TRUE)
  }
  
})



#plant diets _ Nitrogen

map(.x= pd_reprojected_rasters_N, .f = \(this_file){
  
  this_rast <- rast(this_file)
  
  this_basename <- str_replace(basename(this_file), pattern = "_gp", replacement = "")
  
  saveName <- sprintf(here("data/spatial/plant_diet/pressures/%s"), this_basename)
  
  if(!file.exists(saveName)){
    
    this_rescaled_rast <- 
      app(x = this_rast, fun = \(x){
        if_else(x<0, true = 0, false = 
                  if_else(x>N_rescale_val, true = 1, false = x/N_rescale_val))})
    
    names(this_rescaled_rast) <- tools::file_path_sans_ext(this_basename)
    
    writeRaster(x = this_rescaled_rast, filename = saveName, overwrite=TRUE)
    
  }
  
})








# Phosphorus

marine_diet_P <- list.files(here("data/spatial/marine_diet/int"), pattern = "_P_", full.names = TRUE)
marine_diet_P <- marine_diet_P[!grepl("forage_fish|_gp", marine_diet_P)]

plant_diet_P <- list.files(here("data/spatial/plant_diet/int"), pattern = "_P_", full.names = TRUE)
plant_diet_P <- plant_diet_P[!grepl("forage_fish|_gp", plant_diet_P)]


#REPROJECT PER KM2 DATA TO GALL PETERS EQUAL AREA FOR TOTAL PRESSURES

this_file <- marine_diet_P[[1]]


# Marine diets
  
map(.x = marine_diet_P, .f = \(this_file){
    
    base <- tools::file_path_sans_ext(basename(this_file))  
    
    this_country <- str_sub(base, start = nchar(base)-2, end = nchar(base))
    
    this_ingredient <- str_extract(base, "[^_]+")
    
    saveName <- sprintf(here("data/spatial/marine_diet/int/%s_P_gp_%s.tif"), this_ingredient, this_country)
    
    if(!file.exists(saveName)){
      
      message("Processing ", basename(saveName))
      
      this_rast <- rast(this_file)
      
      this_reprojected_rast <- project(this_rast, eq_area_rast)
      
      this_adj_reproj_rast <- this_reprojected_rast*100 #multiply up the footprints from per km2 to total based on 100km2
      names(this_adj_reproj_rast) <- "P_eq"

      writeRaster(x = this_adj_reproj_rast, filename = saveName, overwrite = TRUE)
      
      return(this_adj_reproj_rast)
    }
  })



#Plant diets

this_file <- plant_diet_P[[1]]

  
map(.x = plant_diet_P, .f = \(this_file){
    
    base <- tools::file_path_sans_ext(basename(this_file))  
    
    this_country <- str_sub(base, start = nchar(base)-2, end = nchar(base))
    
    this_ingredient <- str_extract(base, "[^_]+")
    
    saveName <- sprintf(here("data/spatial/plant_diet/int/%s_P_gp_%s.tif"), this_ingredient, this_country)
    
    if(!file.exists(saveName)){
      
      message("processing ", basename(saveName))
      
      this_rast <- rast(this_file)
      
      this_reprojected_rast <- project(this_rast, eq_area_rast)
      
      this_adj_reproj_rast <- this_reprojected_rast*100 #multiply up the footprints from per km2 to total based on 100km2
      
      names(this_adj_reproj_rast) <- "P_eq"
      
      writeRaster(x = this_adj_reproj_rast, filename = saveName, overwrite = TRUE)
      
      return(this_adj_reproj_rast)
    }
  })




md_reprojected_rasters_P <- list.files(path = here("data/spatial/marine_diet/int"), pattern = "P_gp", full=TRUE)
pd_reprojected_rasters_P <- list.files(path = here("data/spatial/plant_diet/int"), pattern = "P_gp", full=TRUE)

all_P <- c(md_reprojected_rasters_P, pd_reprojected_rasters_P)

#this_file <- all_P[[1]]

all_P_vals <- unlist(map(.x = all_P, .f = \(this_file){
  
  this_rast <- rast(this_file)
  
  these_rast_values <- as.vector(values(this_rast, na.rm=TRUE))
  
  return(these_rast_values)
}))



#determine quantile for rescaling
hist(all_P_vals, main = "", xlab = "Phosphorus values")
abline(v=quantile(all_P_vals, 0.999), lty = 2)

P_rescale_val <- quantile(all_P_vals, 0.999) |> as.numeric()


# Now rescale pressure by the rescale value 

#marine diets - Phosphorus

#this_file <- marine_diet_P[[1]]

map(.x= md_reprojected_rasters_P, .f = \(this_file){
  
  this_rast <- rast(this_file)
  
  this_basename <- str_replace(basename(this_file), pattern = "_gp", replacement = "")
  
  saveName <- sprintf(here("data/spatial/marine_diet/pressures/%s"), this_basename)
  
  if(!file.exists(saveName)){
    
     message("Processing", "'", this_basename, "'")
    
    this_rescaled_rast <- 
      app(x = this_rast, fun = \(x){
        if_else(x<0, true = 0, false = 
                  if_else(x>P_rescale_val, true = 1, false = x/P_rescale_val))})
    
    names(this_rescaled_rast) <- tools::file_path_sans_ext(this_basename)
    
    writeRaster(x = this_rescaled_rast, filename = saveName, overwrite=TRUE)
  }
  
})



#plant diets - Phosphorus

map(.x= pd_reprojected_rasters_P, .f = \(this_file){
  
  this_rast <- rast(this_file)
  
  this_basename <- str_replace(basename(this_file), pattern = "_gp", replacement = "")
  
  saveName <- sprintf(here("data/spatial/plant_diet/pressures/%s"), this_basename)
  
  if(!file.exists(saveName)){
    
     message("Processing", "'", this_basename, "'")
    
    this_rescaled_rast <- 
      app(x = this_rast, fun = \(x){
        if_else(x<0, true = 0, false = 
                  if_else(x>P_rescale_val, true = 1, false = x/P_rescale_val))})
    
    names(this_rescaled_rast) <- tools::file_path_sans_ext(this_basename)
    
    writeRaster(x = this_rescaled_rast, filename = saveName, overwrite=TRUE)
    
  }
  
})





```


# Water extraction
```{r}

marine_diet_h2o <- list.files(here("data/spatial/marine_diet/int"), pattern = "_water_", full.names = TRUE)
marine_diet_h2o <- marine_diet_h2o[!grepl("forage_fish|_gp", marine_diet_h2o)]

plant_diet_h2o <- list.files(here("data/spatial/plant_diet/int"), pattern = "_water_", full.names = TRUE)
plant_diet_h2o <- plant_diet_h2o[!grepl("forage_fish|_gp", plant_diet_h2o)]


#REPROJECT PER KM2 DATA TO GALL PETERS EQUAL AREA FOR TOTAL PRESSURES

this_file <- marine_diet_h2o[[1]]


# Marine diets
  
map(.x = marine_diet_h2o, .f = \(this_file){
    
    base <- tools::file_path_sans_ext(basename(this_file))  
    
    this_country <- str_sub(base, start = nchar(base)-2, end = nchar(base))
    
    this_ingredient <- str_extract(base, "[^_]+")
    
    saveName <- sprintf(here("data/spatial/marine_diet/int/%s_water_gp_%s.tif"), this_ingredient, this_country)
    
    if(!file.exists(saveName)){
      
      message("Processing ", basename(saveName))
      
      this_rast <- rast(this_file)
      
      this_reprojected_rast <- project(this_rast, eq_area_rast)
      
      this_adj_reproj_rast <- this_reprojected_rast*100 #multiply up the footprints from per km2 to total based on 100km2
      names(this_adj_reproj_rast) <- "m3"

      writeRaster(x = this_adj_reproj_rast, filename = saveName, overwrite = TRUE)
      
      return(this_adj_reproj_rast)
    }
  })



#Plant diets

this_file <- plant_diet_N[[1]]

  
map(.x = plant_diet_h2o, .f = \(this_file){
    
    base <- tools::file_path_sans_ext(basename(this_file))  
    
    this_country <- str_sub(base, start = nchar(base)-2, end = nchar(base))
    
    this_ingredient <- str_extract(base, "[^_]+")
    
    saveName <- sprintf(here("data/spatial/plant_diet/int/%s_water_gp_%s.tif"), this_ingredient, this_country)
    
    if(!file.exists(saveName)){
      
      message("processing ", basename(saveName))
      
      this_rast <- rast(this_file)
      
      this_reprojected_rast <- project(this_rast, eq_area_rast)
      
      this_adj_reproj_rast <- this_reprojected_rast*100 #multiply up the footprints from per km2 to total based on 100km2
      
      names(this_adj_reproj_rast) <- "m3"
      
      writeRaster(x = this_adj_reproj_rast, filename = saveName, overwrite = TRUE)
      
      return(this_adj_reproj_rast)
    }
  })



md_reprojected_rasters_h2o <- list.files(path = here("data/spatial/marine_diet/int"), pattern = "water_gp", full=TRUE)
pd_reprojected_rasters_h2o <- list.files(path = here("data/spatial/plant_diet/int"), pattern = "water_gp", full=TRUE)


all_h2o <- c(md_reprojected_rasters_h2o, pd_reprojected_rasters_h2o)

this_file <- all_h2o[[1]]

all_h2o_vals <- unlist(map(.x = all_h2o, .f = \(this_file){
  
  this_rast <- rast(this_file)
  
  these_rast_values <- as.vector(values(this_rast, na.rm=TRUE))
  
  return(these_rast_values)
}))



#determine quantile for rescaling
hist(all_h2o_vals, main = "", xlab = "Water values")
abline(v=quantile(all_h2o_vals, 0.999), lty = 2)


water_rescale_val <- quantile(all_h2o_vals, 0.999) |> as.numeric()





#marine diets - Water

map(.x= md_reprojected_rasters_h2o, .f = \(this_file){
  
  this_rast <- rast(this_file)
  
  this_basename <- str_replace(basename(this_file), pattern = "_gp", replacement = "")
  
  saveName <- sprintf(here("data/spatial/marine_diet/pressures/%s"), this_basename)
  
  if(!file.exists(saveName)){
    
    this_rescaled_rast <- 
      app(x = this_rast, fun = \(x){
        if_else(x<0, true = 0, false = 
                  if_else(x>water_rescale_val, true = 1, false = x/water_rescale_val))})
    
    names(this_rescaled_rast) <- tools::file_path_sans_ext(this_basename)
    
    writeRaster(x = this_rescaled_rast, filename = saveName, overwrite=TRUE)
  }
  
})



#plant diets - water

map(.x= pd_reprojected_rasters_h2o, .f = \(this_file){
  
  this_rast <- rast(this_file)
  
  this_basename <- str_replace(basename(this_file), pattern = "_gp", replacement = "")
  
  saveName <- sprintf(here("data/spatial/plant_diet/pressures/%s"), this_basename)
  
  if(!file.exists(saveName)){
    
    this_rescaled_rast <- 
      app(x = this_rast, fun = \(x){
        if_else(x<0, true = 0, false = 
                  if_else(x>water_rescale_val, true = 1, false = x/water_rescale_val))})
    
    names(this_rescaled_rast) <- tools::file_path_sans_ext(this_basename)
    
    writeRaster(x = this_rescaled_rast, filename = saveName, overwrite=TRUE)
    
  }
  
})




rm(list = ls())


```







