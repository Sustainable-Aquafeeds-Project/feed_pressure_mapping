---
title: "Calculate embodied fish demand in feeds"
output: html_document
---

```{r}
library(tidyverse)
library(here)
library(janitor)
library(countrycode)
library(data.table)
library(dtplyr)
library(raster)
library(terra)
library(sf)
library(jsonlite)
library(ggnewscale)

source(here("src/directories.R"))

select <- dplyr::select
values <- terra::values
```


#FORAGE FISH INGREDIENTS

Now we need to work out how the ingredient demand converts to forage fish biomass. This will depend on species which depends on geographic region. So we need different conversions from different species. First bring in the demand data and the data from Kok et al re embodied fisg depending on species. This also requires the species list for forage fish.
  

```{r}
#bring in total ingredient demand data and isolate fishmeal and oil demand

total_ingredient_demand <- readRDS(here("data/tidy_data/demand/total_ingredient_demand.rds"))

fmfo_demand <- total_ingredient_demand |> filter(grepl("Marine", groups))

rm(total_ingredient_demand)


(embodied_fish_ratios <- read_csv(here("data/raw_data/allocation/embodied_fish_allocation_tidy.csv")) |> 
  filter(common_name != "Gross energy") |> 
  mutate(ecosystem_combined = case_when(grepl("IS|NWS|NS|BS", ecosystem) ~ "North Atlantic",
                                        ecosystem == "HC" ~ "Humboldt",
                                        ecosystem == "GM" ~ "Gulf of Mexico", 
                                        ecosystem == "SO" ~ "Southern Ocean",
                                        ecosystem == "GA" ~ "Other")) |> 
  select(common_name, sci_name, ecosystem_combined, ingredient, ge_value, mass_value) |> 
  mutate(sci_name = case_when(sci_name == "Brevoorti patronus" ~ "Brevoortia patronus",
                              TRUE ~ sci_name)) |> distinct())



#global values for later
globalav_embodiedfish_fm_mass <- embodied_fish_ratios |> filter(common_name == "Global average" & ingredient == "Fishmeal") |> pull(mass_value)
globalav_embodiedfish_fm_ge <- embodied_fish_ratios |> filter(common_name == "Global average" & ingredient == "Fishmeal") |> pull(ge_value)

globalav_embodiedfish_fo_mass <- embodied_fish_ratios |> filter(common_name == "Global average" & ingredient == "Fish oil") |> pull(mass_value)
globalav_embodiedfish_fo_ge <- embodied_fish_ratios |> filter(common_name == "Global average" & ingredient == "Fish oil") |> pull(ge_value)


forage_catch <- readRDS(here("data/raw_data/fisheries/spatial_forage_catch_2017.rds")) |> filter(!grepl("krill", CommonName))

(forage_catch_summary <- forage_catch |> 
  group_by(TaxonName, CommonName) |> 
  summarise(total_catch = sum(total_catch, na.rm=TRUE)) |> 
  arrange(-total_catch) |> 
  left_join(embodied_fish_ratios |> filter(ingredient == "Fishmeal") |> select(-c(ingredient, ecosystem_combined)) |> rename(fishmeal_cf_mass = mass_value, fishmeal_cf_ge = ge_value), by = c("TaxonName" = "sci_name")) |> 
    left_join(embodied_fish_ratios |> filter(ingredient == "Fish oil") |> select(-c(ingredient, ecosystem_combined)) |> rename(fish_oil_cf_mass = mass_value, fish_oil_cf_ge = ge_value), by = c("TaxonName" = "sci_name", "common_name"))
)



#plot forage catch to identify main regions for production. The areas I'm interested in is the Humboldt system, the caribeban coast off latin america, the gulf of mexico, the north atlantic, west africa, the western INdian Ocean (India, Red Sea) the east asia regions
forage_xyz <- forage_catch |> group_by(LonCentre, LatCentre) |> 
  summarise(total_catch = sum(total_catch)) |> 
  #select(LonCentre, LatCentre, total_catch) |> 
  rename(x=LonCentre, y= LatCentre, z = total_catch) 

total_forage_raster <- rast(forage_xyz, type="xyz")

plot(log10(total_forage_raster+1))

sum(values(total_forage_raster), na.rm = TRUE)

#CROP THE FISHING REGIONS BY FAO AREA

fao_areas <- c(77, 67, 87, 21, 31, 41, 27, 37, 34, 47, 51,57, 61, 71, 81) #these fao areas broadly correspond with the area of most interest above

#read in the fao area shapefiles from the FAO json
FAO_regions_shp <- read_sf("https://www.fao.org/fishery/geoserver/fifao/ows?service=WFS&request=GetFeature&version=1.0.0&typeName=fifao:FAO_AREAS_CWP_NOCOASTLINE&outputFormat=json") |> filter(F_LEVEL == "MAJOR") |> 
  mutate(F_AREA = as.numeric(F_AREA)) |> 
  mutate(source_code = case_when(NAME_EN == "Atlantic, Northeast" ~ "NAT",
                                 NAME_EN %in% c("Pacific, Northeast", "Pacific, Eastern Central", "Pacific, Southeast") ~ "EPC",
                                                      TRUE ~ "OTH"))

#check FAO shapefile appears correctly
ggplot()+
  geom_sf(data = FAO_regions_shp, 
          aes(fill = F_AREA))


#get the xyz file for each fao region sand create one data frame to join to the forage catch data by coordinates

fao_xyz_of_interest <- 
  
  map_df(.x = fao_areas, .f = \(this_area){
  
  this_area_shp <- FAO_regions_shp |> filter(F_AREA == this_area)
  
  this_area_raster <- terra::rasterize(x = vect(this_area_shp), y = total_forage_raster, field = this_area_shp$F_AREA)
  
  this_area_xyz <- terra::as.data.frame(x = this_area_raster, xy = TRUE)  |> mutate(area_name = this_area_shp$NAME_EN)
  
  return(this_area_xyz)
  
})

#check the regions
fao_areas_of_interest <- unique(fao_xyz_of_interest$area_name)

#plot the FAO regions used for a supplementary figure
forage_regions_shp <- FAO_regions_shp |> filter(F_AREA %in% fao_areas)
world_shp <- rnaturalearth::ne_countries(scale = 110, returnclass = "sf")
catch_raster <- total_forage_raster |> terra::as.data.frame(xy=TRUE)


ggplot()+
  geom_sf(data = forage_regions_shp |> mutate(f_area = factor(F_AREA)), aes(fill = NAME_EN), colour=NA)+
  geom_sf(data = world_shp, size=NA, fill="grey60")+
  labs(fill = "")+
  scale_fill_manual(values = colorRampPalette(RColorBrewer::brewer.pal(7, name = "Blues"))(length(fao_areas)))+
   theme_void()+
  theme(
        panel.background = element_rect(fill= "white", colour = NA),
        plot.background = element_rect(fill= "white", colour = NA),
        axis.title = element_blank(),
        legend.text = element_text(size=6),
        legend.title = element_text(size=6),
        legend.key.size = unit(0.3, "cm"))+
  new_scale_fill()+
  geom_tile(data = catch_raster, aes(x = x, y = y, fill=(z)))+
  scale_fill_gradientn(colours = RColorBrewer::brewer.pal(9, name = "YlOrRd"))+
  labs(fill = bquote(Catch~(tonnes)))+
   theme_void()+
  theme(
        panel.background = element_rect(fill= "white", colour=NA),
        plot.background = element_rect(fill= "white", colour = NA),
        axis.title = element_blank(),
        legend.text = element_text(size=4),
        legend.title = element_text(size=4),
        legend.key.size = unit(0.2, "cm"))
  
  
ggsave(filename = here("figures/supplementary/fao_regions_catch.jpeg"), device = "jpg", dpi = 300, width = 13, height = 5, units = "cm")


#join FAO area xyz of interest to catch data and  embodied fish factors to get the potential fmfo provisioning by each area
fao_area_production_potential <- 
  forage_catch |> 
  left_join(fao_xyz_of_interest |> rename(fao_area_code = layer, fao_area_name = area_name), 
            by = c("LonCentre" = "x", "LatCentre" = "y")) |> 
  drop_na(fao_area_name) |>
  group_by(fao_area_name) |> 
  summarise(total_catch = sum(total_catch, na.rm=TRUE)) |> 
  mutate(all_catch = sum(total_catch)) |>  # from this Atlantic Northeast, Eastern Pacific (all regions), and "Other" seem like the best options
  mutate(source_code = case_when(fao_area_name == "Atlantic, Northeast" ~ "NAT",
                                 fao_area_name %in% c("Pacific, Northeast", "Pacific, Eastern Central", "Pacific, Southeast") ~ "EPC",
                                                      TRUE ~ "OTH")) |> 
  ungroup()


saveRDS(object = fao_area_production_potential, file = here("data/tidy_data/production-data/fao_regions_forage_production_potential.rds"))



#the new umbrella groups - these catch levels are relatively even as they can be
source_production_potential <- 
  fao_area_production_potential |> 
  group_by(source_code, all_catch) |> 
  summarise(total_catch = sum(total_catch))



#now distribute fishmeal and oil demand by the proportion of catch the species make up in each source region
forage_catch_w_prop_supply <- 
  forage_catch |> 
  left_join(fao_xyz_of_interest |> rename(fao_area_code = layer, fao_area_name = area_name), 
            by = c("LonCentre" = "x", "LatCentre" = "y")) |> 
  drop_na(fao_area_name) |>
  mutate(source_code = case_when(fao_area_name == "Atlantic, Northeast" ~ "NAT",
                                 fao_area_name %in% c("Pacific, Northeast", "Pacific, Eastern Central", "Pacific, Southeast") ~ "EPC",
                                                      TRUE ~ "OTH")) |> 
  group_by(source_code) |> 
  nest() |> 
  mutate(prop_source_catch = map(data, ~(.$total_catch/sum(.$total_catch)))) |> 
  unnest(cols = c(data, prop_source_catch)) |> 
  ungroup() |> 
  left_join(embodied_fish_ratios |> filter(ingredient == "Fishmeal") |> select(-c(ingredient, ecosystem_combined)) |> rename(fishmeal_cf_mass = mass_value, fishmeal_cf_ge = ge_value), by = c("TaxonName" = "sci_name")) |> 
    left_join(embodied_fish_ratios |> filter(ingredient == "Fish oil") |> select(-c(ingredient, ecosystem_combined)) |>  rename(fish_oil_cf_mass = mass_value, fish_oil_cf_ge = ge_value), by = c("TaxonName" = "sci_name", "common_name")) |> 
  mutate(fishmeal_cf_mass = case_when(is.na(common_name) ~ globalav_embodiedfish_fm_mass,
                                 TRUE ~ fishmeal_cf_mass),
         fishmeal_cf_ge = case_when(is.na(common_name) ~ globalav_embodiedfish_fm_ge,
                                 TRUE ~ fishmeal_cf_ge),
         fish_oil_cf_mass = case_when(is.na(common_name) ~ globalav_embodiedfish_fo_mass,
                                 TRUE ~ fish_oil_cf_mass),
         fish_oil_cf_ge = case_when(is.na(common_name) ~ globalav_embodiedfish_fo_ge,
                                 TRUE ~ fish_oil_cf_ge)) |> 
  select(-common_name) 
 


#use the proportions for each region to divide the demand up and work out how the spp_based demand converts to embodied fish

forage_supply_demand_by_diet <- 
  map_df(.x =  c("marine_diet", "plant_diet"), .f = \(this_diet){
    
    this_df <- forage_catch_w_prop_supply |> 
      mutate(diet = this_diet,
             fm_demand = fmfo_demand |> filter(diet == this_diet & ingredients == "fishmeal-wild") |> pull(total_ingredient_demand),
             fo_demand = fmfo_demand |> filter(diet == this_diet & ingredients == "fish oil-wild") |> pull(total_ingredient_demand),
             spp_fm_demand = fm_demand * prop_source_catch,
             spp_fo_demand = fo_demand * prop_source_catch,
             fm_embodied_fish_mass = spp_fm_demand * fishmeal_cf_mass,
             fm_embodied_fish_ge = spp_fm_demand * fishmeal_cf_ge,
             fo_embodied_fish_mass = spp_fo_demand * fish_oil_cf_mass,
             fo_embodied_fish_ge = spp_fo_demand * fish_oil_cf_ge,
             total_embodied_fish_mass = fm_embodied_fish_mass+fo_embodied_fish_mass,
             total_embodied_fish_ge = fm_embodied_fish_ge+fo_embodied_fish_ge) |> 
      mutate(demand_vs_supply_mass = total_embodied_fish_mass/total_catch) |>
      mutate(demand_vs_supply_ge = total_embodied_fish_ge/total_catch) |>
      relocate(diet, .before = source_code)
    
  })
```


Now do some checks on if demand and supply match up per record i.e. by per cell-species-gear combinations. 

```{r}
#check the demand vs supply match up - are there cells where supply is outstripped by demand? 
forage_supply_demand_by_diet |> filter(demand_vs_supply_mass>1) 
forage_supply_demand_by_diet |> filter(demand_vs_supply_ge>1) #lots of rows where demand exceeds supply - more for gross energy than for mass beause gross energy estimates higher embodied fish from oil especially.



nrow(forage_supply_demand_by_diet |> filter(demand_vs_supply_mass>1))/nrow(forage_supply_demand_by_diet) # in 2.8% of catch records demand exceed catch in 2017 with mass allocation
nrow(forage_supply_demand_by_diet |> filter(demand_vs_supply_ge>1))/nrow(forage_supply_demand_by_diet) # in 6.7% of catch records demand exceed catch in 2017 with ge_allocation

forage_supply_demand_by_diet |> filter(demand_vs_supply_mass>1) |> pull(demand_vs_supply_mass) |> unique() #nothing exceeding 1.05 of catch with mass allocation
forage_supply_demand_by_diet |> filter(demand_vs_supply_ge>1) |> pull(demand_vs_supply_ge) |> unique() #nothing exceeding 1.3 of catch with ge allocation


#look at what quantities and proportion demand exceeded supply by
exceedance_check <- 
  forage_supply_demand_by_diet |> 
  mutate(exceedance_mass = case_when(demand_vs_supply_mass>1 ~ total_embodied_fish_mass-total_catch,
                                     TRUE ~ 0)) |>
  mutate(exceedance_ge = case_when(demand_vs_supply_ge>1 ~ total_embodied_fish_ge-total_catch,
                                     TRUE ~ 0)) |>
  mutate(prop_exceedance_mass = case_when(exceedance_mass>0 ~ demand_vs_supply_mass-1,
                                          TRUE ~ 0),
         prop_exceedance_ge = case_when(exceedance_ge>0 ~ demand_vs_supply_ge-1,
                                        TRUE ~ 0))

#what is the maximum exceedance in tonnage in a cell?
(max_exceedance_mass <- exceedance_check |> pull(exceedance_mass) |> max()) #3250 tonnes 
(max_exceedance_ge <- exceedance_check |> pull(exceedance_ge) |> max()) #19387

#but what does the catch look like when max absolute exceedance occurs?
exceedance_check |> filter(exceedance_mass == max_exceedance_mass) # catch is 64000 tonnes when demand exceeds catch by its max 
exceedance_check |> filter(exceedance_ge == max_exceedance_ge) # catch is 64000 tonnes when demand exceeds catch by as much - quite a lot

#what is the maximum proportional exceedance?
(max_prop_exceedance_mass <- exceedance_check |> pull(prop_exceedance_mass) |> max()) #5% for mass allocation
(max_prop_exceedance_ge <- exceedance_check |> pull(prop_exceedance_ge) |> max()) #30% for ge allocation - not great

#what is the catch when proportional exceedance is this high?
exceedance_check |> filter(prop_exceedance_ge == max_prop_exceedance_ge) # catch is typically under 100 tonnes - so 30% is not particularly problematic. We can assume catch per cell is variable.
exceedance_check |> filter(prop_exceedance_mass == max_prop_exceedance_mass) # catch is 117 tonnes at maximum when proportional exceedance is maximised



exceedance_check |> filter(demand_vs_supply_mass>1)
```

Redistribute the demand in cells where it is greater than supply across other cells where there is available deficit. How to allocate can be scaled by the proportion that cell accounts for in terms of the total deficit.  Do this independently for each diet-source combo though, so need to split the data. Need to do for both mass and gross energy allocations.

```{r}

###First redistributing catch across cells based on emodied fish demand using mass allocation


#data list by source and diet
forage_supply_demand_list <- 
  forage_supply_demand_by_diet |> 
  mutate(fm_prop_embodied_fish_mass = fm_embodied_fish_mass/total_embodied_fish_mass) |> 
  mutate(fo_prop_embodied_fish_mass = fo_embodied_fish_mass/total_embodied_fish_mass) |> 
  mutate(fm_prop_embodied_fish_ge = fm_embodied_fish_ge/total_embodied_fish_mass) |> 
  mutate(fo_prop_embodied_fish_ge = fo_embodied_fish_ge/total_embodied_fish_mass) |> 
  relocate(diet, .before = source_code) |> 
  group_split(diet, source_code)

#for testing function below
this_df <-  forage_supply_demand_list[[1]]

forage_supply_demand_redistributed_mass <- 
  
  map_df(.x = forage_supply_demand_list, .f = \(this_df){
    
    #Identify cells with exceedance or deficit for mass allocation methods
    exceed_supply_mass <- this_df |> filter(demand_vs_supply_mass>1)
    below_supply_mass <- this_df |> filter(demand_vs_supply_mass<=1)
    
    
    this_diet_source <-  paste0(unique(this_df$diet),"_",unique(this_df$source_code))
    
   
    
    if(nrow(exceed_supply_mass)>0){
      
      #which diet are we working on?
      message(this_diet_source)
      
      exceed_supply_mass2 <-  exceed_supply_mass |>
        mutate(exceedance_mass = total_embodied_fish_mass-total_catch)
      
      total_exceedance_mass <- sum(exceed_supply_mass2$exceedance_mass)
      total_deficit_mass <- below_supply_mass |> mutate(exceedance_mass = total_embodied_fish_mass-total_catch) |> pull(exceedance_mass) |> sum()
      
      message("Total deficit is greater than total exceedance with mass allocation? ", abs(total_deficit_mass)>total_exceedance_mass)
      
      below_supply_mass2 <- below_supply_mass |> 
        mutate(exceedance_mass = total_embodied_fish_mass-total_catch) |> 
        mutate(prop_exceedance_mass = exceedance_mass/sum(exceedance_mass)) |> 
        mutate(added_embodied_fish_mass = prop_exceedance_mass * total_exceedance_mass) |> 
        mutate(adj_embodied_fish_mass = total_embodied_fish_mass+added_embodied_fish_mass)
      
      message("Total biomass from exceedance cells is equal to that added to deficit cells = ", round(sum(below_supply_mass2$added_embodied_fish_mass), digits = 0 )==round(total_exceedance_mass, digits = 0))
      
      exceed_supply_mass3 <-  exceed_supply_mass2 |> 
        mutate(prop_exceedance_mass = NA) |> 
        mutate(added_embodied_fish_mass = NA) |> 
        mutate(adj_embodied_fish_mass = total_embodied_fish_mass-exceedance_mass)
      
      diff_after_adjustment_mass <- sum(exceed_supply_mass3$total_embodied_fish_mass)-sum(exceed_supply_mass3$adj_embodied_fish_mass)
      
      message("Total biomass removed from exceedance cells is equal to the difference between the original and adjusted embodied fish = ", round(diff_after_adjustment_mass, digits = 3)==round(total_exceedance_mass, digits = 3))
      
      
      message("Returns same number of rows as original df? ",  (nrow(exceed_supply_mass3)+nrow(below_supply_mass2))==nrow(this_df))
      
      
      this_df_adj_mass <- bind_rows(below_supply_mass2, exceed_supply_mass3)

      return(this_df_adj_mass)
      
    } else{
      
      this_df_mass <- this_df |> 
        mutate(exceedance_mass = 0) |> 
        mutate(prop_exceedance_mass = 0) |> 
        mutate(added_embodied_fish_mass = 0) |> 
        mutate(adj_embodied_fish_mass = total_embodied_fish_mass) 
      
      return(this_df_mass)
      
    }
    
  })




###########
#Now redistribute based on gross energy allocation


forage_supply_demand_redistributed_mass_list <- 
  forage_supply_demand_redistributed_mass |> 
  group_split(diet, source_code)


this_df <- forage_supply_demand_redistributed_mass_list[[1]]


forage_supply_demand_redistributed_mass_ge <- 
  
  map_df(.x = forage_supply_demand_redistributed_mass_list, .f = \(this_df){
    
    #Identify cells with exceedance or deficit for mass allocation methods
    exceed_supply_ge <- this_df |> filter(demand_vs_supply_ge>1)
    below_supply_ge <- this_df |> filter(demand_vs_supply_ge<=1)
 
    
    this_diet_source <-  paste0(unique(this_df$diet),"_",unique(this_df$source_code))
    
   
    
    if(nrow(exceed_supply_ge)>0){
      
      #which diet are we working on?
      message(this_diet_source)
      
      exceed_supply_ge2 <-  exceed_supply_ge |>
        mutate(exceedance_ge = total_embodied_fish_ge-total_catch)
      
      total_exceedance_ge <- sum(exceed_supply_ge2$exceedance_ge)
      total_deficit_ge <- below_supply_ge |> mutate(exceedance_ge = total_embodied_fish_ge-total_catch) |> pull(exceedance_ge) |> sum()
      
      message("Total deficit is greater than total exceedance with gross energy allocation? ", abs(total_deficit_ge)>total_exceedance_ge)
      #this is false for EPC with the marine diet. So gross energy allocation estimates an embodied biomass from global salmon demand greater than was caught in 2017. 
      #Will expand on this in the methods/discussion.
      
      below_supply_ge2 <- below_supply_ge |> 
        mutate(exceedance_ge = total_embodied_fish_ge-total_catch) |> 
        mutate(prop_exceedance_ge = exceedance_ge/sum(exceedance_ge)) |> 
        mutate(added_embodied_fish_ge = prop_exceedance_ge * total_exceedance_ge) |> 
        mutate(adj_embodied_fish_ge = total_embodied_fish_ge+added_embodied_fish_ge)
      
      message("Total biomass from exceedance cells is equal to that added to deficit cells = ", round(sum(below_supply_ge2$added_embodied_fish_ge), digits = 0 )==round(total_exceedance_ge, digits = 0))
      
      exceed_supply_ge3 <-  exceed_supply_ge2 |> 
        mutate(prop_exceedance_ge = NA) |> 
        mutate(added_embodied_fish_ge = NA) |> 
        mutate(adj_embodied_fish_ge = total_embodied_fish_ge-exceedance_ge)
      
      diff_after_adjustment_ge <- sum(exceed_supply_ge3$total_embodied_fish_ge)-sum(exceed_supply_ge3$adj_embodied_fish_ge)
      
      message("Total biomass removed from exceedance cells is equal to the difference between the original and adjusted embodied fish = ", round(diff_after_adjustment_ge, digits = 3)==round(total_exceedance_ge, digits = 3))
      
      
      message("Returns same number of rows as original df? ",  (nrow(exceed_supply_ge3)+nrow(below_supply_ge2))==nrow(this_df))
      
      
      this_df_adj_ge <- bind_rows(below_supply_ge2, exceed_supply_ge3)

      return(this_df_adj_ge)
      
    } else{
      
      this_df_ge <- this_df |> 
        mutate(exceedance_ge = 0) |> 
        mutate(prop_exceedance_ge = 0) |> 
        mutate(added_embodied_fish_ge = 0) |> 
        mutate(adj_embodied_fish_ge = total_embodied_fish_ge) 
      
      return(this_df_ge)
      
    }
    
  })

forage_supply_demand_redistributed_fmfo <- 
  forage_supply_demand_redistributed_mass_ge |> 
  mutate(embodied_fish_adj_fm_mass = fm_prop_embodied_fish_mass*adj_embodied_fish_mass,
         embodied_fish_adj_fo_mass = fo_prop_embodied_fish_mass*adj_embodied_fish_mass,
         embodied_fish_adj_fm_ge = fm_prop_embodied_fish_ge*adj_embodied_fish_ge,
         embodied_fish_adj_fo_ge = fo_prop_embodied_fish_ge*adj_embodied_fish_ge)


fwrite(forage_supply_demand_redistributed_fmfo, file = here("data/tidy_data/demand/embodied_fish_per_cell.csv"))



# Do some checks on the data

message("Same number of rows with original and redistributed data? ", nrow(forage_supply_demand_by_diet)==nrow(forage_supply_demand_redistributed_mass_ge))

message("Using mass allocation, the original embodied fish tonnage across all diets is ", sum(forage_supply_demand_by_diet$total_embodied_fish_mass), ", and with redistribution is ", sum(forage_supply_demand_redistributed_mass$adj_embodied_fish_mass, na.rm = TRUE))
message("Is embodied tonnage equal after redistribution? ", round(sum(forage_supply_demand_by_diet$total_embodied_fish_mass)) == round(sum(forage_supply_demand_redistributed_mass$adj_embodied_fish_mass, na.rm = TRUE)))


message("Using gross energy allocation, the original embodied fish tonnage across all diets is ", sum(forage_supply_demand_by_diet$total_embodied_fish_ge), ", and with redistribution is ", sum(forage_supply_demand_redistributed_mass_ge$adj_embodied_fish_ge, na.rm = TRUE))
message("Is embodied tonnage equal after redistribution? ", round(sum(forage_supply_demand_by_diet$total_embodied_fish_ge)) == round(sum(forage_supply_demand_redistributed_mass_ge$adj_embodied_fish_ge, na.rm = TRUE)))



#check no distribution has happened across diets

message("Are marine diet totals for all locations the same as original data under mass allocation? ", forage_supply_demand_by_diet |> filter(diet=="marine_diet") |> pull(total_embodied_fish_mass) |> sum() == forage_supply_demand_redistributed_mass_ge |> filter(diet=="marine_diet") |> pull(adj_embodied_fish_mass) |> sum())
message("Are marine diet totals for all locations the same as original data under gross energy allocation? ", forage_supply_demand_by_diet |> filter(diet=="marine_diet") |> pull(total_embodied_fish_ge) |> sum() |> round() == forage_supply_demand_redistributed_mass_ge |> filter(diet=="marine_diet") |> pull(adj_embodied_fish_ge) |> sum() |> round())



#check plant diet 
message("Are plant diet totals for all locations the same as original data under mass allocation? ", forage_supply_demand_by_diet |> filter(diet=="plant_diet") |> pull(total_embodied_fish_mass) |> sum() == forage_supply_demand_redistributed_mass_ge |> filter(diet=="plant_diet") |> pull(adj_embodied_fish_mass) |> sum())
message("Are plant diet totals for all locations the same as original data under gross energy allocation? ", forage_supply_demand_by_diet |> filter(diet=="plant_diet") |> pull(total_embodied_fish_ge) |> sum() |> round() == forage_supply_demand_redistributed_mass_ge |> filter(diet=="plant_diet") |> pull(adj_embodied_fish_ge) |> sum() |> round())




embodied_fish_demand_by_diet_source <- 
  forage_supply_demand_redistributed_mass_ge |> 
  group_split(diet, source_code) |> 
  map_df(\(this_df){
    
    return(tibble(diet = unique(this_df$diet), source_code = unique(this_df$source_code), embodied_fish_demand_mass = sum(this_df$adj_embodied_fish_mass), embodied_fish_demand_ge = sum(this_df$adj_embodied_fish_ge)))
    
  })

saveRDS(object = embodied_fish_demand_by_diet_source, file = here("data/tidy_data/demand/embodied_fish_demand_by_source_diet.rds"))




#For the East Pacific, supply falls short of demand based on catch for the marine diet using gross energy allocation - look into this here

marine_EPC_checks <- 
  forage_supply_demand_redistributed_mass_ge |> filter(diet == "marine_diet" & source_code == "EPC") |> #78,466 rows 
  mutate(adj_demand_vs_supply = adj_embodied_fish_ge/total_catch) |> 
  filter(adj_demand_vs_supply >1) |> #51300 rows have exceedance (most)
  mutate(actual_exceedance_adj = adj_embodied_fish_ge-total_catch) |> 
  mutate(prop_exceedance_adj = actual_exceedance_adj/total_catch)

(max_exceedance <- max(marine_EPC_checks$actual_exceedance_adj)) #can exceed 2017 catch levels by 2073 tonnes
(max_prop_exceedance_adj <- max(marine_EPC_checks$prop_exceedance_adj)) #max proportional exceedance is 21% 

#Where it exceeds by the max value in tonnes, this is a 23% increase
median(marine_EPC_checks$actual_exceedance_adj) #median tonnage exceedance 0.067 tonnes
median(marine_EPC_checks$prop_exceedance_adj) #median proportional exceedance is 19.6% - so cells with low catch is where exceedance still occurs

# 2 tonnes exceeded at the 90th percentile.

sequence <- c(seq(from = 0.25, 0.99, by =0.05), 0.96,0.97,0.98, 0.99, 0.999)
exceedance_list <- vector(length = length(sequence))

for(i in 1:length(sequence)){
  exceedance_list[[i]] <- quantile(marine_EPC_checks$actual_exceedance_adj,sequence[i])
}

#Given the variability of forage fish population biomass, for most catch (95% and 98% respectively) to be within 7 tonnes and 70 tonnes of 2017 catch and at no point exceeded 25% of that years catch, this seems reasonable. No exceedance over 100 tonnes until the 99.9th percentile.

ggplot(data = tibble(percentile = sequence, exceedance_tonnes = exceedance_list))+
  aes(x = percentile, y = exceedance_tonnes)+
  geom_point()+
  theme_bw()+
  labs(x = "Percentile", y= "Exceedance (tonnes)")+
  theme(text = element_text(size=8))


ggsave(filename = here("figures/supplementary/cell_catch_exceedance_for_marinediet_EPC.jpg"), dpi=600, width = 9, height = 6, units = "cm")


```
  
Create an FMFO embodied fish demand by source and ingredient

```{r}
embodied_fish_by_dietsource <- readRDS(file = here("data/tidy_data/demand/embodied_fish_demand_by_source_diet.rds"))

embodied_fish_by_dietsource |> 
  pivot_longer(names_to = "allocation_method", values_to = "embodied_fish_demand", cols = -c(diet, source_code)) |> 
  mutate(allocation_method = case_when(allocation_method == "embodied_fish_demand_mass" ~ "Mass allocation",
                                       TRUE ~ "Gross energy allocation")) |> 
  ggplot()+
  aes(x = diet, y = embodied_fish_demand/1000, fill = source_code)+
  geom_bar(stat= "identity", position = "dodge")+
  labs(fill = "Source", y = "Embodied fish demand (1000s T)")+
  scale_fill_manual(values = c("#edf8b1", "#7fcdbb", "#2c7fb8"))+
  theme_bw()+
  facet_wrap(~allocation_method, scales = "fixed")+
  theme(legend.position = c(0.8, 0.8),
        legend.background = element_rect(fill="transparent"), 
        axis.title.x = element_blank(),
        panel.grid = element_blank(), 
        text = element_text(size=12),
        legend.text = element_text(size = 10))


ggsave(filename = here("figures/presos/embodied_forage_fish_demand.jpg"), device="jpg", dpi = 600, width = 10, height = 10, units="cm")

```

