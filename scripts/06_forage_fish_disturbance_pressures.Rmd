---
title: "Spatial Allocation of Forage fish demand from each diet and source"
output: html_document
---

# Overall approach

The disturbance metric established in Halpern et al is composed of two elements:

- Benthic destruction - hours of fishing effort from bottom trawlers and dredgers to catch forage fish species
- Biomass removal i.e. the appropriated portion net primary productivity

We need to calculate this separately for fishmeal and oil as we are interested in the allocation of pressures to ingredients
  
```{r, setup}

library(tidyverse)
library(here)
library(terra)
library(sf)
library(data.table)
library(dtplyr)
library(future)
library(furrr)
library(doParallel)
library(rfishbase)

source(here("src/directories.R"))
source(here("src/spatial.R"))

select <- dplyr::select

# Uncomment for when RDSI is down
watson_dir <- watson_backup_dir

```


Equal area projection resources
```{r}

gall_peters <- "+proj=cea +lon_0=0 +x_0=0 +y_0=0 +lat_ts=45 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"
#raster template 
base_rast <- rast(res=0.5)
ext(base_rast) <- c(-180, 180, -90, 90)

eq_area_rast <- project(base_rast, gall_peters, res=10000) 
values(eq_area_rast) <- 1:ncell(eq_area_rast)

```


MARINE FOOTPRINT

Forage fish - first lets get the latin names of the forage fish from the filtered catch data and find the trophic levels of them.


```{r}

cell_area <- terra::as.data.frame(cellSize(rast(res=0.5), unit="km"), xy=TRUE) |> rename(LonCentre = x, LatCentre = y)

```



Import net primary productivity data
```{r}

#make npp into an xy file

npp <- rast(here("data/spatial/00-net-primary-productivity/annal_mean_npp_2015_gf_wgs.tif"))

npp_xyz <- terra::as.data.frame(npp, xy = TRUE) |> 
  rename(npp=annal_mean_npp_2015_gf_wgs) |> 
  rename(LonCentre = x, 
         LatCentre = y,
         npp_mg_m2_day = npp) |> 
  mutate(npp_t_km2_yr = npp_mg_m2_day*0.001*365) |> 
select(-npp_mg_m2_day)


```

Import ecosystem transfer-efficiency

```{r}

ecosystem_te <- read_csv("/Users/rsc2/OneDrive - University of Tasmania/ARC Linkage - Optimising aquafeeds/rdsi/raw_data/cashion/ecosystem_te.csv") |> select(TE, fao_area_code) |> group_by(fao_area_code) |> summarise(te=mean(TE, na.rm = TRUE)) |> mutate(te= te/100)


```


Get forage fish trophic levels

```{r}

#Separate the catch records that have Genus and species.
forage_spp <- readRDS(here("data/large_data/spatial_forage_catch_2017.rds")) |> 
  mutate(binomial = stringi::stri_count(TaxonName, regex="\\S+")) |> 
  filter(binomial==2) |>  
  pull(TaxonName) |> 
  unique() 

this_sp <- forage_spp[[1]]


(binomial_tls <- rfishbase::ecology(species_list =  forage_spp, server = getOption("fishbase")) |>
  select(Species, DietTroph, FoodTroph) |> 
  mutate(DietTroph = if_else(is.na(DietTroph), true = FoodTroph, false = DietTroph)) |> 
  drop_na(DietTroph) |> 
  select(-FoodTroph) |> 
  distinct()) #both extracted manually from fishbase as not coming up from app search

  
#Add back the Genus only or family records and match to any species with the same Genus

(forage_higherorder <- readRDS(here("data/large_data/spatial_forage_catch_2017.rds")) |> mutate(binomial = stringi::stri_count(TaxonName, regex="\\S+")) |> filter(binomial==1) |>  pull(TaxonName) |> unique()
)

forage_nonbinomial_tls <- tibble(TaxonName = forage_higherorder, DietTroph = NA) |> 
  mutate(DietTroph = case_when(TaxonName %in% 
                                 c("Engraulidae", "Clupeiformes", "Stolephorus") ~ binomial_tls |> 
                                 filter(grepl("Engraulis",Species)) |> 
                                 pull(DietTroph) |> 
                                 mean(),
                               TaxonName %in% c("Scomber") ~ binomial_tls |> 
                                 filter(grepl("Scomber", Species)) |> 
                                 pull(DietTroph) |> 
                                 mean(),
                               TaxonName %in% c("Sardinella") ~ binomial_tls |> 
                                 filter(grepl("Sardinella", Species)) |> 
                                 pull(DietTroph) |> 
                                 mean(),
                               TaxonName %in% c("Rastrelliger") ~ binomial_tls |> 
                                 filter(grepl("Rastrelliger", Species)) |> 
                                 pull(DietTroph) |> 
                                 mean(),
                               TaxonName %in% c("Trachurus") ~ binomial_tls |> 
                                 filter(grepl("Trachurus", Species)) |> 
                                 pull(DietTroph) |> 
                                 mean(),
                               TaxonName %in% c("Harengula", "Clupeidae", "Clupeoids") ~ binomial_tls |> 
                                 filter(grepl("Clupea", Species)) |> 
                                 pull(DietTroph),
                               TaxonName %in% c("Atherinidae") ~ binomial_tls |> 
                                 pull(DietTroph) |> 
                                 mean())) |> 
  add_row(TaxonName = "Euphausia superba", DietTroph = 2.25) |> 
    add_row(TaxonName = "Clupea pallasii pallasii", DietTroph = 3.16)
                               
                               
                               
forage_tls <- 
  bind_rows(binomial_tls |> rename(TaxonName = Species),
          forage_nonbinomial_tls)

```


Get trimmings species trophic levels


```{r}

#Separate the catch records that have Genus and species.
(trim_spp <- readRDS(here("data/large_data/trimmings_spp_catch.rds")) |> mutate(binomial = stringi::stri_count(TaxonName, regex="\\S+")) |> filter(binomial==2) |> pull(TaxonName) |> unique() )


this_sp <- forage_spp[[1]]


(trimmings_binomial_tls <- rfishbase::ecology(species_list =  trim_spp, server = getOption("fishbase")) |> 
  select(Species, DietTroph, FoodTroph) |> 
  mutate(DietTroph = if_else(is.na(DietTroph), true = FoodTroph, false = DietTroph)) |>
  select(-FoodTroph) |> 
  mutate(DietTroph = case_when(Species == "Engraulis capensis" ~ mean(c(3.14,3.12,2.51)), #mean of otehr Engraulis values
                               TRUE ~ DietTroph)) |> 
  distinct() |> 
  drop_na(DietTroph))

  
#Add back the Genus only or family records and match to any species with the same Genus

(trim_higherorder <- readRDS(here("data/large_data/trimmings_spp_catch.rds")) |> mutate(binomial = stringi::stri_count(TaxonName, regex="\\S+")) |> filter(binomial==1) |>  pull(TaxonName) |> unique()
)

trim_nonbinomial_tls <- tibble(TaxonName = trim_higherorder, DietTroph = NA) |> 
  mutate(DietTroph = case_when(TaxonName %in% 
                                 c("Engraulidae") ~ trimmings_binomial_tls |>
                                 filter(grepl("Engraulis",Species)) |> 
                                 pull(DietTroph) |> 
                                 mean(),
                               TaxonName %in% c("Sardinella") ~ trimmings_binomial_tls |> 
                                 filter(grepl("Sardinella", Species)) |> 
                                 pull(DietTroph) |> 
                                 mean(),
                               TaxonName %in% c("Clupeidae") ~ trimmings_binomial_tls |> 
                                 filter(grepl("Clup", Species)) |> 
                                 pull(DietTroph) |> 
                                 mean(),
                               TaxonName %in% c("Thunnus") ~ trimmings_binomial_tls |> 
                                 filter(grepl("Thunnus", Species)) |> 
                                 pull(DietTroph) |> 
                                 mean()))
                               
                               
                               
trim_tls <- 
  bind_rows(trimmings_binomial_tls |> rename(TaxonName = Species),
          trim_nonbinomial_tls)


```



Attach NPP data to forage and trimmings catch data

```{r}

carbon_conversion <- 9

(forage_npp <- 
    fread(here("data/large_data/embodied_foragefish_per_cell.csv")) |> 
    left_join(ecosystem_te, by="fao_area_code") |> 
    left_join(forage_tls, by = "TaxonName") |>
    mutate(te = case_when(is.na(te) ~ ecosystem_te |> pull(te) |> mean(),
                          TRUE ~ te)) |> 
    left_join(npp_xyz) |> 
    left_join(cell_area) |> 
    mutate(npp_t_C_yr = npp_t_km2_yr*area) |> 
    mutate(ppr_fm_mass = (fm_embodied_fish_mass/carbon_conversion)*(1/te)^(DietTroph-1), #T C yr-1
           ppr_fo_mass = (fo_embodied_fish_mass/carbon_conversion)*(1/te)^(DietTroph-1),
           ppr_fm_ge = (fm_embodied_fish_ge/carbon_conversion)*(1/te)^(DietTroph-1),
           ppr_fo_ge = (fo_embodied_fish_ge/carbon_conversion)*(1/te)^(DietTroph-1)) |> 
   arrange(LonCentre, LatCentre) |> 
    group_by(diet, fao_area_code, LonCentre, LatCentre) |> 
    summarise(npp_t_C_yr = mean(npp_t_C_yr),
              ppr_fm_mass = sum(ppr_fm_mass),
              ppr_fo_mass = sum(ppr_fo_mass),
              ppr_fm_ge = sum(ppr_fm_ge),
              ppr_fo_ge = sum(ppr_fo_ge)) |> 
    ungroup() |> 
     mutate(ppr_prop_fm_mass = ppr_fm_mass/npp_t_C_yr,
           ppr_prop_fo_mass = ppr_fo_mass/npp_t_C_yr,
           ppr_prop_fm_ge = ppr_fm_ge/npp_t_C_yr,
           ppr_prop_fo_ge = ppr_fo_ge/npp_t_C_yr) |> 
    arrange(LonCentre, LatCentre)
)


(trim_npp <- 
  fread(here("data/large_data/embodied_fishfromtrimmings_per_cell.csv")) |> 
  left_join(ecosystem_te, by="fao_area_code") |> 
  left_join(trim_tls, by = "TaxonName") |>
  mutate(te = case_when(is.na(te) ~ ecosystem_te |> pull(te) |> mean(),
                        TRUE ~ te)) |> 
  left_join(npp_xyz) |> #mg C day 
   left_join(cell_area) |> 
  mutate(npp_t_C_yr = npp_t_km2_yr*area) |> 
  mutate(ppr_fm_mass = (fm_embodied_fish_mass/carbon_conversion)*(1/te)^(DietTroph-1), #T C yr-1
         ppr_fo_mass = (fo_embodied_fish_mass/carbon_conversion)*(1/te)^(DietTroph-1),
         ppr_fm_ge = (fm_embodied_fish_ge/carbon_conversion)*(1/te)^(DietTroph-1),
         ppr_fo_ge = (fo_embodied_fish_ge/carbon_conversion)*(1/te)^(DietTroph-1)) |>
    arrange(LonCentre, LatCentre) |> 
    group_by(diet, fao_area_code, LonCentre, LatCentre) |> 
    summarise(npp_t_C_yr = mean(npp_t_C_yr),
              ppr_fm_mass = sum(ppr_fm_mass),
              ppr_fo_mass = sum(ppr_fo_mass),
              ppr_fm_ge = sum(ppr_fm_ge),
              ppr_fo_ge = sum(ppr_fo_ge)) |> 
    ungroup() |> 
  mutate(ppr_prop_fm_mass = ppr_fm_mass/npp_t_C_yr,
         ppr_prop_fo_mass = ppr_fo_mass/npp_t_C_yr,
         ppr_prop_fm_ge = ppr_fm_ge/npp_t_C_yr,
         ppr_prop_fo_ge = ppr_fo_ge/npp_t_C_yr) |> 
    arrange(LonCentre, LatCentre))



#Bind the forage and trimmings catch npp per cell

all_fish_npp <- 
  bind_rows(forage_npp |> select(diet, fao_area_code,LonCentre, LatCentre,npp_t_C_yr,
                                 ppr_prop_fm_mass, ppr_prop_fo_mass, ppr_prop_fm_ge, ppr_prop_fo_ge),
            trim_npp |> select(diet, fao_area_code,LonCentre, LatCentre,npp_t_C_yr,
                                 ppr_prop_fm_mass, ppr_prop_fo_mass, ppr_prop_fm_ge, ppr_prop_fo_ge))



all_fish_npp |> filter(fao_area_code == 61)



all_fish_npp |> filter(fao_area_code==61)


```


Now calculate the km2 equivalent for each diet and fao_area code for both fishmeal and oil

```{r}

# Split the dataframe by diet and fao area
all_fish_npp_list <- 
  all_fish_npp |> 
  group_by(diet, fao_area_code) |> 
  group_split()


this_diet_fao_area <- all_fish_npp_list[[4]]


#spit out the disturbance rasters for fo and fm under both mass and energetic allocation

map(.x = all_fish_npp_list, .f = \(this_diet_fao_area){
  
  this_diet <- this_diet_fao_area |> pull(diet) |> unique()
  
  this_fao_area_code <- this_diet_fao_area |> pull(fao_area_code) |> unique()
  
  
  # FISHMEAL DISTRUBANCE  - MASS ALLOCATION
  
  message("Processing fishmeal disturbance raster - mass allocation")
  
  fm_mass_saveName <- sprintf(here("data/spatial/%s/int/fishmeal_disturbance_km2_mass_allocation_%s.tif"), this_diet, this_fao_area_code)
  
  fm_prop_npp_mass_rast <- this_diet_fao_area |> 
    select(LonCentre, LatCentre, ppr_prop_fm_mass) |> 
    rast(type = "xyz") |> 
    resample(rast(res=0.5))
  
  #calculate area in km2
  fm_km2_mass_rast <- fm_prop_npp_mass_rast*cellSize(fm_prop_npp_mass_rast, unit="km")
  
  writeRaster(x= fm_km2_mass_rast, filename = fm_mass_saveName, overwrite=TRUE)
  
  
  # FISH OIL DISTURBANCE - MASS ALLOCATION
  
  message("Processing fish oil disturbance raster - mass allocation")
  
  fo_mass_saveName <- sprintf(here("data/spatial/%s/int/fish oil_disturbance_km2_mass_allocation_%s.tif"), this_diet, this_fao_area_code)
  
  fo_prop_npp_mass_rast <- this_diet_fao_area |> 
    select(LonCentre, LatCentre, ppr_prop_fo_mass) |> 
    rast(type = "xyz") |> 
    resample(rast(res=0.5))
  
  #calculate area in km2
  fo_km2_mass_rast <- fo_prop_npp_mass_rast*cellSize(fo_prop_npp_mass_rast, unit="km")
  
  writeRaster(x= fo_km2_mass_rast, filename = fo_mass_saveName, overwrite=TRUE)
  

  # FISHMEAL DISTURBANCE - ENERGETIC ALLOCATION
  
  message("Processing fishmeal disturbance raster - energetic allocation")
  
  fm_ge_saveName <- sprintf(here("data/spatial/%s/int/fishmeal_disturbance_km2_ge_allocation_%s.tif"), this_diet, this_fao_area_code)
  
  fm_prop_npp_ge_rast <- this_diet_fao_area |> 
    select(LonCentre, LatCentre, ppr_prop_fm_ge) |> 
    rast(type = "xyz") |> 
    resample(rast(res=0.5))
  
  #calculate area in km2
  fm_km2_ge_rast <- fm_prop_npp_ge_rast*cellSize(fm_prop_npp_ge_rast, unit="km")
  
  writeRaster(x= fm_km2_ge_rast, filename = fm_ge_saveName, overwrite=TRUE)
  
  
  # FISH OIL DISTURBANCE - ENERGETIC ALLOCATION
  
  message("Processing fishmeal disturbance raster - energetic allocation")
  
  fo_ge_saveName <- sprintf(here("data/spatial/%s/int/fish oil_disturbance_km2_ge_allocation_%s.tif"), this_diet, this_fao_area_code)
  
  fo_prop_npp_ge_rast <- this_diet_fao_area |> 
    select(LonCentre, LatCentre, ppr_prop_fm_ge) |> 
    rast(type = "xyz") |> 
    resample(rast(res=0.5))
  
  #calculate area in km2
  fo_km2_ge_rast <- fo_prop_npp_ge_rast*cellSize(fo_prop_npp_ge_rast, unit="km")
  
  writeRaster(x= fo_km2_ge_rast, filename = fo_ge_saveName, overwrite=TRUE)
  
})






```















## Benthic destruction


To understand the benthic component of disturbance, we need to know if there are any destrcutive fishing gears associated withe forage fish catch or catch that generates trimmings. 

Here we also join the gear classification data from Halpern et al of destructive or non destructive/ pelagic or demersal to the catch data which helps with the next step of isolating all trawling and dredging, and the trawling and dredging that forage fish represent.

```{r}

#create the list of gear relevant to the forage fish catch data

forage_gears <- readRDS(here("data/large_data/spatial_forage_catch_2017.rds")) |> 
  select(Gear, VBDesc) |> distinct() 

write_csv(x = forage_gears, file = here("data/raw_data/fisheries/forage_gears.csv"))



#create the list of gear relevant to the forage fish catch data

trim_gears <- readRDS(here("data/large_data/trimmings_spp_catch.rds")) |> 
  select(Gear, VBDesc) |> distinct() 

write_csv(x = trim_gears, file = here("data/raw_data/fisheries/trim_gears.csv"))




#join the categories from Halpern et al to the gears relevant for forage fish only

gears_to_cat <- read_csv(here("data/raw_data/fisheries/gears_to_cat.csv"))

forage_gear_cats <- forage_gears |> left_join(gears_to_cat, by = c("Gear", "VBDesc"))




#assign categories to existing classification of pelagic or demersal
forage_catch_w_cats <- 
  readRDS(here("data/large_data/spatial_forage_catch_2017.rds")) |> 
  left_join(forage_gear_cats, by = c("Gear", "VBDesc")) |> 
  mutate(type = case_when(grepl("pelagic|krill", Descript) ~ "pelagic",
                          grepl("benthopelagic|demersal", Descript) ~ "demersal"))
  

saveRDS(object = forage_catch_w_cats, file = here("data/raw_data/fisheries/spatial_forage_catch_2017_w_cats.rds"))

#some checks throughout
unique(forage_catch_w_cats$Descript)
forage_catch_w_cats |> filter(Descript == "krill") |> pull(VBDesc) |> unique()
forage_catch_w_cats |> filter(is.na(type))# no NA values
forage_catch_w_cats |> filter(is.na(bycatch)) #no na values







```


We  have effort rasters for all fishing for destructive gears (trawling and dredge) but we need to know how much of that forage fish represent in each cell for each demand scenario in each diet.

To do this we need to know what proportion of all trawling (the resolution in the GW dataset) is bottom trawling for forage fish species represented in each diet and sourcing scenario:

- Create catch rasters for all trawling 
- Create rasters for all bottom trawling and dredging for forage fish species.
- Multiply the proportion of of bottom trawling or dredging from forage fish species

So first lets create catch rasters for all trawling.

```{r}
total_catch <- fread(file.path(watson_dir, "v5.0/watson_2017_fisheries_catch.csv"))


gears_to_cat <- read_csv(here("data/raw_data/fisheries/gears_to_cat.csv")) |> mutate(bycatch = if_else(is.na(bycatch), true = "low", false = bycatch))

#join the gear categories to the fisheries catch to isolate trawling

total_catch_w_cat <- total_catch |> 
  lazy_dt(immutable = FALSE) |> 
  left_join(gears_to_cat, by = c("Gear", "VBDesc"))  |>  
  mutate(type = case_when(grepl("pelagic|krill", Descript) ~ "pelagic",
                          grepl("benthopelagic|demersal", Descript) ~ "demersal")) |> 
  as.data.table()

#this could be useful so save for later  
fwrite(x = total_catch_w_cat, file =  file.path(watson_dir, "v5.0/watson_2017_fisheries_catch_w_cat.csv"))

#Now create some rasters of the proportion of trawling that is bottom trawling and non-hand dredging to allow us to get a raster of bottom trawling in effort

#First we need to know what the types of trawl and dredge are in teh fisheries data
trawl_types <- unique(total_catch_w_cat$VBDesc)[grep("trawl", unique(total_catch_w_cat$VBDesc))]
dredge_types <- unique(total_catch_w_cat$VBDesc)[grep("dredg", unique(total_catch_w_cat$VBDesc))]


#isolate data for all bottom trawling

all_trawl_fishing <- 
  total_catch |>
  lazy_dt(immutable = FALSE) |> 
  filter(VBDesc == "bottom trawls") |> 
  group_by(LonCentre, LatCentre) |> 
  summarise(total_catch = sum(ReportedNIND+ReportedIND+IUUIND+IUUNIND, na.rm = TRUE)) |> 
  drop_na(LonCentre, LatCentre) |> 
  as.data.frame()


all_trawl_r <- rast(all_trawl_fishing, type = "xyz", crs = "EPSG:4326")
writeRaster(x = all_trawl_r, filename = here("data/spatial/fisheries-effort/all_trawling_catch.tif"), overwrite=TRUE)

```

Next step is to understand  what proportion of all trawling the forage catch needed for each deamnd scenario represents so we can convert it into hours of effort for each diet/sourcing combination. So first we can prep the embodied forage fish demand per cell into raster form for the trawling component.
 
First we'll isolate which gears are destructive for forage fish.
```{r}
#create the list of gear relevant to the forage fish catch data

forage_gears <- fread(here("data/tidy_data/demand/embodied_fish_per_cell.csv")) |> 
  lazy_dt(immutable = FALSE) |> 
  select(Gear, VBDesc) |> 
  distinct() |> 
  as_tibble()

write_csv(x = forage_gears, file = here("data/raw_data/fisheries/forage_gears.csv"))

#join the categories from Halpern et al to the gears relevant for forage fish only

gears_to_cat <- read_csv(here("data/raw_data/fisheries/gears_to_cat.csv"))


#So for forage fish we are only interested "bottom trawls" as a destrcutive method
forage_gear_cats <- forage_gears |> left_join(gears_to_cat, by = c("Gear", "VBDesc"))


```


# FISHMEAL


For pressures all we are interested is the bottom trawl component so now we isolate the embodied demand (catch) estimates from the fishmeal component of demand and filter to just bottom trawls and sum catch per cell, and export the rasters.

```{r}

#create list of dataframe of trawling for forage fish by diet and sourcing
trawl_forage_catch_list <- 
  fread(here("data/large_data/embodied_foragefish_per_cell.csv")) |> 
  lazy_dt(immutable = FALSE) |> 
  # filter(VBDesc == "bottom trawls") |> 
  as_tibble() |> 
  group_split(diet, fao_area_code)

#summarise the data by cell and write to data folder

#test
this_df <- trawl_forage_catch_list[[2]]


map(trawl_forage_catch_list, \(this_df){
  
  this_diet <- unique(this_df$diet)
  
  this_source <- unique(this_df$source_code)
  
  #Mass allocation
  this_summary_df_mass <- 
    this_df |> 
    filter(VBDesc == "bottom trawls") |> 
    group_by(LonCentre, LatCentre) |> 
    summarise(forage_catch_mass = sum(fm_embodied_fish_mass, na.rm=TRUE))

  if(nrow(this_summary_df_mass>0)){
  this_rast_mass <- rast(this_summary_df_mass, type="xyz", crs="EPSG:4326")
  this_rast_resampled_mass <- resample(this_rast_mass, rast(res=0.5))
  } else{
    this_rast_resampled_mass <- rast(res=0.5)
    values(this_rast_resampled_mass) <- 0
  }
  
  
  writeRaster(x = this_rast_resampled_mass, filename = sprintf(here("data/spatial/%s/int/fishmeal_trawl_catch_%s_%s_mass_allocation.tif"), this_diet, this_diet, this_source), overwrite=TRUE)
  
  #Gross energy allocation
   this_summary_df_ge <- 
    this_df |> 
     filter(VBDesc == "bottom trawls") |> 
    group_by(LonCentre, LatCentre) |> 
    summarise(forage_catch_ge = sum(fm_embodied_fish_ge, na.rm=TRUE))

   if(nrow(this_summary_df_ge>0)){
  this_rast_ge <- rast(this_summary_df_ge, type="xyz", crs="EPSG:4326")
  this_rast_resampled_ge <- resample(this_rast_ge, rast(res=0.5))
   } else{
   this_rast_resampled_ge <- rast(res=0.5)
   values(this_rast_resampled_ge) <- 0
   }
  
  
  writeRaster(x = this_rast_resampled_ge, filename = sprintf(here("data/spatial/%s/int/fishmeal_trawl_catch_%s_%s_ge_allocation.tif"), this_diet, this_diet, this_source), overwrite=TRUE)
  
  
}

# now look at dredging - but there is no catch for dredging so we can disregard

dredge_forage_catch_list <- 
  fread(here("data/tidy_data/demand/embodied_fish_per_cell.csv")) |> 
  lazy_dt(immutable = FALSE) |> 
  filter(VBDesc %in% dredge_types) |> 
  as_tibble()



```

Now we need to work out what proportion of all trawling each one of the trawling for forage fish catch rasters represents across diets and sources so we can create a proportional raster to multiply by effort.

```{r}

#marine diets 

fm_catch_r_list_int_md <- list.files(path = here("data/spatial/marine_diet/int"), pattern = "fishmeal_trawl_catch", full.names = TRUE)
fm_catch_r_list_md <- fm_catch_r_list_int_md[!grepl("_prop", fm_catch_r_list_int_md) & grepl("_allocation", fm_catch_r_list_int_md)]

#test
this_file <- fm_catch_r_list_md[[5]]

#calculate the proportion of all trawl catch is this diet scenario
map(.x = fm_catch_r_list_md, .f = \(this_file){
  
  message("processing ", tools::file_path_sans_ext(basename(this_file)))
  
  saveName <- paste0(tools::file_path_sans_ext(basename(this_file)), "_prop")
  
  this_r <- rast(this_file) 
  
  this_trawL_r <- rast(here("data/spatial/fisheries-effort/all_trawling_catch.tif")) |>  extend(rast(res=0.5))
  
  this_stack_r <- c(this_r, this_trawL_r)
  
  this_combined_r <- lapp(x= this_stack_r, fun = \(x,y){
      this_combo <- x/y
      this_combo[this_combo >1 ] <- 1
      return(this_combo)
      }, 
      filename = sprintf(here("data/spatial/marine_diet/int/%s.tif"), saveName), overwrite=TRUE)
})

#plant diets 

fm_catch_r_list_int_pd <- list.files(path = here("data/spatial/plant_diet/int"), pattern = "fishmeal_trawl_catch", full.names = TRUE)
fm_catch_r_list_pd <- fm_catch_r_list_int_pd[!grepl("_prop", fm_catch_r_list_int_pd) & grepl("_allocation", fm_catch_r_list_int_pd)]

#test

#calculate the proportion of all trawl catch is this diet scenario
map(.x = fm_catch_r_list_pd, .f = \(this_file){
  
  message("processing ", tools::file_path_sans_ext(basename(this_file)))
  
  saveName <- paste0(tools::file_path_sans_ext(basename(this_file)), "_prop")
  
  this_r <- rast(this_file)
  
  this_trawl_r <- rast(here("data/spatial/fisheries-effort/all_trawling_catch.tif")) |>  extend(rast(res=0.5))
  
  this_stack_r <- c(this_r, this_trawl_r)
  
  this_combined_r <- 
    lapp(x= this_stack_r, fun = \(x,y){
      this_combo <- x/y
      this_combo[this_combo >1 ] <- 1
      return(this_combo)
      }, filename = sprintf(here("data/spatial/plant_diet/int/%s.tif"), saveName), overwrite=TRUE)
})

```

With proportions of all forage fish trawling now available for each diet and source, we can now resample the proportional rasters to the res and extent of the effort data and multiply them together to get hours of trawling for forage fish per diet and source.


```{r}

# the total trawling effort
gfw_native_r <- rast(here("data/spatial/fisheries-effort/gfw_annual_effort_2017_trawlers.tif"))


#bring in the shapefile for cropping effort rasters by relevant source area
FAO_regions_shp <- read_sf("https://www.fao.org/fishery/geoserver/fifao/ows?service=WFS&request=GetFeature&version=1.0.0&typeName=fifao:FAO_AREAS_CWP_NOCOASTLINE&outputFormat=json") |> filter(F_LEVEL == "MAJOR") |> 
  mutate(F_AREA = as.numeric(F_AREA)) |> 
  mutate(source_code = case_when(NAME_EN == "Atlantic, Northeast" ~ "NAT",
                                 NAME_EN %in% c("Pacific, Northeast", "Pacific, Eastern Central", "Pacific, Southeast") ~ "EPC",
                                                      TRUE ~ "OTH"))

#MARINE DIETS

#proportional catch raster for forage fish trawling
prop_raster_files_md <- list.files(path = here("data/spatial/marine_diet/int"), pattern = "allocation_prop.tif", full.names = TRUE)
prop_raster_files_md <- prop_raster_files_md[!grepl(pattern = "fish oil|forage", x = prop_raster_files_md)]


#for testing function below
this_file <- prop_raster_files_md[[1]]

# now crop each proportional catch raster by the source shapefile and multiply the trawl effort raster 

map(.x = prop_raster_files_md, .f = \(this_file){
  
  fileName <- gsub(pattern = "catch", replacement = "effort", tools::file_path_sans_ext(basename(this_file)))
  fileName <- gsub(pattern = "_prop", replacement = "", fileName)
  
  saveName <- sprintf(here("data/spatial/marine_diet/int/%s.tif"), fileName)
  
  if(!file.exists(saveName)){
    
  this_source <- str_extract(fileName, "EPC|NAT|OTH")
  
  #get the FAO regions shp for masking the raster to the relevant ones
  this_shp_extent <- FAO_regions_shp |> filter(source_code ==this_source)
  
  message("processing ", tools::file_path_sans_ext(basename(this_file)))
  
  this_rast <- rast(this_file)
  
  #add average value where 
  avg_trawl_correction <- terra::global(this_rast, na.rm = TRUE) |> pull(mean)
  
  this_rast[is.na(this_rast)] <- avg_trawl_correction
  
  this_cropped_rast <- terra::mask(x = this_rast, mask =vect(this_shp_extent))
   
  this_resampled_rast <- resample(this_cropped_rast, gfw_native_r)
  
  this_stack_r <- c(this_resampled_rast, gfw_native_r) 
  
  this_effort_raster <- lapp(this_stack_r, fun = \(x, y){x * y}, filename = saveName , overwrite=TRUE)
    
  }
})

#PLANT DIETS

#proportional catch raster for forage fish trawling
prop_raster_files_pd <- list.files(path = here("data/spatial/plant_diet/int"), pattern = "allocation_prop.tif", full.names = TRUE)
prop_raster_files_pd <- prop_raster_files_pd[!grepl(pattern = "fish oil|forage", x = prop_raster_files_pd)]

#for testing function below
this_file <- prop_raster_files_pd[[1]]

# now crop each proportional catch raster by the source shapefile and multiply the trawl effort raster 

map(.x = prop_raster_files_pd, .f = \(this_file){
  
  fileName <- gsub(pattern = "catch", replacement = "effort", tools::file_path_sans_ext(basename(this_file)))
  fileName <- gsub(pattern = "_prop", replacement = "", fileName)
  
  saveName <- sprintf(here("data/spatial/plant_diet/int/%s.tif"), fileName)
  
  if(!file.exists(saveName)){
    
  this_source <- str_extract(fileName, "EPC|NAT|OTH")
  
  #get the FAO regions shp for masking the raster to the relevant ones
  this_shp_extent <- FAO_regions_shp |> filter(source_code ==this_source)
  
  message("processing ", tools::file_path_sans_ext(basename(this_file)))
  
  this_rast <- rast(this_file)
  
  #add average value where 
  avg_trawl_correction <- terra::global(this_rast, na.rm = TRUE) |> pull(mean)
  
  this_rast[is.na(this_rast)] <- avg_trawl_correction
  
  this_cropped_rast <- terra::mask(this_rast, vect(this_shp_extent))
   
  this_resampled_rast <- resample(this_cropped_rast, gfw_native_r)
  
  this_stack_r <- c(this_resampled_rast, gfw_native_r) 
  
  this_effort_raster <- lapp(this_stack_r, fun = \(x, y){x * y}, filename = saveName , overwrite=TRUE)
    
  }
})



```


Now we need to bring in the effort rasters and aggregate to half a degree and adjust to effort per km2.

```{r}

#Marine Diets

fm_effort_files_int_md <- list.files(here("data/spatial/marine_diet/int"), pattern = "fishmeal_trawl_effort", full.names=TRUE)
fm_effort_files_md <- fm_effort_files_int_md[!grepl("0.5D_km2", fm_effort_files_int_md) & grepl("_allocation", fm_effort_files_int_md)]

this_file <- fm_effort_files_md[[1]]

#aggregate the effort data to 0;5 degrees and adjust to effort for km2

map(.x = fm_effort_files_md, .f = \(this_file){
  
  fileName <- paste0(gsub(pattern = "catch", replacement = "effort", tools::file_path_sans_ext(basename(this_file))), "_0.5D_km2")
  
  saveName <- sprintf(here("data/spatial/marine_diet/int/%s.tif"), fileName)
  
  message("Processing ", fileName)
  
  if(!file.exists(saveName)){
    
    this_r <- rast(this_file)
    
    this_aggregate_r <- terra::aggregate(this_r, fact = 50, fun = sum, na.rm = TRUE)
    
    this_xy <- terra::as.data.frame(this_aggregate_r, xy = TRUE) |> mutate(x = round((x+0.25)*2)/2-0.25,
                                                                           y = round((y+0.25)*2)/2-0.25)
    
    this_new_r <- rast(this_xy, type = "xyz", crs = "EPSG:4326") |> extend(rast(res=0.5))
    
    this_new_km2_r <- this_new_r/cellSize(this_new_r, unit = "km")
    
    writeRaster(x = this_new_km2_r, filename = saveName, overwrite = TRUE)
  }
})


#Plant diets

fm_effort_files_int_pd <- list.files(here("data/spatial/plant_diet/int"), pattern = "fishmeal_trawl_effort", full.names=TRUE)
fm_effort_files_pd <- fm_effort_files_int_pd[!grepl("0.5D_km2", fm_effort_files_int_pd) & grepl("_allocation", fm_effort_files_int_pd)]

this_file <- fm_effort_files_pd[[3]]

#aggregate the effort data to 0.5 degrees and adjust to effort for km2

map(.x = fm_effort_files_pd, .f = \(this_file){
  
  fileName <- paste0(gsub(pattern = "catch", replacement = "effort", tools::file_path_sans_ext(basename(this_file))), "_0.5D_km2")
  
  saveName <- sprintf(here("data/spatial/plant_diet/int/%s.tif"), fileName)
  
  message("Processing ", fileName)
  
  if(!file.exists(saveName)){
    
    this_r <- rast(this_file)
    
    this_aggregate_r <- terra::aggregate(this_r, fact = 50, fun = sum, na.rm = TRUE)
    
    this_xy <- terra::as.data.frame(this_aggregate_r, xy = TRUE) |> mutate(x = round((x+0.25)*2)/2-0.25,
                                                                           y = round((y+0.25)*2)/2-0.25)
    
    this_new_r <- rast(this_xy, type = "xyz", crs = "EPSG:4326") |> extend(rast(res=0.5))
    
    this_new_km2_r <- this_new_r/cellSize(this_new_r, unit = "km")
    
    writeRaster(x = this_new_km2_r, filename = saveName, overwrite = TRUE)
  }
})





```



### Rescale habitat destruction 
For the final step in the destruction layer of disturbance, we need to normalise the effort between 0 and 1. The 99th percentile is used to rescale to avoid the undue influence of outliers

```{r}

#marine diets

md_fm_effort_km2_r_files <- list.files(path = here("data/spatial/marine_diet/int"), pattern = "_0.5D_km2", full.names = TRUE) 
md_fm_effort_km2_r_files <- md_fm_effort_km2_r_files[grepl("fishmeal", md_fm_effort_km2_r_files) & grepl("allocation", md_fm_effort_km2_r_files)]


#get all the values for the forage trawl effort rasters

#gross energy allocation

md_fm_effort_km2_r_list_ge_allocation <- 
  
  map(md_fm_effort_km2_r_files[grepl("ge_allocation", md_fm_effort_km2_r_files)], \(this_file){
  
  this_rast <- rast(this_file)
  
  these_values <- c(terra::values(this_rast, na.rm=TRUE))
  
  return(these_values)
})


#check for outliers
hist(unlist(md_fm_effort_km2_r_list_ge_allocation)) |> 
abline(v=quantile(unlist(md_fm_effort_km2_r_list_ge_allocation), 0.999), lty=2)


#Mass allocation
md_fm_effort_km2_r_list_mass_allocation <- 
  
  map(md_fm_effort_km2_r_files[grepl("mass_allocation", md_fm_effort_km2_r_files)], \(this_file){
  
  this_rast <- rast(this_file)
  
  these_values <- c(terra::values(this_rast, na.rm=TRUE))
  
  return(these_values)
})


#check for outliers
hist(unlist(md_fm_effort_km2_r_list_mass_allocation)) |> 
abline(v=quantile(unlist(md_fm_effort_km2_r_list_mass_allocation), 0.999), lty=2)




#testing the function
this_file <- md_fm_effort_km2_r_files[[1]]

md_fm_rescaled_benthic_list <- 
  
  map(.x = md_fm_effort_km2_r_files, .f = \(this_file){
    
    fileName <- gsub("_0.5D_km2", "", gsub(pattern = "trawl_effort", replacement = "benthic_destruction_rescaled", tools::file_path_sans_ext(basename(this_file))))
    
    this_diet <- "marine_diet"
    
    saveName <- sprintf(here("data/spatial/%s/int/%s.tif"),this_diet, fileName)
    
    if(!file.exists(saveName)){
      
      if(grepl("ge_allocation", saveName)){
        
        all_effort_values <- unlist(md_fm_effort_km2_r_list_ge_allocation)
        
        this_rast <- rast(this_file)
        
        rescale_value <- quantile(all_effort_values, 1, na.rm=TRUE)
        
        this_rescaled_rast <- 
          app(x = this_rast, fun = \(x){
            if_else(x<0, true = 0, false = if_else(x>rescale_value, true = 1, false = x/rescale_value))})
        
        
        writeRaster(x = this_rescaled_rast, filename = saveName, overwrite = TRUE)
        
        return(this_rescaled_rast)
        
        
      } else {
        
        all_effort_values <- unlist(md_fm_effort_km2_r_list_mass_allocation)
        
        this_rast <- rast(this_file)
        
        rescale_value <- quantile(all_effort_values, 1, na.rm=TRUE)
        
        this_rescaled_rast <- 
          app(x = this_rast, fun = \(x){
            if_else(x<0, true = 0, false = if_else(x>rescale_value, true = 1, false = x/rescale_value))})
        
        
        writeRaster(x = this_rescaled_rast, filename = saveName, overwrite = TRUE)
        
        return(this_rescaled_rast)
      }
      }
    
  })

#check the rasters
#plot(rast(md_fm_rescaled_benthic_list))



#plant diets
pd_fm_effort_km2_r_files <- list.files(path = here("data/spatial/plant_diet/int"), pattern = "_0.5D_km2", full.names = TRUE) 
pd_fm_effort_km2_r_files <- pd_fm_effort_km2_r_files[grepl("fishmeal", pd_fm_effort_km2_r_files) & grepl("allocation", pd_fm_effort_km2_r_files)]


#get all the values for the forage trawl effort rasters

pd_fm_effort_km2_r_list_ge_allocation <- 
  
  map(pd_fm_effort_km2_r_files[grepl("ge_allocation",pd_fm_effort_km2_r_files)], \(this_file){
  
  this_rast <- rast(this_file)
  
  these_values <- c(terra::values(this_rast, na.rm=TRUE))
  
  return(these_values)
})


pd_fm_effort_km2_r_list_mass_allocation <- 
  
  map(pd_fm_effort_km2_r_files[grepl("mass_allocation",pd_fm_effort_km2_r_files)], \(this_file){
  
  this_rast <- rast(this_file)
  
  these_values <- c(terra::values(this_rast, na.rm=TRUE))
  
  return(these_values)
})



#If using multicore this run returns "Error in (function (x) : attempt to apply non-function" the first time. It is related to this issue with terra https://github.com/rspatial/terra/issues/30. It can be ignored everything runs fine. Also rasters should be there on cloned project.

pd_fm_rescaled_benthic_list <- 
  
  map(.x = pd_fm_effort_km2_r_files, .f = \(this_file){
    
    fileName <- gsub("_0.5D_km2", "", gsub(pattern = "trawl_effort", replacement = "benthic_destruction_rescaled", tools::file_path_sans_ext(basename(this_file))))
    
    this_diet <- "plant_diet"
    
    saveName <- sprintf(here("data/spatial/%s/int/%s.tif"),this_diet, fileName)
    
    if(!file.exists(saveName)){
      
      if(grepl("ge_allocation", saveName)){
        
        all_effort_values <- unlist(pd_fm_effort_km2_r_list_ge_allocation)
        
        this_rast <- rast(this_file)
        
        rescale_value <- quantile(all_effort_values, 1, na.rm=TRUE)
        
        this_rescaled_rast <- 
          app(x = this_rast, fun = \(x){
            if_else(x<0, true = 0, false = if_else(x>rescale_value, true = 1, false = x/rescale_value))})
        
        
        writeRaster(x = this_rescaled_rast, filename = saveName, overwrite = TRUE)
        
        return(this_rescaled_rast)
        
        
      } else {
        
        all_effort_values <- unlist(pd_fm_effort_km2_r_list_mass_allocation)
        
        this_rast <- rast(this_file)
        
        rescale_value <- quantile(all_effort_values, 1, na.rm=TRUE)
        
        this_rescaled_rast <- 
          app(x = this_rast, fun = \(x){
            if_else(x<0, true = 0, false = if_else(x>rescale_value, true = 1, false = x/rescale_value))})
        
        
        writeRaster(x = this_rescaled_rast, filename = saveName, overwrite = TRUE)
        
        return(this_rescaled_rast)
        
        
      }
      }
    
  })

#check the rasters
# plot(rast(pd_fm_rescaled_benthic_list))
# 
# 
# md_fm_effort_km2_r_files |> rast()
# pd_fm_effort_km2_r_files |> rast()
```


## Biomass removal

The next step is understand the biomass removal component of disturbance. To do this we will bring in each forage fish catch scenario from each source and diet and adjust the biomass taken by the NPP and then rescale between 0-1.

```{r}

#Create catch rasters for all diets and sources

#split the embodied fish from fishmeal xy file by diet and source
fm_catch_list <- fread(here("data/tidy_data/demand/embodied_fish_per_cell.csv")) |> 
  lazy_dt(immutable = FALSE) |> 
  group_by(diet, source_code, LonCentre, LatCentre) |> 
  summarise(mass_allocation = sum(fm_embodied_fish_ge, na.rm=TRUE),
            ge_allocation = sum(fm_embodied_fish_mass, na.rm=TRUE)) |> 
  as_tibble() |> 
  pivot_longer(names_to = "allocation_method", values_to = "catch", cols = -c(diet, source_code, LonCentre, LatCentre)) |> 
  group_split(diet, source_code, allocation_method)
  

this_df <- fm_catch_list[[1]]

#create the rasters
map(fm_catch_list, \(this_df){
  
  this_diet <- unique(this_df$diet)
  
  this_source <- unique(this_df$source_code)
  
  this_allocation_method <- unique(this_df$allocation_method)
  
  saveName <- sprintf(here("data/spatial/%s/production/fishmeal_catch_%s_%s_%s.tif"), this_diet, this_diet, this_source, this_allocation_method)
  
  if(!file.exists(saveName)){
    
    this_xy <- this_df |> select(-c(diet, source_code, allocation_method))
  
    this_r <- rast(this_xy, type = "xyz", crs = crs(rast(res=0.5))) |> extend(ext(rast(res=0.5)))
    
    writeRaster(x = this_r, filename = saveName, overwrite=TRUE)
    
  }
})
  
  
#import npp raster
npp <- rast(here("data/spatial/00-net-primary-productivity/annal_mean_npp_2015_gf_wgs.tif"))

# Import the catch rasters by marine and plant diets

# marine diet

fm_catch_r_list_int_md <- list.files(here("data/spatial/marine_diet/production"), pattern = "fishmeal_catch", full.names = TRUE)
fm_catch_r_list_md <- fm_catch_r_list_int_md[!grepl("ea_npp", fm_catch_r_list_int_md) & grepl("allocation", fm_catch_r_list_int_md)]

#testing function 
this_file <- fm_catch_r_list_md[1]

#Convert to equal area, adjust by npp and save
map(fm_catch_r_list_md, \(this_file){
  
  saveName <- gsub(pattern = "production", replacement = "int", gsub(pattern = ".tif", replacement = "_ea_npp.tif", this_file))
  
  if(!file.exists(saveName)){
    
  this_r <- rast(this_file)
    
  this_ea_r <- this_r/cellSize(this_r, unit = "km")
  
  this_ea_npp_r <- this_ea_r/npp
  
  writeRaster(this_ea_npp_r, filename = saveName, overwrite=TRUE)
  
  }

})


# plant diet

fm_catch_r_list_int_pd <- list.files(here("data/spatial/plant_diet/production"), pattern = "fishmeal_catch", full.names = TRUE)
fm_catch_r_list_pd <- fm_catch_r_list_int_pd[!grepl("ea_npp", fm_catch_r_list_int_pd) & grepl("allocation", fm_catch_r_list_int_pd)]

this_file <- fm_catch_r_list_pd[1]
#Convert to equal area, adjust by npp and save
map(fm_catch_r_list_pd, \(this_file){
  
  saveName <- gsub(pattern = "production", replacement = "int", gsub(pattern = ".tif", replacement = "_ea_npp.tif", this_file))
  
  if(!file.exists(saveName)){
    
  this_r <- rast(this_file)
    
  this_ea_r <- this_r/cellSize(this_r, unit = "km")
  
  this_ea_npp_r <- this_ea_r/npp
  
  writeRaster(this_ea_npp_r, filename = saveName, overwrite=TRUE)
  
  }

})




#bring the npp adjusted catch back in and rescale it for marine diets
adjusted_fm_catch_r_list_md <- list.files(here("data/spatial/marine_diet/int"), pattern = "allocation_ea_npp", full.names = TRUE) 
adjusted_fm_catch_r_list_md <- adjusted_fm_catch_r_list_md[grepl("fishmeal", adjusted_fm_catch_r_list_md)]

adjusted_fm_catch_r_list_pd <- list.files(here("data/spatial/plant_diet/int"), pattern = "allocation_ea_npp", full.names = TRUE) 
adjusted_fm_catch_r_list_pd <- adjusted_fm_catch_r_list_pd[grepl("fishmeal", adjusted_fm_catch_r_list_pd)] 


adjusted_fm_catch_list_all <- c(adjusted_fm_catch_r_list_md, adjusted_fm_catch_r_list_pd)
adjusted_fm_catch_r_list_all <- adjusted_fm_catch_list_all |> map(rast)
adjusted_fm_catch_r_list_ge <- adjusted_fm_catch_list_all[grepl("ge_allocation", adjusted_fm_catch_list_all)] |> map(rast)
adjusted_fm_catch_r_list_mass <- adjusted_fm_catch_list_all[grepl("mass_allocation", adjusted_fm_catch_list_all)] |> map(rast)


this_r <- adjusted_fm_catch_r_list_all[[1]]

#rescale and save rescaled rasters for biomass removal
fm_rescaled_biomass_list <- 
  
  map(adjusted_fm_catch_r_list_all, \(this_r){
  
  this_diet <- if_else(grepl("marine_diet", sources(this_r)), true = "marine_diet", false = "plant_diet")
  
  fileName <- tools::file_path_sans_ext(basename(gsub(pattern = "_ea_npp", replacement = "", sources(this_r))))
  
  this_source <- str_extract(fileName, pattern = "EPC|NAT|OTH")
  
  this_allocation_method <- str_extract(fileName, pattern = "mass_allocation|ge_allocation")
  
  saveName <- sprintf(here("data/spatial/%s/int/fishmeal_biomass_removal_rescaled_%s_%s_%s.tif"), this_diet, this_diet, this_source, this_allocation_method)
  
  if(!file.exists(saveName)){
    
    if(this_allocation_method=="ge_allocation"){
      
      all_catch_values <- unlist(map(adjusted_fm_catch_r_list_ge, \(this_r){return(c(terra::values(this_r, na.rm=TRUE)))}))
      
      rescale_value <- quantile(x = all_catch_values, 1)
      
      this_rescaled_rast <- 
        app(x = this_r, fun = \(x){
          if_else(x<0, true = 0, false = 
                    if_else(x>rescale_value, true = 1, false = x/rescale_value))})
      
      writeRaster(x = this_rescaled_rast, filename = saveName, overwrite = TRUE)
      
      return(this_rescaled_rast)
      
    } else {
      
      all_catch_values <- unlist(map(adjusted_fm_catch_r_list_mass, \(this_r){return(c(terra::values(this_r, na.rm=TRUE)))}))
      
      rescale_value <- quantile(x = all_catch_values, 1)
      
      this_rescaled_rast <- 
        app(x = this_r, fun = \(x){
          if_else(x<0, true = 0, false = 
                    if_else(x>rescale_value, true = 1, false = x/rescale_value))})
      
      writeRaster(x = this_rescaled_rast, filename = saveName, overwrite = TRUE)
      
      return(this_rescaled_rast)
      
    }
    
   
  }
  
})


  

```

# Will need to revisit this if all rescaling does not need to be done within the context of a feed (i.e. rescaled per cell against the highest value for all ingredients across both diets in that cell).

Finally, combine benthic disturbance with biomass removal to get a joint pressure metric.

```{r}

#marine-diet
fm_benthic_destruction_md <- list.files(here("data/spatial/marine_diet/int"), pattern = "fishmeal_benthic", full=TRUE) 
fm_benthic_destruction_md <- fm_benthic_destruction_md[grepl("allocation", fm_benthic_destruction_md)]

fm_biomass_removal_md <- list.files(here("data/spatial/marine_diet/int"), pattern = "fishmeal_biomass", full=TRUE) 
fm_biomass_removal_md <- fm_biomass_removal_md[grepl("allocation", fm_biomass_removal_md)]

this_benthic_file <- fm_benthic_destruction_md[[1]]
this_biomass_file <- fm_biomass_removal_md[[1]]

combined_raster_list <- 
  map2(.x = fm_benthic_destruction_md, .y = fm_biomass_removal_md, .f = \(this_benthic_file, this_biomass_file){
    
    this_source <- str_extract(string = this_benthic_file, pattern = "EPC|NAT|OTH") 
    this_allocation_method <- str_extract(this_benthic_file, pattern = "ge_allocation|mass_allocation")
    
    saveName <- sprintf(here("data/spatial/marine_diet/int/fishmeal_disturbance_km2_%s_%s.tif"), this_source, this_allocation_method)
    
    message("Processing, ", basename(saveName))
    
    if(file.exists(saveName)){
      
      this_benthic_r <- rast(this_benthic_file)
      this_biomass_r <- rast(this_biomass_file)
      
      this_combined_r <- (this_benthic_r+this_biomass_r)/2
      
      this_combined_r_reproj <- project(this_combined_r, gall_peters)
      
      this_km2_combined_r <- this_combined_r_reproj*cellSize(this_combined_r_reproj, unit="km")
      
      writeRaster(x = this_km2_combined_r, filename = saveName, overwrite=TRUE)
      
      return(this_km2_combined_r)
    }
  })



#plant-diet 
fm_benthic_destruction_pd <- list.files(here("data/spatial/plant_diet/int"), pattern = "fishmeal_benthic", full=TRUE)
fm_benthic_destruction_pd <- fm_benthic_destruction_pd[grepl("allocation", fm_benthic_destruction_pd)]

fm_biomass_removal_pd <- list.files(here("data/spatial/plant_diet/int"), pattern = "fishmeal_biomass", full=TRUE) 
fm_biomass_removal_pd <- fm_biomass_removal_pd[grepl("allocation", fm_biomass_removal_pd)]

this_benthic_file <- fm_benthic_destruction_pd[[1]]
this_biomass_file <- fm_biomass_removal_pd[[1]]
  
  
combined_raster_list2 <- 
  map2(.x = fm_benthic_destruction_pd, .y = fm_biomass_removal_pd, .f = \(this_benthic_file, this_biomass_file){
    
    this_source <- str_extract(string = this_benthic_file, pattern = "EPC|NAT|OTH") 
    this_allocation_method <- str_extract(this_benthic_file, pattern = "ge_allocation|mass_allocation")
    
    saveName <- sprintf(here("data/spatial/plant_diet/int/fishmeal_disturbance_km2_%s_%s.tif"), this_source, this_allocation_method)
    
    message("Processing, ",  basename(saveName))
    
    if(file.exists(saveName)){
      
      this_benthic_r <- rast(this_benthic_file)
      this_biomass_r <- rast(this_biomass_file)
      
      this_combined_r <- (this_benthic_r+this_biomass_r)/2
      
      this_combined_r_reproj <- project(this_combined_r, gall_peters)
      
      this_km2_combined_r <- this_combined_r_reproj*cellSize(this_combined_r_reproj, unit="km")
      
      writeRaster(x = this_km2_combined_r, filename = saveName, overwrite=TRUE)
      
      return(this_km2_combined_r)

    }
})


#quick check
plot(rast(combined_raster_list))
plot(rast(combined_raster_list2))

fm_benthic_destruction_md |> map(rast)
fm_benthic_destruction_pd |> map(rast)

fm_biomass_removal_md |> map(rast)
fm_biomass_removal_pd |> map(rast)


```

# FISH OIL

For pressures all we are interested is the bottom trawl component so now we isolate the embodied demand (catch) estimates from the fish oil component of demand and filter to just bottom trawls and sum catch per cell, and export the rasters.

```{r}

#create list of dataframe of trawling for forage fish by diet and sourcing
trawl_forage_catch_list <- 
  fread(here("data/tidy_data/demand/embodied_fish_per_cell.csv")) |> 
  lazy_dt(immutable = FALSE) |> 
  filter(VBDesc == "bottom trawls") |> 
  as_tibble() |> 
  group_split(diet, source_code)

#summarise the data by cell and write to data folder

#test
this_df <- trawl_forage_catch_list[[6]]


map(trawl_forage_catch_list, \(this_df){
  
  this_diet <- unique(this_df$diet)
  
  this_source <- unique(this_df$source_code)
  
  #Mass allocation
  this_summary_df_mass <- 
    this_df |> 
    group_by(LonCentre, LatCentre) |> 
    summarise(forage_catch_mass = sum(fo_embodied_fish_mass, na.rm=TRUE))

  this_rast_mass <- rast(this_summary_df_mass, type="xyz", crs="EPSG:4326")
  this_rast_resampled_mass <- resample(this_rast_mass, rast(res=0.5))
  
  writeRaster(x = this_rast_resampled_mass, filename = sprintf(here("data/spatial/%s/int/fish oil_trawl_catch_%s_%s_mass_allocation.tif"), this_diet, this_diet, this_source), overwrite=TRUE)
  
  #Gross energy allocation
   this_summary_df_ge <- 
    this_df |> 
    group_by(LonCentre, LatCentre) |> 
    summarise(forage_catch_ge = sum(fo_embodied_fish_ge, na.rm=TRUE))

  this_rast_ge <- rast(this_summary_df_ge, type="xyz", crs="EPSG:4326")
  this_rast_resampled_ge <- resample(this_rast_ge, rast(res=0.5))
  
  
  writeRaster(x = this_rast_resampled_ge, filename = sprintf(here("data/spatial/%s/int/fish oil_trawl_catch_%s_%s_ge_allocation.tif"), this_diet, this_diet, this_source), overwrite=TRUE)
  
})

# now look at dredging - but there is no catch for dredging so we can disregard

dredge_forage_catch_list <- fread(here("data/tidy_data/demand/embodied_fish_per_cell.csv")) |> 
  lazy_dt(immutable = FALSE) |> 
  filter(VBDesc %in% dredge_types) |> 
  as_tibble()



```

Now we need to work out what proportion of all trawling each one of the trawling for forage fish catch rasters represents across diets and sources so we can create a proportional raster to multiply by effort.

```{r}

#marine diets 

fo_catch_r_list_int_md <- list.files(path = here("data/spatial/marine_diet/int"), pattern = "fish oil_trawl_catch", full.names = TRUE)
fo_catch_r_list_md <- fo_catch_r_list_int_md[!grepl("_prop", fo_catch_r_list_int_md) & grepl("allocation", fo_catch_r_list_int_md)]

#test
this_file <- fo_catch_r_list_md[[3]]

#calculate the proportion of all trawl catch is this diet scenario
map(.x = fo_catch_r_list_md, .f = \(this_file){
  
  message("processing ", tools::file_path_sans_ext(basename(this_file)))
  
  saveName <- paste0(tools::file_path_sans_ext(basename(this_file)), "_prop")
  
  this_r <- rast(this_file) 
  
  this_trawL_r <- rast(here("data/spatial/fisheries-effort/all_trawling_catch.tif")) |>  extend(rast(res=0.5))
  
  this_stack_r <- c(this_r, this_trawL_r)
  
  this_combined_r <- lapp(x= this_stack_r, fun = \(x,y){
      this_combo <- x/y
      this_combo[this_combo >1 ] <- 1
      return(this_combo)
      }, 
      filename = sprintf(here("data/spatial/marine_diet/int/%s.tif"), saveName), overwrite=TRUE)
})

#plant diets 

fo_catch_r_list_int_pd <- list.files(path = here("data/spatial/plant_diet/int"), pattern = "fish oil_trawl_catch", full.names = TRUE)
fo_catch_r_list_pd <- fo_catch_r_list_int_pd[!grepl("_prop", fo_catch_r_list_int_pd) & grepl("allocation", fo_catch_r_list_int_pd)]

#test

#calculate the proportion of all trawl catch is this diet scenario
map(.x = fo_catch_r_list_pd, .f = \(this_file){
  
  message("processing ", tools::file_path_sans_ext(basename(this_file)))
  
  saveName <- paste0(tools::file_path_sans_ext(basename(this_file)), "_prop")
  
  this_r <- rast(this_file)
  
  this_trawl_r <- rast(here("data/spatial/fisheries-effort/all_trawling_catch.tif")) |>  extend(rast(res=0.5))
  
  this_stack_r <- c(this_r, this_trawl_r)
  
  this_combined_r <- 
    lapp(x= this_stack_r, fun = \(x,y){
      this_combo <- x/y
      this_combo[this_combo >1 ] <- 1
      return(this_combo)
      }, filename = sprintf(here("data/spatial/plant_diet/int/%s.tif"), saveName), overwrite=TRUE)
})

```

With proportions of all forage fish trawling now available for each diet and source, we can now resample the proportional rasters to the res and extent of the effort data and multiply them together to get hours of trawling for forage fish per diet and source.


```{r}

# the total trawling effort
gfw_native_r <- rast(here("data/spatial/fisheries-effort/gfw_annual_effort_2017_trawlers.tif"))


#bring in the shapefile for cropping effort rasters by relevant source area
FAO_regions_shp <- read_sf("https://www.fao.org/fishery/geoserver/fifao/ows?service=WFS&request=GetFeature&version=1.0.0&typeName=fifao:FAO_AREAS_CWP_NOCOASTLINE&outputFormat=json") |> filter(F_LEVEL == "MAJOR") |> 
  mutate(F_AREA = as.numeric(F_AREA)) |> 
  mutate(source_code = case_when(NAME_EN == "Atlantic, Northeast" ~ "NAT",
                                 NAME_EN %in% c("Pacific, Northeast", "Pacific, Eastern Central", "Pacific, Southeast") ~ "EPC",
                                                      TRUE ~ "OTH"))

#MARINE DIETS

#proportional catch raster for forage fish trawling
prop_raster_files_md <- list.files(path = here("data/spatial/marine_diet/int"), pattern = "_prop.tif", full.names = TRUE)
prop_raster_files_md <- prop_raster_files_md[grepl(pattern = "fish oil", x = prop_raster_files_md) & grepl("allocation", prop_raster_files_md)]


#for testing function below
this_file <- prop_raster_files_md[[1]]

# now crop each proportional catch raster by the source shapefile and multiply the trawl effort raster 
map(.x = prop_raster_files_md, .f = \(this_file){
  
  fileName <- gsub(pattern = "catch", replacement = "effort", tools::file_path_sans_ext(basename(this_file)))
  fileName <- gsub(pattern = "_prop", replacement = "", fileName)
  
  saveName <- sprintf(here("data/spatial/marine_diet/int/%s.tif"), fileName)
  
  if(!file.exists(saveName)){
    
  this_source <- str_extract(string = saveName, pattern = "EPC|NAT|OTH")
  
  #get the FAO regions shp for masking the raster to the relevant ones
  this_shp_extent <- FAO_regions_shp |> filter(source_code ==this_source)
  
  message("processing ", tools::file_path_sans_ext(basename(this_file)))
  
  this_rast <- rast(this_file)
  
  #add average value where 
  avg_trawl_correction <- terra::global(this_rast, na.rm = TRUE) |> pull(mean)
  
  this_rast[is.na(this_rast)] <- avg_trawl_correction
  
  this_cropped_rast <- terra::mask(this_rast, vect(this_shp_extent))
   
  this_resampled_rast <- resample(this_cropped_rast, gfw_native_r)
  
  this_stack_r <- c(this_resampled_rast, gfw_native_r) 
  
  this_effort_raster <- lapp(this_stack_r, fun = \(x, y){x * y}, filename = saveName , overwrite=TRUE)
    
  }
})

#PLANT DIETS

#proportional catch raster for forage fish trawling
prop_raster_files_pd <- list.files(path = here("data/spatial/plant_diet/int"), pattern = "_prop.tif", full.names = TRUE)
prop_raster_files_pd <- prop_raster_files_pd[grepl(pattern = "fish oil", x = prop_raster_files_pd) & grepl("allocation", prop_raster_files_pd)]

#for testing function below
this_file <- prop_raster_files_pd[[1]]

# now crop each proportional catch raster by the source shapefile and multiply the trawl effort raster 

map(.x = prop_raster_files_pd, .f = \(this_file){
  
  fileName <- gsub(pattern = "catch", replacement = "effort", tools::file_path_sans_ext(basename(this_file)))
  fileName <- gsub(pattern = "_prop", replacement = "", fileName)
  
  saveName <- sprintf(here("data/spatial/plant_diet/int/%s.tif"), fileName)
  
  if(!file.exists(saveName)){
    
  this_source <- str_extract(string = saveName, pattern = "EPC|NAT|OTH")
  
  #get the FAO regions shp for masking the raster to the relevant ones
  this_shp_extent <- FAO_regions_shp |> filter(source_code ==this_source)
  
  message("processing ", tools::file_path_sans_ext(basename(this_file)))
  
  this_rast <- rast(this_file)
  
  #add average value where there are NA values
  avg_trawl_correction <- terra::global(this_rast, na.rm = TRUE) |> pull(mean)
  
  this_rast[is.na(this_rast)] <- avg_trawl_correction
  
  this_cropped_rast <- terra::mask(this_rast, vect(this_shp_extent))
   
  this_resampled_rast <- resample(this_cropped_rast, gfw_native_r)
  
  this_stack_r <- c(this_resampled_rast, gfw_native_r) 
  
  this_effort_raster <- lapp(this_stack_r, fun = \(x, y){x * y}, filename = saveName , overwrite=TRUE)
    
  }
})



```


Now we need to bring in the effort rasters and aggregate to half a degree and adjust to effort per km2.

```{r}

#Marine Diets

fo_effort_files_int_md <- list.files(here("data/spatial/marine_diet/int"), pattern = "fish oil_trawl_effort", full.names=TRUE)
fo_effort_files_md <- fo_effort_files_int_md[!grepl("0.5D_km2", fo_effort_files_int_md) & grepl("allocation", fo_effort_files_int_md)]

this_file <- fo_effort_files_md[[1]]

#aggregate the effort data to 0;5 degrees and adjust to effort for km2

map(.x = fo_effort_files_md, .f = \(this_file){
  
  fileName <- paste0(gsub(pattern = "catch", replacement = "effort", tools::file_path_sans_ext(basename(this_file))), "_0.5D_km2")
  
  saveName <- sprintf(here("data/spatial/marine_diet/int/%s.tif"), fileName)
  
  message("Processing ", fileName)
  
  if(!file.exists(saveName)){
    
    this_r <- rast(this_file)
    
    this_aggregate_r <- terra::aggregate(this_r, fact = 50, fun = sum, na.rm = TRUE)
    
    this_xy <- terra::as.data.frame(this_aggregate_r, xy = TRUE) |> mutate(x = round((x+0.25)*2)/2-0.25,
                                                                           y = round((y+0.25)*2)/2-0.25)
    
    this_new_r <- rast(this_xy, type = "xyz", crs = "EPSG:4326") |> extend(rast(res=0.5))
    
    this_new_km2_r <- this_new_r/cellSize(this_new_r, unit = "km")
    
    writeRaster(x = this_new_km2_r, filename = saveName, overwrite = TRUE)
  }
})


#Plant diets

fo_effort_files_int_pd <- list.files(here("data/spatial/plant_diet/int"), pattern = "fish oil_trawl_effort", full.names=TRUE)
fo_effort_files_pd <- fo_effort_files_int_pd[!grepl("0.5D_km2", fo_effort_files_int_pd) & grepl("allocation", fo_effort_files_int_pd)]

#this_file <- forage_effort_files[[3]]

#aggregate the effort data to 0.5 degrees and adjust to effort for km2

map(.x = fo_effort_files_pd, .f = \(this_file){
  
  fileName <- paste0(gsub(pattern = "catch", replacement = "effort", tools::file_path_sans_ext(basename(this_file))), "_0.5D_km2")
  
  saveName <- sprintf(here("data/spatial/plant_diet/int/%s.tif"), fileName)
  
  message("Processing ", fileName)
  
  if(!file.exists(saveName)){
    
    this_r <- rast(this_file)
    
    this_aggregate_r <- terra::aggregate(this_r, fact = 50, fun = sum, na.rm = TRUE)
    
    this_xy <- terra::as.data.frame(this_aggregate_r, xy = TRUE) |> mutate(x = round((x+0.25)*2)/2-0.25,
                                                                           y = round((y+0.25)*2)/2-0.25)
    
    this_new_r <- rast(this_xy, type = "xyz", crs = "EPSG:4326") |> extend(rast(res=0.5))
    
    this_new_km2_r <- this_new_r/cellSize(this_new_r, unit = "km")
    
    writeRaster(x = this_new_km2_r, filename = saveName, overwrite = TRUE)
  }
})





```



### Rescale habitat destruction 
For the final step in the destruction layer of disturbance, we need to normalise the effort between 0 and 1. The 99.9th percentile is used to rescale to avoid the undue influence of outliers

```{r}

#marine diets


md_fo_effort_km2_r_files <- list.files(path = here("data/spatial/marine_diet/int"), pattern = "_0.5D_km2", full.names = TRUE) 
md_fo_effort_km2_r_files <- md_fo_effort_km2_r_files[grepl("fish oil", md_fo_effort_km2_r_files) & grepl("allocation", md_fo_effort_km2_r_files)]

#get all the values for the forage trawl effort rasters

md_fo_effort_km2_r_list_ge <- 
  
  map(md_fo_effort_km2_r_files[grepl("ge_allocation", md_fo_effort_km2_r_files)], \(this_file){
  
  this_rast <- rast(this_file)
  
  these_values <- c(terra::values(this_rast, na.rm=TRUE))
  
  return(these_values)
})


#check for outliers
hist(unlist(md_fo_effort_km2_r_list_ge)) |> 
abline(v=quantile(unlist(md_fo_effort_km2_r_list_ge), 0.999), lty=2)


md_fo_effort_km2_r_list_mass <- 
  
  map(md_fo_effort_km2_r_files[grepl("mass_allocation", md_fo_effort_km2_r_files)], \(this_file){
  
  this_rast <- rast(this_file)
  
  these_values <- c(terra::values(this_rast, na.rm=TRUE))
  
  return(these_values)
})


#check for outliers
hist(unlist(md_fo_effort_km2_r_list_mass)) |> 
abline(v=quantile(unlist(md_fo_effort_km2_r_list_mass), 0.999), lty=2)




md_fo_rescaled_benthic_list <- 
  
  map(.x = md_fo_effort_km2_r_files, .f = \(this_file){
    
    fileName <- gsub("_0.5D_km2", "", gsub(pattern = "trawl_effort", replacement = "benthic_destruction_rescaled", tools::file_path_sans_ext(basename(this_file))))
    
    this_diet <- "marine_diet"
    
    saveName <- sprintf(here("data/spatial/%s/int/%s.tif"),this_diet, fileName)
    
    if(!file.exists(saveName)){
      
      if(grepl("ge_allocation", saveName)){
        
        all_effort_values <- unlist(md_fo_effort_km2_r_list_ge)
        
        this_rast <- rast(this_file)
        
        rescale_value <- quantile(all_effort_values, 1, na.rm=TRUE)
        
        this_rescaled_rast <- 
          app(x = this_rast, fun = \(x){
            if_else(x<0, true = 0, false = if_else(x>rescale_value, true = 1, false = x/rescale_value))})
        
      
        writeRaster(x = this_rescaled_rast, filename = saveName, overwrite = TRUE)
        
        return(this_rescaled_rast)
        
        
      } else {
        
        all_effort_values <- unlist(md_fo_effort_km2_r_list_mass)
        
        this_rast <- rast(this_file)
        
        rescale_value <- quantile(all_effort_values, 1, na.rm=TRUE)
        
        this_rescaled_rast <- 
          app(x = this_rast, fun = \(x){
            if_else(x<0, true = 0, false = if_else(x>rescale_value, true = 1, false = x/rescale_value))})
        
        
        writeRaster(x = this_rescaled_rast, filename = saveName, overwrite = TRUE)
        
        return(this_rescaled_rast)
      }
      }
    
  })

#check the rasters
plot(rast(md_fo_rescaled_benthic_list))



#plant diets

pd_fo_effort_km2_r_files <- list.files(path = here("data/spatial/plant_diet/int"), pattern = "_0.5D_km2", full.names = TRUE) 
pd_fo_effort_km2_r_files <- pd_fo_effort_km2_r_files[grepl("fish oil", pd_fo_effort_km2_r_files) & grepl("allocation", pd_fo_effort_km2_r_files)]


#get all the values for the forage trawl effort rasters

pd_fo_effort_km2_r_list_ge <- 
  
  map(pd_fo_effort_km2_r_files[grepl("ge_allocation", pd_fo_effort_km2_r_files)], \(this_file){
  
  this_rast <- rast(this_file)
  
  these_values <- c(terra::values(this_rast, na.rm=TRUE))
  
  return(these_values)
})

pd_fo_effort_km2_r_list_mass <- 
  
  map(pd_fo_effort_km2_r_files[grepl("mass_allocation", pd_fo_effort_km2_r_files)], \(this_file){
  
  this_rast <- rast(this_file)
  
  these_values <- c(terra::values(this_rast, na.rm=TRUE))
  
  return(these_values)
})



pd_fo_rescaled_benthic_list <- 
  
  map(.x = pd_fo_effort_km2_r_files, .f = \(this_file){
    
    fileName <- gsub("_0.5D_km2", "", gsub(pattern = "trawl_effort", replacement = "benthic_destruction_rescaled", tools::file_path_sans_ext(basename(this_file))))
    
    this_diet <- "plant_diet"
    
    saveName <- sprintf(here("data/spatial/%s/int/%s.tif"),this_diet, fileName)
    
    if(!file.exists(saveName)){
      
        if(grepl("ge_allocation", saveName)){
        
        all_effort_values <- unlist(pd_fo_effort_km2_r_list_ge)
        
        this_rast <- rast(this_file)
        
        rescale_value <- quantile(all_effort_values, 1, na.rm=TRUE)
        
        this_rescaled_rast <- 
          app(x = this_rast, fun = \(x){
            if_else(x<0, true = 0, false = if_else(x>rescale_value, true = 1, false = x/rescale_value))})
        
        
        writeRaster(x = this_rescaled_rast, filename = saveName, overwrite = TRUE)
        
        return(this_rescaled_rast)
        
        
      } else {
        
        all_effort_values <- unlist(pd_fo_effort_km2_r_list_mass)
        
        this_rast <- rast(this_file)
        
        rescale_value <- quantile(all_effort_values, 1, na.rm=TRUE)
        
        this_rescaled_rast <- 
          app(x = this_rast, fun = \(x){
            if_else(x<0, true = 0, false = if_else(x>rescale_value, true = 1, false = x/rescale_value))})
        
        
        writeRaster(x = this_rescaled_rast, filename = saveName, overwrite = TRUE)
        
        return(this_rescaled_rast)
      }
      }
    
  })

#check the rasters
plot(rast(pd_fo_rescaled_benthic_list))


md_fo_effort_km2_r_files |> rast()
pd_fo_effort_km2_r_files |> rast()
```


## Biomass removal

The next step is understand the biomass removal component of disturbance. To do this we will bring in each forage fish catch scenario from each source and diet and adjust the biomass taken by the NPP and then rescale between 0-1.

```{r}

#Create catch rasters for all diets and sources

#split the embodied fish from fishmeal xy file by diet and source
fo_catch_list <- 
  fread(here("data/tidy_data/demand/embodied_fish_per_cell.csv")) |> 
  lazy_dt(immutable = FALSE) |> 
  group_by(diet, source_code, LonCentre, LatCentre) |> 
  summarise(ge_allocation = sum(fo_embodied_fish_ge, na.rm=TRUE),
            mass_allocation = sum(fo_embodied_fish_mass, na.rm=TRUE)) |> 
  as_tibble() |> 
  pivot_longer(names_to = "allocation_method", values_to = "catch", cols = -c(diet, source_code, LonCentre, LatCentre)) |> 
  group_split(diet, source_code, allocation_method)
  

this_df <- fo_catch_list[[1]]

#create the rasters
map(fo_catch_list, \(this_df){
  
  this_diet <- unique(this_df$diet)
  
  this_source <- unique(this_df$source_code)
  
  this_allocation_method <- unique(this_df$allocation_method)
  
  saveName <- sprintf(here("data/spatial/%s/production/fish oil_catch_%s_%s_%s.tif"), this_diet, this_diet, this_source, this_allocation_method)
  
  if(!file.exists(saveName)){
    
    this_xy <- this_df |> select(-c(diet, source_code, allocation_method))
  
    this_r <- rast(this_xy, type = "xyz", crs = crs(rast(res=0.5))) |> extend(ext(rast(res=0.5)))
    
    writeRaster(x = this_r, filename = saveName, overwrite=TRUE)
    
  }
})
  
  
#import npp raster
npp <- rast(here("data/spatial/00-net-primary-productivity/annal_mean_npp_2015_gf_wgs.tif"))

# Import the catch rasters by marine and plant diets and adjust them by npp in each cell

# marine diet

fo_catch_r_list_int_md <- list.files(here("data/spatial/marine_diet/production"), pattern = "fish oil_catch", full.names = TRUE)
fo_catch_r_list_md <- fo_catch_r_list_int_md[!grepl("ea_npp", fo_catch_r_list_int_md) & grepl("allocation", fo_catch_r_list_int_md)]


this_file <- fo_catch_r_list_md[1]

#Convert to equal area, adjust by npp and save
map(fo_catch_r_list_md, \(this_file){
  
  saveName <- gsub(pattern = "production", replacement = "int", gsub(pattern = ".tif", replacement = "_ea_npp.tif", this_file))
  
  if(!file.exists(saveName)){
    
  this_r <- rast(this_file)
    
  this_ea_r <- this_r/cellSize(this_r, unit = "km")
  
  this_ea_npp_r <- this_ea_r/npp
  
  writeRaster(this_ea_npp_r, filename = saveName, overwrite=TRUE)
  
  }

})


# plant diet

fo_catch_r_list_int_pd <- list.files(here("data/spatial/plant_diet/production"), pattern = "fish oil_catch", full.names = TRUE)
fo_catch_r_list_pd <- fo_catch_r_list_int_pd[!grepl("ea_npp", fo_catch_r_list_int_pd) & grepl("allocation", fo_catch_r_list_int_pd)]

this_file <- fo_catch_r_list_pd[1]
#Convert to equal area, adjust by npp and save
map(fo_catch_r_list_pd, \(this_file){
  
  saveName <- gsub(pattern = "production", replacement = "int", gsub(pattern = ".tif", replacement = "_ea_npp.tif", this_file))
  
  if(!file.exists(saveName)){
    
  this_r <- rast(this_file)
    
  this_ea_r <- this_r/cellSize(this_r, unit = "km")
  
  this_ea_npp_r <- this_ea_r/npp
  
  writeRaster(this_ea_npp_r, filename = saveName, overwrite=TRUE)
  
  }

})




#bring the npp adjusted catch back in and rescale it for marine diets
adjusted_fo_catch_r_list_md <- list.files(here("data/spatial/marine_diet/int"), pattern = "ea_npp", full.names = TRUE) 
adjusted_fo_catch_r_list_md <- adjusted_fo_catch_r_list_md[grepl("fish oil", adjusted_fo_catch_r_list_md) & grepl("allocation", adjusted_fo_catch_r_list_md)]

adjusted_fo_catch_r_list_pd <- list.files(here("data/spatial/plant_diet/int"), pattern = "ea_npp", full.names = TRUE) 
adjusted_fo_catch_r_list_pd <- adjusted_fo_catch_r_list_pd[grepl("fish oil", adjusted_fo_catch_r_list_pd) & grepl("allocation", adjusted_fo_catch_r_list_pd)] 


adjusted_fo_catch_list_all <- c(adjusted_fo_catch_r_list_md, adjusted_fo_catch_r_list_pd)
adjusted_fo_catch_r_list_all <- c(adjusted_fo_catch_r_list_md, adjusted_fo_catch_r_list_pd) |> map(rast)
adjusted_fo_catch_r_list_ge <- adjusted_fo_catch_list_all[grepl("ge_allocation", adjusted_fo_catch_list_all)] |> map(rast)
adjusted_fo_catch_r_list_mass <- adjusted_fo_catch_list_all[grepl("mass_allocation", adjusted_fo_catch_list_all)] |> map(rast)

this_r <- adjusted_fo_catch_r_list_all[[1]]

#rescale and save rescaled rasters for biomass removal
fo_rescaled_biomass_list <- 
  
  map(adjusted_fo_catch_r_list_all, \(this_r){
  
  this_diet <- if_else(grepl("marine_diet", sources(this_r)), true = "marine_diet", false = "plant_diet")
  
  fileName <- tools::file_path_sans_ext(basename(gsub(pattern = "_ea_npp", replacement = "", sources(this_r))))
  
  this_source <- str_extract(string = fileName, pattern = "EPC|NAT|OTH")
  
  this_allocation_method <- str_extract(fileName, pattern = "ge_allocation|mass_allocation")
  
  saveName <- sprintf(here("data/spatial/%s/int/fish oil_biomass_removal_rescaled_%s_%s_%s.tif"), this_diet, this_diet, this_source, this_allocation_method)
  
  if(!file.exists(saveName)){
    
    
    if(this_allocation_method == "ge_allocation"){
      
      all_catch_values <- unlist(map(adjusted_fo_catch_r_list_ge, \(this_r){return(c(terra::values(this_r, na.rm=TRUE)))}))

      rescale_value <- quantile(x = all_catch_values, 0.999)
      
      this_rescaled_rast <- 
        app(x = this_r, fun = \(x){
          if_else(x<0, true = 0, false = 
                    if_else(x>rescale_value, true = 1, false = x/rescale_value))})
      
      writeRaster(x = this_rescaled_rast, filename = saveName, overwrite = TRUE)
      
      return(this_rescaled_rast)
      
    } else {
      
      all_catch_values <- unlist(map(adjusted_fo_catch_r_list_mass, \(this_r){return(c(terra::values(this_r, na.rm=TRUE)))}))

      rescale_value <- quantile(x = all_catch_values, 0.9999)
      
      this_rescaled_rast <- 
        app(x = this_r, fun = \(x){
          if_else(x<0, true = 0, false = 
                    if_else(x>rescale_value, true = 1, false = x/rescale_value))})
      
      writeRaster(x = this_rescaled_rast, filename = saveName, overwrite = TRUE)
      
      return(this_rescaled_rast)
    }
  }
  
})


  

```

# Will need to revisit this if all rescaling needs to be done within the context of a feed (i.e. rescaled per cell against the highest value for all ingredients across both diets in that cell).

Finally, combine benthic disturbance with biomass removal to get a joint pressure metric.

```{r}

#marine-diet
fo_benthic_destruction_md <- list.files(here("data/spatial/marine_diet/int"), pattern = "fish oil_benthic", full=TRUE) 
fo_benthic_destruction_md <- fo_benthic_destruction_md[grepl("allocation", fo_benthic_destruction_md)]


fo_biomass_removal_md <- list.files(here("data/spatial/marine_diet/int"), pattern = "fish oil_biomass", full=TRUE) 
fo_biomass_removal_md <- fo_biomass_removal_md[grepl("allocation", fo_biomass_removal_md)]

this_benthic_file <- fo_benthic_destruction_md[[1]]
this_biomass_file <- fo_biomass_removal_md[[1]]

combined_raster_list <- 
  map2(.x = fo_benthic_destruction_md, .y = fo_biomass_removal_md, .f = \(this_benthic_file, this_biomass_file){
  
  this_source <- str_extract(this_benthic_file, pattern = "EPC|NAT|OTH")
  this_allocation_method <- str_extract(this_benthic_file, pattern = "ge_allocation|mass_allocation")
  
  saveName <- sprintf(here("data/spatial/marine_diet/int/fish oil_disturbance_km2_%s_%s.tif"), this_source, this_allocation_method)
  
  if(file.exists(saveName)){
    
    message("Processing, ", basename(saveName))
    
    this_benthic_r <- rast(this_benthic_file)
    this_biomass_r <- rast(this_biomass_file)
    
    this_combined_r <- (this_benthic_r+this_biomass_r)/2
    
    this_combined_r_reproj <- project(this_combined_r, gall_peters)
    
    this_km2_combined_r <- this_combined_r_reproj*cellSize(this_combined_r_reproj, unit="km")
    
    writeRaster(x = this_km2_combined_r, filename = saveName, overwrite=TRUE)
    
    return(this_km2_combined_r)
    
    
  }
})



#plant-diet 
fo_benthic_destruction_pd <- list.files(here("data/spatial/plant_diet/int"), pattern = "fish oil_benthic", full=TRUE)
fo_benthic_destruction_pd <- fo_benthic_destruction_pd[grepl("allocation", fo_benthic_destruction_pd)]

fo_biomass_removal_pd <- list.files(here("data/spatial/plant_diet/int"), pattern = "fish oil_biomass", full=TRUE) 
fo_biomass_removal_pd <- fo_biomass_removal_pd[grepl("allocation", fo_biomass_removal_pd)]

this_benthic_file <- fo_benthic_destruction_pd[[1]]
this_biomass_file <- fo_biomass_removal_pd[[1]]
  
  
combined_raster_list2 <- 
  map2(.x = fo_benthic_destruction_pd, .y = fo_biomass_removal_pd, .f = \(this_benthic_file, this_biomass_file){
  
  this_source <- str_extract(this_benthic_file, pattern = "EPC|NAT|OTH")
  this_allocation_method <- str_extract(this_benthic_file, pattern = "ge_allocation|mass_allocation")
  
  saveName <- sprintf(here("data/spatial/plant_diet/int/fish oil_disturbance_km2_%s_%s.tif"), this_source, this_allocation_method)
  
  message("Processing, ", basename(saveName))
  
  if(file.exists(saveName)){
    
    this_benthic_r <- rast(this_benthic_file)
    this_biomass_r <- rast(this_biomass_file)
    
    this_combined_r <- (this_benthic_r+this_biomass_r)/2
    
    this_combined_r_reproj <- project(this_combined_r, gall_peters)
    
    this_km2_combined_r <- this_combined_r_reproj*cellSize(this_combined_r_reproj, unit="km")
    
    writeRaster(x = this_km2_combined_r, filename = saveName, overwrite=TRUE)
    
    return(this_km2_combined_r)
    
  }

})


#quick check
plot(rast(combined_raster_list))
plot(rast(combined_raster_list2))

fo_benthic_destruction_md |> map(rast)
fo_benthic_destruction_pd |> map(rast)

fo_biomass_removal_md |> map(rast)
fo_biomass_removal_pd |> map(rast)




#clear the environment
rm(list = ls(all.names = TRUE))

```








Supplementary plots for benthic trawling used for forage fish and the differences in spatial forage catch with and without adjusting for npp.

```{r}

countries <- rnaturalearth::ne_countries(scale= "large", returnclass = "sf")
bbox <- ne_download(scale = 50, type = "wgs84_bounding_box", category = "physical", returnclass = "sf")

#We want the proportion of catch for forage fish with trawling as the proportion of forage fish catch


all_trawling_int_r <- rast(here("data/spatial/fisheries-effort/all_trawling_catch.tif"))
all_trawling_r <- resample(all_trawling_int_r, rast(res=0.5))


this_df |> 
    group_by(LonCentre, LatCentre) |> 
    summarise(forage_catch_mass = sum(fm_embodied_fish_mass, na.rm=TRUE))


forage_trawling <- fread(here("data/tidy_data/demand/embodied_fish_per_cell.csv")) |> 
  lazy_dt(immutable = FALSE) |> 
  filter(VBDesc == "bottom trawls" & diet=="marine_diet") |> 
  as_tibble() |> 
  group_by(LonCentre, LatCentre) |> 
  summarise(total_ind = sum(total_ind, na.rm = TRUE))


forage_trawling_int_r <- rast(forage_trawling, type="xyz", crs = "EPSG:4326")
forage_trawling_r <- resample(forage_trawling_int_r, rast(res=0.5))

prop_trawling_r <- forage_trawling_r/all_trawling_r

#all trawling effort
gfw_native_r <- rast(here("data/spatial/fisheries-effort/gfw_annual_effort_2017_trawlers.tif"))

#resample the forage trawling to same extent
resample_prop_trawling_r <- resample(prop_trawling_r, gfw_native_r)

#stack proportion of trawling for forage on total trawling
stack_trawling_effort_r <- c(resample_prop_trawling_r,gfw_native_r) 

#divide all trawling by total
forage_trawling_effort_r <- lapp(stack_trawling_effort_r, \(x,y){
  return(x*y)
})


# check
plot(forage_trawling_effort_r)


forage_trawling_effort_df <- terra::as.data.frame(forage_trawling_effort_r, xy = TRUE)

(forage_trawl_effort_p <- 
  ggplot()+
  geom_sf(data = bbox, fill = "grey10")+
  geom_sf(data = countries)+
  geom_tile(data = forage_trawling_effort_df, aes(x = x, y=y, fill = lyr1))+
  theme_void()+
  theme(legend.text = element_text(size = 8), legend.title = element_text(size= 8))+
  scale_fill_gradientn(colours = rcartocolor::carto_pal(n = 7, name = "TealGrn"))+
  labs(fill = "Bottom trawl\neffort (hours)",))



forage_catch <- fread(here("data/tidy_data/demand/embodied_fish_per_cell.csv")) |> 
  lazy_dt(immutable = FALSE) |> 
  filter( diet == "marine_diet") |> 
  as_tibble() |> 
  group_by(LonCentre, LatCentre) |> 
  summarise(total_ind = sum(total_ind, na.rm = TRUE))


(forage_catch_p <- 
  ggplot()+
  geom_sf(data = bbox, fill = "grey10")+
  #geom_sf(data = countries)+
    geom_tile(data = forage_catch, aes(x = LonCentre, y= LatCentre, fill = (total_ind)))+
  theme_void()+
  theme(legend.text = element_text(size = 8), legend.title = element_text(size= 8))+
    scale_fill_gradientn(colours = viridis::cividis(n=7, direction =1))+
  #scale_fill_gradientn(colours = rcartocolor::carto_pal(n = 7, name = "TealGrn"))+
  labs(fill = "Forage fish\ncatch (tonnes)",
       trans = "log10"))


npp_r <- rast(here("data/spatial/00-net-primary-productivity/annal_mean_npp_2015_gf_wgs.tif"))

forage_catch_r <- rast(forage_catch, type = "xyz", crs="EPSG:4326") |> resample(rast(res=0.5))


npp_adj_forage_catch_r <- lapp(c(forage_catch_r, npp_r), \(x,y){
  return(x/y)
})

npp_adj_forage_catch_df <- terra::as.data.frame(npp_adj_forage_catch_r, xy = TRUE)



(npp_p <- 
  ggplot()+
  geom_sf(data = bbox, fill = "grey10")+

    geom_tile(data = npp_r |> terra::as.data.frame(xy=TRUE), aes(x = x, y= y, fill = annal_mean_npp_2015_gf_wgs))+
      geom_sf(data = countries)+
  theme_void()+
  theme(legend.text = element_text(size = 8), legend.title = element_text(size= 8))+
  scale_fill_gradientn(colours = viridis::cividis(n=7, direction =1))+
    #scale_fill_gradientn(colours = rcartocolor::carto_pal(n = 7, name = "TealGrn"))+
  labs(fill = "Net primary \nproductivity\n(mg C/m2/day)"))

npp_p /
forage_trawl_effort_p+
  plot_annotation(tag_levels = "a")&
  theme(plot.tag = element_text(size =12),
        plot.tag.position = "topleft")

ggsave(filename = here("figures/supplementary/npp_and_benthic_trawling.jpg"), device = "jpeg", dpi=600, width = 18, height=17, units="cm")
```








#plots for presos

```{r}


extent <- st_bbox(ext(c(-180, -40, -90, 90)))

forage_catch_md_epc <-  raster::raster(rast(here("data/spatial/fisheries-catch/forage_fish_catch_marine_diet_EPC.tif"))) |> as("SpatialPointsDataFrame") |> as.data.frame()

forage_catch_pd_nat <-  raster::raster(rast(here("data/spatial/fisheries-catch/forage_fish_catch_plant_diet_NAT.tif"))) |> as("SpatialPointsDataFrame") |> as.data.frame()

forage_catch_md_oth <- raster::raster(rast(here("data/spatial/fisheries-catch/forage_fish_catch_marine_diet_OTH.tif"))) |> as("SpatialPointsDataFrame") |> as.data.frame()


ggplot()+
  geom_sf(data = countries |> filter(region_wb %in% c("Latin America & Caribbean" , "North America")), colour = NA, fill = "grey70")+
  geom_tile(data = forage_catch_md_epc, aes(x = x, y = y, fill = log10(catch+1)))+
  theme_bw()+
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank())+
  guides(fill = "none")+
  scale_fill_gradientn(colours = RColorBrewer::brewer.pal(n = 5, name = "Blues"))
  
ggsave(filename = here("figures/presos/forage_fish_catch_md_EPC.jpg"), device = "jpg", dpi = 600, width = 5, height = 5, units = "cm")
  

europe <- countries |> filter(iso_a3 %in% c("ALB", "AUT", "BEL", "BGR", "BIH", "BLR", "CHE", "CZE", "DEU", "DNK", "ESP", "EST", "FIN", "FRA", "GBR", "GRC", "HRV", "HUN", "IRL", "ISL", "ITA", "LTU", "LUX", "LVA", "MDA", "MKD", "MNE", "NLD", "NOR", "POL", "PRT", "ROU", "SRB", "SVK", "SVN", "SWE", "UKR"))
unique(europe$iso_a3)


extent <- ext(c(xmin = -54.524754, xmax= 40.080789, ymin=  10 ,  ymax = 80.657144))


ggplot()+
  geom_tile(data = forage_catch_pd_nat, aes(x = x, y = y, fill = log10(catch+1)))+
  geom_sf(data = europe |> st_crop(st_bbox(extent)), colour = NA, fill = "grey70")+
  theme_bw()+
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank())+
  guides(fill = "none")+
  scale_fill_gradientn(colours = RColorBrewer::brewer.pal(n = 5, name = "Blues"))
  
ggsave(filename = here("figures/presos/forage_fish_catch_pd_NAT.jpg"), device = "jpg", dpi = 600, width = 5, height = 5, units = "cm")


ggplot()+
  geom_tile(data = forage_catch_md_oth, aes(x = x, y = y, fill = log10(catch+1)))+
  geom_sf(data = countries , colour = NA, fill = "grey70")+
  theme_bw()+
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank())+
  guides(fill = "none")+
  scale_fill_gradientn(colours = RColorBrewer::brewer.pal(n = 5, name = "Blues"))
  
ggsave(filename = here("figures/presos/forage_fish_catch_md_OTH.jpg"), device = "jpg", dpi = 600, width = 5, height = 5, units = "cm")



#EPC

disturbance_md <- terra::as.data.frame(x = rast(here("data/spatial/marine_diet/pressures/forage_fish_disturbance_EPC.tif")), xy = TRUE)


ggplot()+
  geom_sf(data = countries |> filter(region_wb %in% c("Latin America & Caribbean" , "North America")), colour = NA, fill = "grey70")+
  geom_tile(data = disturbance_md, aes(x = x, y = y, fill = log10(forage_fish_disturbance_EPC+1)))+
  theme_bw()+
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank())+
  guides(fill = "none")+
  scale_fill_gradientn(colours = RColorBrewer::brewer.pal(n = 5, name = "YlOrRd"))
  
ggsave(filename = here("figures/presos/forage_fish_distrubance_md_EPC.jpg"), device = "jpg", dpi = 600, width = 5, height = 5, units = "cm")


disturbance_pd <- terra::as.data.frame(x = rast(here("data/spatial/plant_diet/pressures/forage_fish_disturbance_pressure_plant_diet_EPC.tif")), xy = TRUE)

ggplot()+
  geom_sf(data = countries |> filter(region_wb %in% c("Latin America & Caribbean" , "North America")), colour = NA, fill = "grey70")+
  geom_tile(data = disturbance_pd, aes(x = x, y = y, fill = log10(lyr.1+1)))+
  theme_bw()+
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank())+
  guides(fill = "none")+
  scale_fill_gradientn(colours = RColorBrewer::brewer.pal(n = 5, name = "Reds"))
  

ggsave(filename = here("figures/presos/forage_fish_distrubance_pd_EPC.jpg"), device = "jpg", dpi = 600, width = 5, height = 5, units = "cm")



ghg_md <- terra::as.data.frame(x = rast(here("data/spatial/marine_diet/int/forage_fish_ghg_raw_marine_diet_EPC.tif")), xy = TRUE)

ggplot()+
  geom_sf(data = countries |> filter(region_wb %in% c("Latin America & Caribbean" , "North America")), colour = NA, fill = "grey70")+
  geom_tile(data = ghg, aes(x = x, y = y, fill = log10(total_GWP_km2+1)))+
  theme_bw()+
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank())+
  guides(fill = "none")+
  scale_fill_gradientn(colours = RColorBrewer::brewer.pal(n = 5, name = "Purples"))
  
ggsave(filename = here("figures/presos/forage_fish_ghg_md_EPC.jpg"), device = "jpg", dpi = 600, width = 5, height = 5, units = "cm")

ghg_pd <- terra::as.data.frame(x = rast(here("data/spatial/plant_diet/int/forage_fish_ghg_raw_plant_diet_EPC.tif")), xy = TRUE)

ggplot()+
  geom_sf(data = countries |> filter(region_wb %in% c("Latin America & Caribbean" , "North America")), colour = NA, fill = "grey70")+
  geom_tile(data = ghg_pd, aes(x = x, y = y, fill = log10(total_GWP_km2+1)))+
  theme_bw()+
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank())+
  guides(fill = "none")+
  scale_fill_gradientn(colours = RColorBrewer::brewer.pal(n = 5, name = "Greens"))
  
ggsave(filename = here("figures/presos/forage_fish_ghg_pd_EPC.jpg"), device = "jpg", dpi = 600, width = 5, height = 5, units = "cm")


ggplot()+
  geom_sf(data = countries |> filter(region_wb %in% c("Latin America & Caribbean" , "North America")), colour = NA, fill = "grey70")+
  geom_tile(data = ghg, aes(x = x, y = y, fill = log10(total_GWP_km2+1)))+
  theme_bw()+
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank())+
  guides(fill = "none")+
  scale_fill_gradientn(colours = RColorBrewer::brewer.pal(n = 5, name = "Greens"))
  


#NAT 



disturbance_md_nat <- terra::as.data.frame(x = rast(here("data/spatial/marine_diet/pressures/forage_fish_disturbance_pressure_marine_diet_NAT.tif")), xy = TRUE)


ggplot()+
  geom_tile(data = disturbance_md_nat, aes(x = x, y = y, fill = log10(lyr.1+1)))+
  geom_sf(data = europe |> st_crop(st_bbox(extent)), colour = NA, fill = "grey70")+
  theme_bw()+
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank())+
  guides(fill = "none")+
  scale_fill_gradientn(colours = RColorBrewer::brewer.pal(n = 5, name = "YlOrRd"))
  
ggsave(filename = here("figures/presos/forage_fish_distrubance_md_NAT.jpg"), device = "jpg", dpi = 600, width = 5, height = 5, units = "cm")


disturbance_pd_NAT <- terra::as.data.frame(x = rast(here("data/spatial/plant_diet/pressures/forage_fish_disturbance_pressure_plant_diet_NAT.tif")), xy = TRUE)

ggplot()+
  
  geom_tile(data = disturbance_pd_NAT, aes(x = x, y = y, fill = log10(lyr.1+1)))+
  geom_sf(data = europe |> st_crop(st_bbox(extent)), colour = NA, fill = "grey70")+
  theme_bw()+
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank())+
  guides(fill = "none")+
  scale_fill_gradientn(colours = RColorBrewer::brewer.pal(n = 5, name = "Reds"))
  

ggsave(filename = here("figures/presos/forage_fish_distrubance_pd_NAT.jpg"), device = "jpg", dpi = 600, width = 5, height = 5, units = "cm")



ghg_md_nat <- terra::as.data.frame(x = rast(here("data/spatial/marine_diet/int/forage_fish_ghg_raw_marine_diet_NAT.tif")), xy = TRUE)

ggplot()+
  geom_tile(data = ghg_md_nat, aes(x = x, y = y, fill = log10(total_GWP_km2+1)))+
  geom_sf(data = europe |> st_crop(st_bbox(extent)), colour = NA, fill = "grey70")+
  theme_bw()+
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank())+
  guides(fill = "none")+
  scale_fill_gradientn(colours = RColorBrewer::brewer.pal(n = 5, name = "Purples"))
  
ggsave(filename = here("figures/presos/forage_fish_ghg_md_NAT.jpg"), device = "jpg", dpi = 600, width = 5, height = 5, units = "cm")

ghg_pd_nat <- terra::as.data.frame(x = rast(here("data/spatial/plant_diet/int/forage_fish_ghg_raw_plant_diet_NAT.tif")), xy = TRUE)

ggplot()+
  geom_tile(data = ghg_pd_nat, aes(x = x, y = y, fill = log10(total_GWP_km2+1)))+
  geom_sf(data = europe |> st_crop(st_bbox(extent)), colour = NA, fill = "grey70")+
  theme_bw()+
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank())+
  guides(fill = "none")+
  scale_fill_gradientn(colours = RColorBrewer::brewer.pal(n = 5, name = "Greens"))
  
ggsave(filename = here("figures/presos/forage_fish_ghg_pd_NAT.jpg"), device = "jpg", dpi = 600, width = 5, height = 5, units = "cm")








```


