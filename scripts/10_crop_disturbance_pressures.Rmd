---
title: "11_crop_disturbance_pressures"
author: "Rich Cottrell"
date: "29/06/2022"
output: html_document
---

Here we use the MAPSPAM physical area parameter as our disturbance metric for crops following the assumptions of Halpern et al 2022 that cropland creates complete disturbance to natural systems where they exist.

```{r}
library(tidyverse)
library(terra)
library(here)
library(countrycode)




source(here("src/directories.R"))

```

Import the crop demand data to get the FAO-MAPSPAM look up names. Also import the area harvested data to use as a proxy to understand how physical area may have changed based on the trend in area 

```{r}

mapspam_fao_lookup <- 
  readRDS(here("data/tidy_data/demand/total_crop_demand.rds")) |> 
  select(FAOSTAT_name, map_spam_code, source_country) |> 
  distinct() |> 
  mutate(map_spam_code = toupper(map_spam_code),
         iso3c = countrycode(sourcevar = source_country, origin = "country.name", destination = "iso3c", warn=TRUE))



crop_area <- 
  readRDS(here("data/tidy_data/production-data/crops_production_tidy.rds")) |> 
  filter(element == "Area harvested") |> 
  filter(item %in% unique(mapspam_fao_lookup$FAOSTAT_name)) |> 
  filter(year %in% c(2010, 2017)) |> 
  mutate(value_km2 = value*0.01) |> 
  select(area, iso3c, item, element, year, value_km2) |> 
  pivot_wider(id_cols = c(area, iso3c, item, element), names_from = year, values_from = value_km2) |> 
  mutate(rel_change = `2017`/`2010`) |> 
  filter(area != "China")
  
```

Import the demand-production comparisons for crops to adjust the physical area (under the assumption it is yields that have increased).

```{r}

crop_sources <- readRDS(here("data/tidy_data/demand/crop_sourcing_countries_plausible_impacts.rds")) 

demand_production_compare <- readRDS(here("data/tidy_data/demand/crop_demand_production_compare.rds")) |>
  filter(total_ingredient_demand > 0) |> 
  group_split(ingredients, diet, map_spam_code)

this_crop <- demand_production_compare[[1]]

#filter the production compare by the sources used in the analysis

demand_production_compare_w_sources <- 
  
  map_df(demand_production_compare, \(this_crop){
  
  sources <- crop_sources |> filter(FAOSTAT_name == unique(this_crop$FAOSTAT_name)) |> pull(iso3c)
  
  this_crop_adj <- this_crop |> filter(iso3c %in% sources)
}) |> 
  filter(!(FAOSTAT_name == "Linseed" & source_iso3c %in% c("CHN", "GBR"))) |> 
  filter(demand_production_ratio>0)

```

Check the area harvested from FAOSTAT with physical area from MAPSPAM to identify the discrepencies and fix by adjustment factors based on the greatest area harvested in either 2010 or 2017.

```{r}

crop_area_files <- list.files(here("data/spatial/crop-layers-reprojected"), pattern = "_A_", full.names = TRUE)

country_rast_files <- list.files(here("data/spatial/country-rasters"), full.names = TRUE)

countries_of_interest <- 
  country_rast_files |> map(\(this_element){
  this_file <- tools::file_path_sans_ext(this_element)
  this_country <- substr(this_file, start = nchar(this_file)-2, stop = nchar(this_file))
  return(this_country)
}) |> unlist()

crop_area_data <- crop_area |> 
  filter(iso3c %in% countries_of_interest) |> 
  group_by(item, iso3c, area) |> 
  group_split()

this_country_crop <- crop_area_data[[1]]

mapspam_fao_compare <- 
  
  map_df(.x = crop_area_data, .f = \(this_country_crop){
  
  this_iso3 <- this_country_crop$iso3c
  this_item <- this_country_crop$item
  this_mapsam_code <- mapspam_fao_lookup |> filter(FAOSTAT_name == this_item) |> pull(map_spam_code) |> unique()
  
  message("Calculating area for ", "'", this_mapsam_code, "'", " in ", this_iso3)
  
  this_country_rast <- rast(country_rast_files[grep(this_iso3, country_rast_files)])
  vals <- values(this_country_rast)
  
  (this_global_crop_rast <- rast(crop_area_files[grep(this_mapsam_code, crop_area_files)]))
  
  (this_country_crop_rast <- this_global_crop_rast*this_country_rast)
  
  mapspam_value <- sum(values(this_country_crop_rast), na.rm=TRUE)
  
  return(this_country_crop |> mutate(mapspam_value = mapspam_value))

}) |> 
  mutate(mapspam_value = mapspam_value) |> 
  mutate(adjustment_factor= case_when(is.na(`2017`)|is.na(`2010`) ~ 0,
                                      `2017` > `2010` ~ `2017`/mapspam_value,
                                       `2010` > `2017` ~ `2010`/mapspam_value))




```


Adjust area rasters by the demand_production ratio and save in the int folder for each diet.

```{r}

crop_area_files <- list.files(here("data/spatial/crop-layers-reprojected"), pattern = "_A_", full.names = TRUE)

country_rast_files <- list.files(here("data/spatial/country-rasters"), full.names = TRUE)

scalar_source_list <- 
  demand_production_compare_w_sources |> 
  left_join( y = mapspam_fao_compare, by = c("source_country" = "area", "iso3c", "FAOSTAT_name" = "item")) |> 
  group_split(ingredients, diet, FAOSTAT_name, source_iso3c) 
  
this_file <- scalar_source_list[[1]]


#rescale area by the demand-production ratio and save the rasters for each diet, ingredient, raw material
map(.x = scalar_source_list, \(this_file){
  
  this_ingredient <- this_file$ingredients 
  
  this_mapspam_code <- toupper(this_file$map_spam_code)
 
  this_diet <- this_file$diet
  
  this_country <- this_file$source_iso3c
  
  this_demand_scalar <- this_file$demand_production_ratio
  
  this_raster_scalar <- this_file$adjustment_factor
  
  saveName <- sprintf(here("data/spatial/%s/int/%s_disturbance_km2_%s.tif"), this_diet, this_ingredient, this_country)
  
  if(file.exists(saveName)){
    
    #raw area rasters are already in km2 so no need to convert
    this_raw_rast <- rast(crop_area_files[grepl(this_mapspam_code, crop_area_files)]) 
  
    this_country_rast <- rast(country_rast_files[grepl(this_country, country_rast_files)])
    
    this_country_area_rast <- this_raw_rast*this_country_rast*this_raster_scalar*this_demand_scalar
    
    #check
    check_vals <- values(!is.na(this_country_area_rast/cellSize(this_country_area_rast))) |> as.numeric()
    
    message("Are any cells greater than cell size? ",  max(check_vals)>1)
    
    
    writeRaster(x= this_country_area_rast, filename = saveName, overwrite=TRUE)

  }
})


```

