---
title: "Exploring biodiversity files"
output: html_document
---

This script explores the raw biodiversity shapefiles from IUCN and birds of the world stored on the rdsi storage.

Libraries
```{r setup, include=FALSE}

library(tidyverse)
library(here)
library(sf)
library(data.table)
library(dtplyr)
library(terra)
library(parallel)

source(here("src/directories.R"))

source(here("src/spatial.R"))

base_raster_ea <- rast(here("data/spatial/base_raster_gall_peters.tif"))

iucn_rich_local_dir <- "/Users/rsc2/Dropbox/Data/IUCN Red List"


```

Import threat data
```{r}

current_severe_threats_of_interest <- read_csv(here("data/tidy_data/iucn/current_severe_threats_of_interest.csv")) |> 
  rename(id_no = id)
  
#how many species fall in to te category of being affected by these threats? 12728 species
length(unique(current_severe_threats_of_interest$id_no))

#ongoing threats represent 93.9% of all threats
current_severe_threats_of_interest |> filter(result_timing == "Ongoing") |> nrow()/(current_severe_threats_of_interest |> nrow())



```




Convert birds of the world from gdb to shapefile. This works on my local device but not on my NECTAR Cloud RStudio, weirdly. So copied the exported version to the RDSI storage in 'iucn_dir'
```{r}



birds_layers <- st_layers(file.path(iucn_dir, "spp_shapefiles/BOTW/BOTW.gdb"))


birds_gdb_file <- file.path(iucn_dir, "spp_shapefiles/BOTW/BOTW.gdb")

birds_local_gdb_file <- file.path(iucn_rich_local_dir, "BOTW/BOTW.gdb")

  
botw <- st_read(dsn = birds_local_gdb_file, layer = "All_Species")

n_groups <- 3
(len_groups <- (nrow(botw)/n_groups))

botw %>% 
  mutate(index = rep(1:n_groups, each=len_groups)) %>% 
  group_by(index) %>% 
  nest() %>% 
  mutate(txt = walk2(.x = data, .y = index, ~st_write(obj = .x, dsn = paste0(iucn_rich_local_dir, "/BOTW/BOTW_PART_", .y, ".shp"))))



```


Explore taxa with multiple shapefiles to see if they can be combined.

```{r}

taxon_list <- list.files(file.path(iucn_dir, "spp_shapefiles"))[-grep(pattern = "BOTW|hybas_table|FW_GROUP", list.files(file.path(iucn_dir, "spp_shapefiles")))] #excluding birds of the world and hybas tables
```




All shapefiles 
```{r}

#this can be a bit buggy - takes A LONG TIME to run. Had to restart a few times as kills the memory, something to try to fix. For now splitting the list into chunks of three.

#RUN 1
map(.x = taxon_list, .f = \(this_taxon){
  
  message("processing ", this_taxon) 
  
  #read in shp files - can be multiple per taxon
  this_taxons_shpfiles <- list.files(file.path(iucn_dir, sprintf("spp_shapefiles/%s/", this_taxon)), pattern = "\\.shp$")
  
  #read in each in the list of shp files
    
  this_taxon_shp_list <- mclapply(X=this_taxons_shpfiles, 
                       FUN = \(this_shp){
                         st_read(dsn = paste0("/mnt/rdsi/raw_data/iucn/spp_shapefiles/", this_taxon) , layer =  tools::file_path_sans_ext(this_shp))  
                       },
                       mc.cores=detectCores()-2)
  
  #filter for extant species and those we know to have ongoing (or past likely to reoccur threats that cause at least slow but substantial declines)
  this_taxon_shp <- bind_rows(this_taxon_shp_list) |> 
    filter(grepl("Extant", legend) & presence == 1) #|> 
    #filter(id_no %in% current_severe_threats_of_interest$id_no)
  
  #isolate the species
  these_spp <- unique(this_taxon_shp$id_no)
  
  
  #cycle through the species
  mclapply(X = these_spp, FUN = \(this_spp){
    
    spp_raster_filepath <- file.path(iucn_dir, sprintf("spp_rasters/spp_%s.tif", this_spp))
    
    #does this file path exist? If not create the file
    if(!file.exists(spp_raster_filepath)){
      
      this_spp_shp <- this_taxon_shp |> filter(id_no == this_spp) |> st_transform(crs = equal_area_gp_proj)
      
      this_spp_raster <- rasterize(vect(this_spp_shp), base_raster_ea)
      
      writeRaster(x = this_spp_raster, filename = spp_raster_filepath, overwrite=TRUE)
      }
  },
  
  mc.cores = detectCores()-2)}
  )









#RUN 2
 map(.x = taxon_list[11:20], .f = \(this_taxon){
  
  message("processing ", this_taxon) 
   
   
  #read in shp files - can be multiple per taxon
  this_taxons_files <- list.files(file.path(iucn_dir, sprintf("spp_shapefiles/%s/", this_taxon)), pattern = "\\.shp$", full.names = TRUE)
  
  #read in each in the list of shp files
  this_taxon_shp_list <- mclapply(X=this_taxons_files, 
                       FUN = st_read, 
                       mc.cores = detectCores()-2)
  
  #filter for extant species and those we know to have ongoing (or past likely to reoccur threats that cause at least slow but substantial declines)
  this_taxon_shp <- bind_rows(this_taxon_shp_list) |> 
    filter(grepl("Extant", legend) & presence == 1) |> 
    filter(id_no %in% current_severe_threats_of_interest$id_no)
  
  #isolate the species
  these_spp <- unique(this_taxon_shp$id_no)
  
  
  #cycle through the species
  mclapply(X = these_spp, FUN = \(this_spp){
    
    spp_raster_filepath <- file.path(iucn_dir, sprintf("spp_rasters/spp_%s.tif", this_spp))
    
    #does this file path exist? If not create the file
    if(!file.exists(spp_raster_filepath)){
      
      this_spp_shp <- this_taxon_shp |> filter(id_no == this_spp) |> st_transform(crs = equal_area_gp_proj)
      
      this_spp_raster <- rasterize(vect(this_spp_shp), base_raster_ea)
      
      writeRaster(x = this_spp_raster, filename = spp_raster_filepath, overwrite=TRUE)
      }
  },
  
  mc.cores = detectCores()-2)}
  ) 
  
 
 #RUN 3
 
 map(.x = taxon_list[21:length(taxon_list)], .f = \(this_taxon){
   
   message("processing ", this_taxon) 
  
  #read in shp files - can be multiple per taxon
  this_taxons_files <- list.files(file.path(iucn_dir, sprintf("spp_shapefiles/%s/", this_taxon)), pattern = "\\.shp$", full.names = TRUE)
  
  #read in each in the list of shp files
  this_taxon_shp_list <- mclapply(X=this_taxons_files, 
                       FUN = st_read, 
                       mc.cores = detectCores()-2)
  
  #filter for extant species and those we know to have ongoing (or past likely to reoccur threats that cause at least slow but substantial declines)
  this_taxon_shp <- bind_rows(this_taxon_shp_list) |> 
    filter(grepl("Extant", legend) & presence == 1) |> 
    filter(id_no %in% current_severe_threats_of_interest$id_no)
  
  #isolate the species
  these_spp <- unique(this_taxon_shp$id_no)
  
  
  #cycle through the species
  mclapply(X = these_spp, FUN = \(this_spp){
    
    spp_raster_filepath <- file.path(iucn_dir, sprintf("spp_rasters/spp_%s.tif", this_spp))
    
    #does this file path exist? If not create the file
    if(!file.exists(spp_raster_filepath)){
      
      this_spp_shp <- this_taxon_shp |> filter(id_no == this_spp) |> st_transform(crs = equal_area_gp_proj)
      
      this_spp_raster <- rasterize(vect(this_spp_shp), base_raster_ea)
      
      writeRaster(x = this_spp_raster, filename = spp_raster_filepath, overwrite=TRUE)
      }
  },
  
  mc.cores = detectCores()-2)}
  )
  







```

