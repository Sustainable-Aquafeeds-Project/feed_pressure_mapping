---
title: "Visualisation of results"
author: "Rich Cottrell"
date: '2023-11-06'
output: html_document
---

```{r setup, include=FALSE}

library(tidyverse)
library(here)
library(patchwork)
library(rcartocolor)
library(RColorBrewer)
library(ggpubr)
library(ggpattern)
library(egg)

source(here("src/functions.R"))

select <- dplyr::select
values <- terra::values


#ALLOCATION METHOD (un-comment preference)
this_allocation_method <- "econ_allocation"
# this_allocation_method <- "ge_allocation"
# this_allocation_method <- "mass_allocation"



```


Pull in permuted data

```{r}


all_data <- readRDS(file = sprintf(here("data/tidy_data/pressures/marine_plant_disaggregated_pressures_by_ingredient_combined_df_%s.rds"),this_allocation_method))



```

Summarise and plot by CPI total
```{r}

cpi_total <- all_data |> 
  group_by(source, diet) |> 
  summarise(cpi = sum(sum, na.rm=TRUE)) |> 
  arrange(source)

my_pal <- rcartocolor::carto_pal(n = 8, name = "Bold")[c(1, 3, 7, 2)]


both_diet_means <- tibble(diet = c("Fish-\ndominant\nfeed", "Plant-\ndominant\nfeed"), 
                          mean_CPI = c(cpi_total |> filter(diet == "marine diet") |> pull(cpi) |> mean(), 
                                       cpi_total |> filter(diet == "plant diet") |> pull(cpi) |> mean()))


(both_diets_agg_p <- 
    ggplot(data = cpi_total |> mutate(diet = case_when(diet == "plant diet" ~ "Plant-\ndominant\nfeed",
                                                         diet == "marine diet" ~ "Fish-\ndominant\nfeed"),
                                        diet = factor(diet, levels = c("Plant-\ndominant\nfeed", "Fish-\ndominant\nfeed"))))+
  aes(x = cpi, y = diet, colour = diet)+
    geom_jitter(shape =20, size = 1.8, alpha = 0.1, height = 0.4
  )+
  # ggdist::stat_gradientinterval(
  #   width = .3, color = "black", fill_type = "gradient"
  # )+
  scale_colour_manual(values = my_pal[c(4,2)], guide = "none")+
  scale_x_continuous(limits = c(0.5,3))+
  theme_pubr()+
  geom_boxplot(notch = TRUE, colour = "grey40", width = 0.2, alpha = 0, linewidth=0.5)+
  geom_point(data = both_diet_means, aes(y = diet, x=mean_CPI), colour = "red", size = 1, alpha = 0.7, shape = 0)+
  labs(y = "Diet", x = "Cumulative pressure index (CPI)")+
  theme(text = element_text(size=8),
        axis.text = element_text(size=8),
        axis.title = element_text(size=8),
        axis.title.y = element_blank()))


ggsave(filename = sprintf(here("figures/diet_permutation_comparisons_%s.jpg"), this_allocation_method), device = "jpg", dpi = 600, width = 8.9, height = 5, units="cm")

```

Visualise the CPI by pressure across diets

```{r}
cpi_by_pressure <- 
  all_data |> 
  group_by(diet, source, pressure) |> 
  summarise(cpi_cont = sum(sum, na.rm=TRUE)) |> 
  mutate(pressure = factor(pressure, levels = rev(c("GHG", "Disturbance", "Nutrients", "Water"))))


my_pal <- rcartocolor::carto_pal(n = 8, name = "Bold")[c(1, 3, 7, 2)]


ggplot(data = cpi_by_pressure |> 
                              mutate(diet = case_when(diet == "plant diet" ~ "Plant-dominant\nfeed",
                                                      diet == "marine diet" ~ "Fish-dominant\nfeed"),
                                                      diet = factor(diet, levels = c("Plant-dominant\nfeed", "Fish-dominant\nfeed"))))+
  aes(x = cpi_cont, y = pressure, fill = diet)+
  geom_point(pch = 21, position = position_jitterdodge(jitter.width = 0.5), alpha = 0.1)+
  geom_boxplot(notch = TRUE, colour = "grey35", alpha = 0.4, linewidth=0.5, outlier.alpha = 0)+
  scale_fill_manual(values = (my_pal[c(4,2)]))+
  scale_x_continuous(limits = c(0,1.2), breaks = c(0,0.25,0.5,0.75, 1))+
  theme_pubr()+
  theme(legend.position = c(0.87, 0.15),
        legend.background = element_rect(fill="transparent"),
        legend.title = element_blank(),
        text = element_text(size=8),
        axis.title = element_text(size=8),
        axis.title.y = element_blank())+
  labs(x = "CPI contribution")

ggsave(filename = sprintf(here("figures/disaggregation_of_pressures_%s.jpg"), this_allocation_method), width = 12, height=9, units = "cm", device = "jpg", dpi = 600)
```

Dig into why disturbance is so fragmented
```{r}


# processing_prop_CPI <- 
#   all_data |> 
#   group_by(source, pressure, diet) |> 
#   nest() |> 
#   mutate(CPI_cont_total = map(data, ~(sum(.$sum, na.rm=TRUE)))) |> 
#   unnest(cols = c(data, CPI_cont_total)) |> 
#   ungroup() |> 
#   mutate(prop_CPI_cont = sum/CPI_cont_total) |> 
#   group_by(pressure, diet, stage) |> 
#   summarise(mean_prop_CPI_cont = mean(prop_CPI_cont, na.rm=TRUE),
#             sd_prop_CPI_cont = sd(prop_CPI_cont, na.rm=TRUE))
#   
  

cpi_by_pressure_stage <- 
  all_data |> 
  group_by(diet, source, stage, pressure) |> 
  summarise(cpi_cont = sum(sum, na.rm=TRUE)) |> 
  mutate(pressure = factor(pressure, levels = rev(c("GHG", "Disturbance", "Nutrients", "Water"))))


my_pal <- rcartocolor::carto_pal(n = 8, name = "Bold")[c(1, 3, 7, 2)]


ggplot(data = cpi_by_pressure_stage |> 
                              mutate(diet = case_when(diet == "plant diet" ~ "Plant-dominant\nfeed",
                                                      diet == "marine diet" ~ "Fish-dominant\nfeed"),
                                                      diet = factor(diet, levels = c("Plant-dominant\nfeed", "Fish-dominant\nfeed")),
                                     stage = factor(stage, levels = c("production", "processing"))))+
  aes(x = cpi_cont, y = pressure, fill = diet)+
  geom_point(pch = 21, position = position_jitterdodge(jitter.width = 0.5), alpha = 0.1)+
  geom_boxplot(notch = TRUE, colour = "grey35", alpha = 0.4, linewidth=0.5, outlier.alpha = 0)+
  facet_grid(rows = vars(stage))+
  scale_fill_manual(values = (my_pal[c(4,2)]))+
  scale_x_continuous(limits = c(0,1.01), breaks = c(0,0.25,0.5,0.75, 1))+
  theme_bw()+
  theme(legend.position = c(0.8, 0.1),
        legend.background = element_rect(fill="transparent"),
        legend.title = element_blank(),
        panel.grid = element_blank(),
        text = element_text(size=8),
        panel.border = element_rect(colour = "black", linewidth = 0.5),
        axis.text = element_text(size=8),
        axis.title = element_text(size=8),
        axis.title.y = element_blank())+
  labs(x = "CPI contribution")

ggsave(filename = sprintf(here("figures/disaggregation_of_pressures_and_stage_%s.jpg"), this_allocation_method), width = 12, height=15, units = "cm", device = "jpg", dpi = 600)
```

Breakdown by ingredient and the distribution of ingredient contributions
```{r}

ingredient_totals <- 
  all_data |> 
  group_by(diet, ingredient, pressure, source) |> 
  summarise(sum = sum(sum, na.rm = TRUE))

 
ggplot(data = ingredient_totals |> mutate(diet = case_when(diet == "marine diet" ~ "Fish-dominant diet",
                                                           TRUE ~ "Plant-dominant diet")), 
       aes(x = str_to_sentence(ingredient), y= sum, fill = diet))+
  facet_grid(cols = vars(pressure))+
  geom_point(pch = 21, size= 1, position = position_jitterdodge(jitter.width = 0.15), alpha = 0.1, stroke=0.1)+
  geom_boxplot(colour = "grey35", alpha = 0.4, linewidth=0.2, outlier.alpha = 0, width = 0.8)+
  scale_fill_manual(values = rev(my_pal[c(4,2)]))+
  theme_bw()+
  theme(legend.position = "bottom",
        legend.background = element_rect(fill="transparent"),
        legend.title = element_blank(),
        panel.grid = element_blank(),
        text = element_text(size=8),
        panel.border = element_rect(colour = "black", linewidth = 0.5),
        axis.text = element_text(size=8),
        axis.title = element_text(size=8),
        axis.title.y = element_blank())+
  coord_flip()+
  labs(y="CPI contribution")

ggsave(filename = sprintf(here("figures/disaggregation_of pressure_by_ingredient_%s.jpg"), this_allocation_method) , dpi = 600, device = "jpeg", width = 18, height = 12, units = "cm")


#proportion of the CPI

ingredient_prop <- 
  all_data |> 
  group_by(diet, ingredient, pressure, source) |> 
  summarise(sum = sum(sum, na.rm = TRUE)) |> 
  ungroup() |> 
  group_by(source) |> 
  nest() |> 
  mutate(CPI = map(data, ~(sum(.$sum)))) |> 
  unnest(cols = c(data, CPI)) |> 
  ungroup() |> 
  mutate(prop_CPI = sum/CPI)


ggplot(data = ingredient_prop |> 
         mutate(diet = case_when(diet == "marine diet" ~ "Fish-dominant diet",
                                                           TRUE ~ "Plant-dominant diet"),
                pressure = factor(pressure, levels = c("GHG", "Disturbance", "Nutrients", "Water"))), 
       aes(x = str_to_sentence(ingredient), y= prop_CPI, fill = diet))+
  facet_grid(cols = vars(pressure))+
  geom_point(pch = 21, size= 1, position = position_jitterdodge(jitter.width = 0.3), alpha = 0.1, stroke=0.1)+
  geom_boxplot(colour = "grey35", alpha = 0.4, linewidth=0.2, outlier.alpha = 0, width = 0.8)+
  scale_fill_manual(values = rev(my_pal[c(4,2)]))+
  theme_bw()+
  theme(legend.position = "bottom",
        legend.background = element_rect(fill="transparent"),
        legend.title = element_blank(),
        panel.grid = element_blank(),
        text = element_text(size=8),
        panel.border = element_rect(colour = "black", linewidth = 0.5),
        axis.text = element_text(size=8),
        axis.title = element_text(size=8),
        axis.title.y = element_blank())+
  coord_flip()+
  labs(y="Proportion of CPI")

ggsave(filename = sprintf(here("figures/disaggregation_of_CPI_proportion_by_ingredient_%s.jpg"), this_allocation_method) , dpi = 600, device = "jpeg", width = 18, height = 12, units = "cm")


#Normalised pressure per tonne per ingredient - so essentially presenting the information at the level of the LCA (but using normalised units)

ingredient_prop <- readRDS(here("data/tidy_data/demand/total_ingredient_demand_by_diet.rds")) |> 
  select(diet, ingredients, prop, ingredient_demand_tonnes) |> distinct()



  ingredient_prop_tonne <- 
  all_data |> 
  group_by(diet, ingredient, pressure, source) |> 
  summarise(sum = sum(sum, na.rm = TRUE)) |> 
  ungroup() |> 
  group_by(source) |> 
  nest() |> 
  mutate(CPI = map(data, ~(sum(.$sum)))) |> 
  unnest(cols = c(data, CPI)) |> 
  ungroup() |> 
  mutate(prop_CPI = sum/CPI) |> 
  left_join(ingredient_prop |> mutate(diet = gsub("_", " ", diet)), by = c("diet", "ingredient" = "ingredients")) |> 
  mutate(pressure_tonne = sum/ingredient_demand_tonnes)




ggplot(data = ingredient_prop_tonne |> 
         mutate(diet = case_when(diet == "marine diet" ~ "Fish-dominant diet",
                                                           TRUE ~ "Plant-dominant diet"),
                pressure = factor(pressure, levels = c("GHG", "Disturbance", "Nutrients", "Water"))), 
       aes(x = str_to_sentence(ingredient), y= pressure_tonne, fill = diet))+
  facet_grid(cols = vars(pressure))+
  geom_point(pch = 21, size= 1, position = position_jitterdodge(jitter.width = 0.3), alpha = 0.1, stroke=0.1)+
  geom_boxplot(colour = "grey35", alpha = 0.4, linewidth=0.2, outlier.alpha = 0, width = 0.8)+
  scale_fill_manual(values = rev(my_pal[c(4,2)]))+
  theme_bw()+
  theme(legend.position = "bottom",
        legend.background = element_rect(fill="transparent"),
        legend.title = element_blank(),
        panel.grid = element_blank(),
        text = element_text(size=8),
        panel.border = element_rect(colour = "black", linewidth = 0.5),
        axis.text = element_text(size=8),
        axis.title = element_text(size=8),
        axis.title.y = element_blank())+
  coord_flip()+
  labs(y="Normalised pressure per tonne")


ggsave(filename = sprintf(here("figures/normalised_pressure_per_tonne_per_ingredient_%s.jpeg"), this_allocation_method), device = "jpeg", dpi = 600, width = 18, height =12, units = "cm")

```

Break down of ingredient and stage
```{r}
cpi_by_ingredient_pressure_stage <- 
  all_data |> 
  group_by(diet, ingredient, source, stage, pressure) |> 
  summarise(cpi_cont = sum(sum, na.rm=TRUE)) |> 
  mutate(pressure = factor(pressure, levels = rev(c("GHG", "Disturbance", "Nutrients", "Water"))))



ggplot(data = cpi_by_ingredient_pressure_stage |> 
                              mutate(diet = case_when(diet == "plant diet" ~ "Plant-dominant\nfeed",
                                                      diet == "marine diet" ~ "Fish-dominant\nfeed"),
                                                      diet = factor(diet, levels = c("Plant-dominant\nfeed", "Fish-dominant\nfeed")),
                                     stage = factor(stage, levels = c("production", "processing"))))+
  aes(x = cpi_cont, y = pressure, fill = diet)+
  geom_point(pch = 21, position = position_jitterdodge(jitter.width = 0.5), alpha = 0.1)+
  geom_boxplot(notch = FALSE, colour = "grey35", alpha = 0.4, linewidth=0.5, outlier.alpha = 0)+
  facet_grid(rows = vars(ingredient), cols = vars(stage))+
  scale_fill_manual(values = (my_pal[c(4,2)]))+
  scale_x_continuous(limits = c(0,1.01), breaks = c(0,0.25,0.5,0.75, 1))+
  theme_bw()+
  theme(legend.position = c(0.8, 0.1),
        legend.background = element_rect(fill="transparent"),
        legend.title = element_blank(),
        panel.grid = element_blank(),
        text = element_text(size=8),
        panel.border = element_rect(colour = "black", linewidth = 0.5),
        axis.text = element_text(size=8),
        axis.title = element_text(size=8),
        axis.title.y = element_blank())+
  labs(x = "CPI contribution")

ggsave(filename = sprintf(here("figures/disaggregation_of_pressures_ingredients_and_stage_%s.jpg"), this_allocation_method), width = 18, height=30, units = "cm", device = "jpg", dpi = 600)


```



# Ingredient case studies

```{r}
# FISH OIL - DISTURBANCE

marine_fo_dist <- 
  
  list.files(here("data/spatial/marine_diet/int"), 
                        pattern = "fish oil_production_disturbance_moll|fish oil_processing_disturbance_moll", full.names = TRUE) |>
  map(.f = \(this_file){
    
    this_area <- str_sub(this_file, start = nchar(tools::file_path_sans_ext(this_file))-1, end = nchar(tools::file_path_sans_ext(this_file)))
    
    this_stage <- str_extract(pattern = "production|processing", string = this_file)
    
    return(global(rast(this_file), fun = sum, na.rm=TRUE) |> 
      select(sum) |> 
      mutate(area = this_area,
             stage = this_stage,
             diet = "Fish-dominant"))
  })


plant_fo_dist <- 
  
  list.files(here("data/spatial/plant_diet/int"), 
                        pattern = "fish oil_production_disturbance_moll|fish oil_processing_disturbance_moll", full.names = TRUE) |>
  map(.f = \(this_file){
    
    this_area <- str_sub(this_file, start = nchar(tools::file_path_sans_ext(this_file))-1, end = nchar(tools::file_path_sans_ext(this_file)))
   
     this_stage <- str_extract(pattern = "production|processing", string = this_file)
    
    return(global(rast(this_file), fun = sum, na.rm=TRUE) |> 
      select(sum) |> 
      mutate(area = this_area,
             stage = this_stage,
             diet = "Plant-dominant"))
  })
  

fo_disturbance_df <- bind_rows(marine_fo_dist, plant_fo_dist) |> 
  mutate(area_name = case_when(area == 27 ~ "Northeast Atlantic",
                          area == 31 ~ "Western-central Atlantic",
                          area == 61 ~ "Northwest Pacific",
                          area == 67 ~ "Northeast Pacific",
                          area == 87 ~ "Southeast Pacific"))

#fish oil label
facet_text <- data.frame(diet= "Fish-dominant", sum = Inf, area_name = 1)

#anchovy png
ff_png <- png::readPNG(here("data/tidy_data/png/engraulis-australis-australian-anchovy.png"))
ff_png <- grid::rasterGrob(ff_png)


fo_dist_plot <- 
  ggplot(data = fo_disturbance_df)+
  geom_col_pattern(mapping = aes(x = area_name, fill = area_name, y = sum,  pattern = stage),
    position="stack",
    pattern_type = "stripe",
    pattern_size = 0.08,
    pattern_spacing = 0.02, 
    pattern_frequency = 3,
    pattern_fill="grey40",   # removes gray parts you see between pattern lines
    pattern_angle = 45,
    pattern_colour = "grey40", 
    linewidth=0.08) +
  facet_grid(~diet, switch = "x")+
  scale_pattern_manual(values = c(processing = "stripe", production = "none"))+
  scale_fill_manual(values = rcartocolor::carto_pal(n=5, name = "TealGrn"))+
  scale_x_discrete(expand=expansion(mult=0.3))+
  guides(fill = guide_legend(override.aes = list(pattern = "none"), title.position = "top",order = 2),
         pattern = guide_legend(override.aes = list(fill = "grey95"), title.position = "top",order = 1))+
   theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        strip.background = element_rect(fill = "transparent"),
        strip.placement = "outside",
        strip.text = element_text(size=8),
        panel.background = element_blank(),
        axis.line = element_line(),
        panel.spacing = unit(0, 'pt'),
        text=element_text(size=8),
        legend.position = c(0.7,0.83),
        legend.box = "horizontal",
        legend.title = element_text(size=6),
        legend.text = element_text(size=6),
        legend.key.size = unit(0.3, "cm"),
        legend.background = element_rect(fill = "transparent"),
        legend.margin = margin(-0.2,0,0,-0, unit="cm"))+
    coord_cartesian(ylim = c(0, 9000), clip="off") +
  #theme(plot.margin = unit(c(1,1,1,0), "lines"))+
    annotate("segment", x = 3, xend = 3, y=-450, yend = -650)+
  labs(fill = "FAO fishing area", y = bquote(Disturbance~(km^2~eq.)), x = "", pattern = "Stage")+
  geom_text(data = facet_text, aes(x = area_name, y = sum), label = "Fish oil", size=3, fontface="bold")+
  annotation_custom2(ff_png, xmin = 2, xmax = 3.5, ymin = 8700, ymax = 10000, data = fo_disturbance_df |> filter(diet == "Fish-dominant"))
  
  
  ggsave(filename = sprintf(here("explore/fish_oil_disturbance_%s.jpeg"), this_allocation_method), device = "jpeg", dpi = 600, width = 8.9, height = 7, units = "cm")


  
  
  
  
############################################  
  
  
#SBM/SPC - DISTURBANCE

#marine diet

marine_SBM_dist <- 
  
  list.files(here("data/spatial/marine_diet/int"), 
                        pattern = "soybean meal_production_disturbance_moll|soybean meal_processing_disturbance_moll", full.names = TRUE) |>
  map(.f = \(this_file){
    
    this_area <- str_sub(this_file, start = nchar(tools::file_path_sans_ext(this_file))-2, end = nchar(tools::file_path_sans_ext(this_file)))
    
    this_stage <- str_extract(pattern = "production|processing", string = this_file)
    
    return(global(rast(this_file), fun = sum, na.rm=TRUE) |> 
      select(sum) |> 
      mutate(area = this_area,
             stage = this_stage,
             diet = "Fish-dominant"))
  })


plant_SPC_dist <- 
  
  list.files(here("data/spatial/plant_diet/int"), 
                        pattern = "soy protein concentrate_production_disturbance_moll|soy protein concentrate_processing_disturbance_moll", full.names = TRUE) |>
  map(.f = \(this_file){
    
    this_area <- str_sub(this_file, start = nchar(tools::file_path_sans_ext(this_file))-2, end = nchar(tools::file_path_sans_ext(this_file)))
    
    this_stage <- str_extract(pattern = "production|processing", string = this_file)
    
    return(global(rast(this_file), fun = sum, na.rm=TRUE) |> 
      select(sum) |> 
      mutate(area = this_area,
             stage = this_stage,
             diet = "Plant-dominant"))
  })
  

#facet label
facet_text <- data.frame(diet= "Fish-dominant", sum = Inf, area_name = 1)

#soy png
soy_png <- png::readPNG(here("data/tidy_data/png/soybeans.png"))
soy_png <- grid::rasterGrob(soy_png)

soy_disturbance_df <- bind_rows(marine_SBM_dist, plant_SPC_dist) |> 
  mutate(area_name = countrycode::countrycode(sourcevar = area, origin = "iso3c", destination="country.name", warn=TRUE))


soy_dist_plot <- 
  ggplot(data = soy_disturbance_df)+
  geom_col_pattern(mapping = aes(x = area_name, fill = area_name, y = sum,  pattern = stage),
    position="stack",
    pattern_type = "stripe",
    pattern_size = 0.08,
    pattern_spacing = 0.02, 
    pattern_frequency = 3,
    pattern_fill="grey40",   # removes gray parts you see between pattern lines
    pattern_angle = 45,
    pattern_colour = "grey40", 
    linewidth=0.08) +
  facet_grid(~diet, switch = "x")+
  scale_pattern_manual(values = c(processing = "stripe", production = "none"))+
  scale_fill_manual(values = rcartocolor::carto_pal(n=5, name = "BrwnYl"))+
  scale_x_discrete(expand=expansion(mult=0.3))+
  guides(fill = guide_legend(override.aes = list(pattern = "none"), title.position = "top",order = 2),
         pattern = guide_legend(override.aes = list(fill = "grey95"), title.position = "top",order = 1))+
   theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        strip.background = element_rect(fill = "transparent"),
        strip.placement = "outside",
        strip.text = element_text(size=8),
        panel.background = element_blank(),
        axis.line = element_line(),
        panel.spacing = unit(0, 'pt'),
        text=element_text(size=8),
        legend.position = c(0.7,0.83),
        legend.box = "horizontal",
        legend.title = element_text(size=6),
        legend.text = element_text(size=6),
        legend.key.size = unit(0.3, "cm"),
        legend.background = element_rect(fill = "transparent"),
        legend.margin = margin(-0.2,0,0,-0, unit="cm"))+
    coord_cartesian(ylim = c(0, 295), clip="off")+
  labs(fill = "Country", y = bquote(Disturbance~(km^2~eq.)), x = "", pattern = "Stage")+
  annotate("segment", x = 3, xend = 3, y=-15, yend = -20)+
  geom_text(data = facet_text, aes(x = area_name+0.5, y = sum), label = "SBM/SPC", size=3, fontface="bold")+
  annotation_custom2(soy_png, xmin = 1, xmax = 2, ymin = 220, ymax = 280, data = soy_disturbance_df |> filter(diet == "Fish-dominant"))

ggsave(filename = sprintf(here("explore/soy_disturbance_%s.jpeg"), this_allocation_method), device = "jpeg", dpi = 600, width = 8.9, height = 7, units = "cm")


  



  
#########################################  
  
  
  # FISH OIL - GHG

#fish oil label
facet_text <- data.frame(diet= "Fish-dominant", sum = Inf, area_name = 1)

#anchovy png
ff_png <- png::readPNG(here("data/tidy_data/png/engraulis-australis-australian-anchovy.png"))
ff_png <- grid::rasterGrob(ff_png)



marine_fo_GHG <- 
  
  list.files(here("data/spatial/marine_diet/int"), 
                        pattern = "fish oil_production_ghg_moll|fish oil_processing_ghg_moll", full.names = TRUE) |>
  map(.f = \(this_file){
    
    this_area <- str_sub(this_file, start = nchar(tools::file_path_sans_ext(this_file))-1, end = nchar(tools::file_path_sans_ext(this_file)))
    
    this_stage <- str_extract(pattern = "production|processing", string = this_file)
    
    return(global(rast(this_file), fun = sum, na.rm=TRUE) |> 
      select(sum) |> 
      mutate(area = this_area,
             stage = this_stage,
             diet = "Fish-dominant"))
  })


plant_fo_GHG <- 
  
  list.files(here("data/spatial/plant_diet/int"), 
                        pattern = "fish oil_production_ghg_moll|fish oil_processing_ghg_moll", full.names = TRUE) |>
  map(.f = \(this_file){
    
    this_area <- str_sub(this_file, start = nchar(tools::file_path_sans_ext(this_file))-1, end = nchar(tools::file_path_sans_ext(this_file)))
    
    this_stage <- str_extract(pattern = "production|processing", string = this_file)
    
    return(global(rast(this_file), fun = sum, na.rm=TRUE) |> 
      select(sum) |> 
      mutate(area = this_area,
             stage = this_stage,
             diet = "Plant-dominant"))
  })
  

fo_GHG_df <- bind_rows(marine_fo_GHG, plant_fo_GHG) |> 
  mutate(area_name = case_when(area == 27 ~ "Northeast Atlantic",
                          area == 31 ~ "Western-central Atlantic",
                          area == 61 ~ "Northwest Pacific",
                          area == 67 ~ "Northeast Pacific",
                          area == 87 ~ "Southeast Pacific"))


fo_ghg_plot <- 
  ggplot(data = fo_GHG_df)+
  geom_col_pattern(mapping = aes(x = area_name, fill = area_name, y = sum/1000,  pattern = stage),
    position="stack",
    pattern_type = "stripe",
    pattern_size = 0.08,
    pattern_spacing = 0.02, 
    pattern_frequency = 3,
    pattern_fill="grey40",   # removes gray parts you see between pattern lines
    pattern_angle = 45,
    pattern_colour = "grey40", 
    linewidth=0.08) +
  facet_grid(~diet, switch = "x")+
  scale_pattern_manual(values = c(processing = "stripe", production = "none"))+
  scale_fill_manual(values = rcartocolor::carto_pal(n=5, name = "TealGrn"))+
  scale_x_discrete(expand=expansion(mult=0.3))+
  guides(fill = guide_legend(override.aes = list(pattern = "none"), title.position = "top",order = 2),
         pattern = guide_legend(override.aes = list(fill = "grey95"), title.position = "top", order = 1))+
   theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        strip.background = element_rect(fill = "transparent"),
        strip.placement = "outside",
        strip.text = element_text(size=8),
        panel.background = element_blank(),
        axis.line = element_line(),
        panel.spacing = unit(0, 'pt'),
        text=element_text(size=8),
        legend.position = c(0.7,0.83),
        legend.box = "horizontal",
        legend.title = element_text(size=6),
        legend.text = element_text(size=6),
        legend.key.size = unit(0.3, "cm"),
        legend.background = element_rect(fill = "transparent"),
        legend.margin = margin(-0.2,0,0,-0, unit="cm"))+
    coord_cartesian(ylim = c(0, 210000), clip="off")+
   annotate("segment", x = 3, xend = 3, y=-15000, yend = -10000)+
  labs(fill = "FAO fishing area", y = bquote(GHG~emissions~(tonnes~CO[2]~eq.)), x = "", pattern = "Stage")+
  geom_text(data = facet_text, aes(x = area_name, y = sum), label = "Fish oil", size=3, fontface="bold")+
  annotation_custom2(ff_png, xmin = 2, xmax = 3.5, ymin = 212000, ymax = 222000, data = fo_disturbance_df |> filter(diet == "Fish-dominant"))

ggsave(filename = sprintf(here("explore/fish_oil_GHG_%s.jpeg"), this_allocation_method), device = "jpeg", dpi = 600, width = 8.9, height = 7, units = "cm")





#############################

#SBM/SPC - GHG

#marine diet

marine_SBM_GHG <- 
  
  list.files(here("data/spatial/marine_diet/int"), 
                        pattern = "soybean meal_production_ghg_moll|soybean meal_processing_ghg_moll", full.names = TRUE) |>
  map(.f = \(this_file){
    
    this_area <- str_sub(this_file, start = nchar(tools::file_path_sans_ext(this_file))-2, end = nchar(tools::file_path_sans_ext(this_file)))
    
     this_stage <- str_extract(pattern = "production|processing", string = this_file)
    
    return(global(rast(this_file), fun = sum, na.rm=TRUE) |> 
      select(sum) |> 
      mutate(area = this_area,
             stage = this_stage,
             diet = "Fish-dominant"))
  })


plant_SPC_GHG <- 
  
  list.files(here("data/spatial/plant_diet/int"), 
                        pattern = "soy protein concentrate_production_ghg_moll|soy protein concentrate_processing_ghg_moll", full.names = TRUE) |>
  map(.f = \(this_file){
    
    this_area <- str_sub(this_file, start = nchar(tools::file_path_sans_ext(this_file))-2, end = nchar(tools::file_path_sans_ext(this_file)))
   this_stage <- str_extract(pattern = "production|processing", string = this_file)
    
    return(global(rast(this_file), fun = sum, na.rm=TRUE) |> 
      select(sum) |> 
      mutate(area = this_area,
             stage = this_stage,
             diet = "Plant-dominant"))
  })
  




#facet label
facet_text <- data.frame(diet= "Fish-dominant", sum = Inf, area_name = 1)

#soy png
soy_png <- png::readPNG(here("data/tidy_data/png/soybeans.png"))
soy_png <- grid::rasterGrob(soy_png)



soy_ghg_df <- bind_rows(marine_SBM_GHG, plant_SPC_GHG) |> 
  mutate(area_name = countrycode::countrycode(sourcevar = area, origin = "iso3c", destination="country.name", warn=TRUE))


soy_ghg_plot <- 
  ggplot(data = soy_ghg_df)+
  geom_col_pattern(mapping = aes(x = area_name, fill = area_name, y = sum/1000,  pattern = stage),
    position="stack",
    pattern_type = "stripe",
    pattern_size = 0.08,
    pattern_spacing = 0.02, 
    pattern_frequency = 3,
    pattern_fill="grey40",   # removes gray parts you see between pattern lines
    pattern_angle = 45,
    pattern_colour = "grey40", 
    linewidth=0.08) +
  facet_grid(~diet, switch = "x")+
  scale_pattern_manual(values = c(processing = "stripe", production = "none"))+
  scale_fill_manual(values = rcartocolor::carto_pal(n=5, name = "BrwnYl"))+
  scale_x_discrete(expand=expansion(mult=0.3))+
  guides(fill = guide_legend(override.aes = list(pattern = "none"), title.position = "top", order = 2),
         pattern = guide_legend(override.aes = list(fill = "grey95"), title.position = "top", order = 1))+
   theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        strip.background = element_rect(fill = "transparent"),
        strip.placement = "outside",
        strip.text = element_text(size=8),
        panel.background = element_blank(),
        axis.line = element_line(),
        panel.spacing = unit(0, 'pt'),
        text=element_text(size=8),
        legend.position = c(0.75,0.83),
        legend.box = "horizontal",
        legend.title = element_text(size=6),
        legend.text = element_text(size=6),
        legend.key.size = unit(0.3, "cm"),
        legend.background = element_rect(fill = "transparent"),
        legend.margin = margin(-0.2,0,0,-0, unit="cm"))+
    coord_cartesian(ylim = c(0, 210000), clip="off")+
  labs(fill = "Country", y = bquote(GHG~emissions~(tonnes~CO[2]~eq.)), x = "", pattern = "Stage")+
  annotate("segment", x = 3, xend = 3, y=-15000, yend = -10000)+
  geom_text(data = facet_text, aes(x = area_name+0.5, y = sum), label = "SBM/SPC", size=3, fontface="bold")+
  annotation_custom2(soy_png, xmin = 1, xmax = 2, ymin = 170000, ymax = 210000, data = soy_disturbance_df |> filter(diet == "Fish-dominant"))
  
 
ggsave(filename = sprintf(here("explore/soy_GHG_%s.jpeg"), this_allocation_method), device = "jpeg", dpi = 600, width = 8.9, height = 7, units = "cm")





################################

#WHEAT GLUTEN - NUTRIENTS


#marine diet

marine_WG_nutr <- 
  
  list.files(here("data/spatial/marine_diet/int"), 
                        pattern = "wheat gluten_production_nutrient_moll|wheat gluten_processing_nutrient_moll", full.names = TRUE) |>
  map(.f = \(this_file){
    
    this_area <- str_sub(this_file, start = nchar(tools::file_path_sans_ext(this_file))-2, end = nchar(tools::file_path_sans_ext(this_file)))
    
    this_stage <- str_extract(pattern = "production|processing", string = this_file)
    
    return(global(rast(this_file), fun = sum, na.rm=TRUE) |> 
      select(sum) |> 
      mutate(area = this_area,
             stage = this_stage,
             diet = "Fish-dominant"))
  })


plant_WG_nutr <- 
  
  list.files(here("data/spatial/plant_diet/int"), 
                        pattern = "wheat gluten_production_nutrient_moll|wheat gluten_processing_nutrient_moll", full.names = TRUE) |>
  map(.f = \(this_file){
    
    this_area <- str_sub(this_file, start = nchar(tools::file_path_sans_ext(this_file))-2, end = nchar(tools::file_path_sans_ext(this_file)))
    
    this_stage <- str_extract(pattern = "production|processing", string = this_file)
    
    return(global(rast(this_file), fun = sum, na.rm=TRUE) |> 
      select(sum) |> 
      mutate(area = this_area,
             stage = this_stage,
             diet = "Plant-dominant"))
 })



#wheat gluten label
facet_text <- data.frame(diet= "Fish-dominant", sum = Inf, area_name = 1)

#wheat png
wheat_png <- png::readPNG(here("data/tidy_data/png/wheat-sheath.png"))
wheat_png <- grid::rasterGrob(wheat_png)




WG_nutr_df <- bind_rows(marine_WG_nutr, plant_WG_nutr) |> 
  mutate(area_name = countrycode::countrycode(sourcevar = area, origin = "iso3c", destination="country.name", warn=TRUE))




#Wheat gluten nutrients plot

wg_nutr_plot <- 
  ggplot(data = WG_nutr_df)+
  geom_col_pattern(mapping = aes(x = area_name, fill = area_name, y = sum/1000,  pattern = stage),
    position="stack",
    pattern_type = "stripe",
    pattern_size = 0.08,
    pattern_spacing = 0.02, 
    pattern_frequency = 3,
    pattern_fill="grey40",   # removes gray parts you see between pattern lines
    pattern_angle = 45,
    pattern_colour = "grey40", 
    linewidth=0.08) +
  facet_grid(~diet, switch = "x")+
   scale_pattern_manual(values = c(processing = "stripe", production = "none"))+
  scale_fill_manual(values = rcartocolor::carto_pal(n=5, name = "BrwnYl"))+
  scale_x_discrete(expand=expansion(mult=0.3))+
  guides(fill = guide_legend(override.aes = list(pattern = "none"), title.position = "top", order = 2),
         pattern = guide_legend(override.aes = list(fill = "grey95"), title.position = "top", order = 1))+
   theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        strip.background = element_rect(fill = "transparent"),
        strip.placement = "outside",
        strip.text = element_text(size=8),
        panel.background = element_blank(),
        axis.line = element_line(),
        panel.spacing = unit(0, 'pt'),
        text=element_text(size=8),
        legend.position = c(0.75,0.83),
        legend.box = "horizontal",
        legend.title = element_text(size=6),
        legend.text = element_text(size=6),
        legend.key.size = unit(0.3, "cm"),
        legend.background = element_rect(fill = "transparent"),
        legend.margin = margin(-0.2,0,0,0, unit="cm"))+
    coord_cartesian(ylim = c(0, 125), clip="off") +
  labs(fill = "Country", y = bquote(Excess~nutrients~(tonnes~N/P~eq.)), x = "Feed scenario", pattern = "Stage")+
     annotate("segment", x = 3, xend = 3, y=-2, yend = -5)+
  geom_text(data = facet_text, aes(x = area_name+0.8, y = sum), label = "Wheat gluten", size=3, fontface="bold")+
  annotation_custom2(wheat_png, xmin = 2.8, xmax = 5, ymin = 120, ymax = 132, data = soy_disturbance_df |> filter(diet == "Fish-dominant"))
  
ggsave(filename = sprintf(here("explore/wheat_gluten_%s.jpg"), this_allocation_method), dpi = 600, width = 8.9, height=7, unit="cm")








##########################

#SBM/SPC - WATER 


marine_soy_water <- 
  
  list.files(here("data/spatial/marine_diet/int"), 
                        pattern = "soybean meal_production_water_moll|soybean meal_processing_water_moll", full.names = TRUE) |>
  map(.f = \(this_file){
    
    this_area <- str_sub(this_file, start = nchar(tools::file_path_sans_ext(this_file))-2, end = nchar(tools::file_path_sans_ext(this_file)))
    
    this_stage <- str_extract(pattern = "production|processing", string = this_file)
    
    return(global(rast(this_file), fun = sum, na.rm=TRUE) |> 
      select(sum) |> 
      mutate(area = this_area,
             stage = this_stage,
             diet = "Fish-dominant"))
  })


plant_soy_water <- 
  
  list.files(here("data/spatial/plant_diet/int"), 
                        pattern = "soy protein concentrate_production_water_moll|soy protein concentrate_processing_water_moll", full.names = TRUE) |>
  map(.f = \(this_file){
    
    this_area <- str_sub(this_file, start = nchar(tools::file_path_sans_ext(this_file))-2, end = nchar(tools::file_path_sans_ext(this_file)))
    
    this_stage <- str_extract(pattern = "production|processing", string = this_file)
    
    return(global(rast(this_file), fun = sum, na.rm=TRUE) |> 
      select(sum) |> 
      mutate(area = this_area,
             stage = this_stage,
             diet = "Plant-dominant"))
 })



#facet label
facet_text <- data.frame(diet= "Fish-dominant", sum = Inf, area_name = 1)

#soy png
soy_png <- png::readPNG(here("data/tidy_data/png/soybeans.png"))
soy_png <- grid::rasterGrob(soy_png)



soy_water_df <- bind_rows(marine_soy_water, plant_soy_water) |> 
  mutate(area_name = countrycode::countrycode(sourcevar = area, origin = "iso3c", destination="country.name", warn=TRUE))


soy_water_plot <- 
  ggplot(data = soy_water_df)+
  geom_col_pattern(mapping = aes(x = area_name, fill = area_name, y = sum/1000,  pattern = stage),
    position="stack",
    pattern_type = "stripe",
    pattern_size = 0.08,
    pattern_spacing = 0.02, 
    pattern_frequency = 3,
    pattern_fill="grey40",   # removes gray parts you see between pattern lines
    pattern_angle = 45,
    pattern_colour = "grey40", 
    linewidth=0.08) +
  facet_grid(~diet, switch = "x")+
  scale_pattern_manual(values = c(processing = "stripe", production = "none"))+
  scale_fill_manual(values = rcartocolor::carto_pal(n=5, name = "BrwnYl"))+
  scale_x_discrete(expand=expansion(mult=0.3))+
  guides(fill = guide_legend(override.aes = list(pattern = "none"), title.position = "top", order = 2),
         pattern = guide_legend(override.aes = list(fill = "grey95"), title.position = "top", order = 1))+
   theme(axis.title = element_text(size = 9, face = "bold"),
     axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        strip.background = element_rect(fill = "transparent"),
        strip.placement = "outside",
        strip.text = element_text(size=8),
        panel.background = element_blank(),
        axis.line = element_line(),
        panel.spacing = unit(0, 'pt'),
        text=element_text(size=8),
        legend.position = c(0.75,0.83),
        legend.box = "horizontal",
        legend.title = element_text(size=6),
        legend.text = element_text(size=6),
        legend.key.size = unit(0.3, "cm"),
        legend.background = element_rect(fill = "transparent"),
        legend.margin = margin(-0.2,0,0,-0, unit="cm"))+
    coord_cartesian(ylim = c(0,3000), clip="off")+
  labs(fill = "Country", y = bquote(Water~consumption~("1000s"~m^3)), x = "Feed scenario", pattern = "Stage")+
  annotate("segment", x = 3, xend = 3, y=-150, yend = -220)+
  geom_text(data = facet_text, aes(x = area_name+0.5, y = sum), label = "SBM/SPC", size=3, fontface="bold")+
  annotation_custom2(soy_png, xmin = 1, xmax = 2, ymin = 2450, ymax = 3000, data = soy_disturbance_df |> filter(diet == "Fish-dominant"))
  
 

ggsave(filename = sprintf(here("explore/soy_water_%s.jpeg"), this_allocation_method), device = "jpeg", dpi = 600, width = 8.9, height = 7, units = "cm")



(fo_dist_plot|soy_dist_plot)/
  (fo_ghg_plot|soy_ghg_plot)/
  (wg_nutr_plot|soy_water_plot)+
  plot_annotation(tag_levels = "a")& 
  theme(plot.tag = element_text(size=10), 
        plot.tag.position = c(0, 1))
  

ggsave(filename = sprintf(here("figures/case_studies_%s.jpg"), this_allocation_method), dpi=600, width = 18, height = 21, unit = "cm")

```















# first row for marine ingredients
marine_vs_plant_ghg <- (fo_ghg_plot|soy_ghg_plot)
  
ggsave(filename = sprintf(here("explore/ghg_marine_vs_plant_%s.jpg"), this_allocation_method), dp = 600, height = 7, width=18, unit = "cm")








```


