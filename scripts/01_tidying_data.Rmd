---
title: "Tidying data"
author: "Rich Cottrell"
date: "15/02/2022"
output: html_document
---

```{r}
library(tidyverse)
library(parallel)
library(janitor)
library(here)
library(countrycode)
library(rredlist)
library(terra)
library(data.table)
library(dtplyr)

source(here("src/directories.R"))
source(here("src/spatial.R"))

```


Create a base raster
```{r}

base_raster <- rast()
values(base_raster) <- 1:ncell(base_raster)
base_raster_ea <- project(base_raster, equal_area_gp_proj)
res(base_raster_ea) <- 10000
values(base_raster_ea) <- 1:ncell(base_raster_ea) 

writeRaster(x = base_raster_ea, file = here("data/spatial/base_raster_gall_peters.tif"), overwrite=TRUE)




```


#AQUACULTURE DATA

Tidy global aquaculture production data

```{r}

(aqua_prod_raw <- 
   read_csv(file.path(fishstat_dir, "aqua-prod-raw.csv")) %>% 
  clean_names() %>% 
  rename(country= country_name,
         species = asfis_species_name,
         area = fao_major_fishing_area_name,
         environment = environment_name) %>% 
   dplyr::select(-unit_name) %>% 
   filter(!country %in% c("Totals - Tonnes - live weight", "FAO. 2021. Fishery and Aquaculture Statistics. Global aquaculture production 1950-2019 (FishstatJ). In: FAO Fisheries Division [online]. Rome. Updated 2021. www.fao.org/fishery/statistics/software/fishstatj/en"))
)


flags <- aqua_prod_raw %>% 
  dplyr::select(-starts_with("x")) %>% 
  pivot_longer(names_to = "flag", values_to = "symbol", -c(country, species, area, environment, unit)) %>% 
  mutate(flag = case_when(symbol == "..." ~ "No data",
                           symbol == " " ~ "Data not separately available",
                           symbol == "-" ~ "Nil or zero",
                           symbol == "0 0" ~ "0<x<0.5",
                           symbol == "E" ~ "estimate",
                           is.na(symbol) ~ "Reported")) %>% 
  dplyr::select(-symbol)


#sorts country coding to deal with non-UTF characters that country code depends on
Encoding(aqua_prod_raw$country) <- "latin1" #deals with the non-UTF
aqua_prod_raw$country <- iconv(aqua_prod_raw$country, "latin1", "UTF-8",sub='')



aquaculture_prod <- 
  
  bind_cols(
    aqua_prod_raw %>%
      dplyr::select(-c(starts_with("s_"), s)) %>% 
      pivot_longer(names_to = "year", values_to = "value", cols = -c(country, species, area, environment, unit)) %>% 
      mutate(iso_3c = countrycode(country, origin = "country.name", destination = "iso3c", warn = TRUE)) %>%
      mutate(iso_3c = case_when(country == "Zanzibar" ~ "TZA",
                                TRUE ~ iso_3c)) %>%
      mutate(year = gsub("x", "", year) %>% 
               as.numeric),
    
    flags %>% dplyr::select(flag)
  ) %>% 
  drop_na(iso_3c)



saveRDS(object = aquaculture_prod, file = here("data", "tidy_data", "aquaculture_production_tidy.rds"))



```

#AGRICULTURE DATA


This is the code to unzip and adjust the extents of the mapspam rasters (-180, 180, -90, 90) - DO NOT RUN IN PROJECT - here as a backup to scripts in the raw data files

```{r}


mapspam_zip_files <- list.files(path = mapspam_dir, pattern = "\\.zip$")


lapply(X=mapspam_zip_files, FUN = unzip)


#Adjust the extent of rasters to full lon lat coveragge

#test
banana <- raster(file.path(mapspam_dir, "spam2010V2r0_global_H_BANA_H.tif"))
banana

#this should be the new extent for all
new_extent <- c(-180, 180, -90, 90)

extent(banana) <- new_extent

#apply new extents to all files

tifs <- list.files(mapspam_dir, pattern = "\\.tif", full.names = TRUE)

adjust_extent <- \(this_filename){
  
  this_file <- basename(this_filename)
  message(paste("processing", which(tifs==this_file), "of", length(tifs)))
  this_raster <- rast(this_filename)
  ext(this_raster) <- new_extent
  writeRaster(x=this_raster, filename = file.path("/mnt/rdsi/raw_data/MAPSPAM/new-extents", this_file), overwrite = TRUE)
}

#run over mutliple cores to speed things up - pointer error but all files ran.
parallel::mclapply(X = tifs, FUN = adjust_extent, mc.cores = detectCores()-2)


```



This is the code to unzip the gridded livestock of the world rasters - DO NOT RUN IN PROJECT - here as a backup to scripts in the raw data files

```{r}

dir <- "/mnt/rdsi/raw_data/gridded-livestock-of-the-world"

setwd(dir)

library(tidyverse)
library(parallel)
library(raster)

glw_zip_files <- list.files(dir, pattern = "\\.zip$")

unzip_raw_data <- function(this_file){
  this_file_name <- file.path(dir, this_file)
  unzip(this_file_name)
  
}


lapply(X = glw_zip_files, FUN = unzip_raw_data)



```


Unzip FAOSTAT Production data
```{r}
unzip(list.files(path=file.path(rdsi_dir, "raw_data/fao/FAOSTAT_2022"), pattern = "Production_Crops", full.names = TRUE), exdir = file.path(rdsi_dir, "raw_data/fao/FAOSTAT_2022"))

```

Tidy FAOSTAT Production data
```{r}

production_raw <- read_csv(file.path(rdsi_dir, "raw_data/fao/FAOSTAT_2022/Production_Crops_Livestock_E_All_Data_(Normalized).csv"))

production_flags <- read_csv(file.path(rdsi_dir, "raw_data/fao/FAOSTAT_2022/Production_Crops_Livestock_E_Flags.csv"))

production_raw <- production_raw |> 
  left_join(production_flags) |> 
  mutate(Description = if_else(is.na(Description), true = "Official data", false = Description)) |> 
  mutate(Sector = case_when(grepl("Milk|milk|Meat|meat|Fat|fat|Chicken|Buffaloes|Cattle|cattle|Camel|ffal|Pigs|abbit|worm|odent|urkey|oghurt|Wool|Sheep|Goat|Egg|egg|Asses|Beeh|Bees|Ducks|Cream|Geese|Horses|Honey|Lard|Mules|Birds|Skins|Butter|Cheese|Snail", Item) ~ "Livestock",
                            TRUE ~ "Crops"))

Encoding(production_raw$Area) <- "latin1" #deals with the non-UTF
production_raw$Area <- iconv(production_raw$Area, "latin1", "UTF-8",sub='')


#separate by sector
production_sector_list <- 
  production_raw  |> 
  clean_names()  |>  
  mutate(iso3c = countrycode(area, origin = "country.name", destination = "iso3c", warn = TRUE)) |> 
  group_split(sector)

#save
map(.x = production_sector_list, .f = function(this_element){
  saveRDS(object = this_element, file = sprintf(here("data/tidy_data/production-data/%s_production_tidy.rds"), tolower(unique(this_element$sector))))
})
  



```

Tidying crop LCA files to include as a single file

```{r}

lca_all_crops <- 
  list.files(here("data/raw_data/LCA"), full.names = TRUE) |> 
  map_df(\(each_file){
    this_file <- read_csv(each_file) |> rename_at(vars(1:3), make_clean_names)
    this_long_file <- this_file |> 
      pivot_longer( names_to = "iso2c", values_to = "value" , cols = -c(raw_material, impact_category, unit)) |> 
      mutate(iso3c = countrycode(sourcevar = iso2c, origin = "iso2c", destination = "iso3c", warn = TRUE)) |> 
      mutate(iso3c = case_when(iso2c == "UK" ~ "GBR",
                               grepl("US-", iso2c) ~ "USA",
                               TRUE ~ iso3c))
    }) %>% 
  mutate(FAOSTAT_name = case_when(raw_material == "Broad bean" ~ "Broad beans, horse beans, dry",
                                  raw_material == "Guar seed" ~ "Pulses nes",
                                  raw_material == "Lupins" ~ "Pulses nes - Lupins",
                                  raw_material == "Peas" ~ "Peas, dry",
                                  raw_material == "Wheat grain" ~ "Wheat",
                                  TRUE ~ raw_material))
  
  

saveRDS(object = lca_all_crops, file = here("data/tidy_data/LCA/crop_lca.rds"))


unique(lca_all_crops$raw_material)
```



#FISHERIES DATA 


Pulling together the spatial industrial fisheries data and save to rdsi storage. We assume only industrial fisheries are used for fishmeal production.

```{r}

#THE v5 DATA

catch <- fread(file.path(watson_dir, "v5.0/Catch2015_2019.csv")) |> lazy_dt() |> filter(IYear == 2017)

codes_cell <- fread(file.path(watson_dir, "v5.0/Codes_cells.csv")) |> lazy_dt()

codes_country <- fread(file.path(watson_dir, "v5.0/Codes_country.csv"))|> lazy_dt()

codes_gear <- fread(file.path(watson_dir, "v5.0/Codes_gear.csv")) |> select(Gear, FleetGearName) |> distinct() |> lazy_dt()

codes_taxa <- fread(file.path(watson_dir, "v5.0/Codes_taxa.csv")) |> lazy_dt()



catch_joined<- catch |>
  left_join(codes_cell, by = "Cell") |>
  left_join(codes_country, by = c("CNumber" = "Cnumber")) |>
  left_join(codes_gear, by = c("Gear")) |>
  left_join(codes_taxa, by = "Taxonkey") |>
  rename(CountryName = `FAO name`) |> as.data.table()

fwrite(catch_joined, file.path(watson_dir, "v5.0/watson_2017_fisheries_catch.csv"))


# THE V4 DATA

# catch <- fread(file.path(watson_dir, "v4/Catch2015_2019.csv")) |> lazy_dt() |> filter(IYear == 2017)
# 
# codes_cell <- fread(file.path(watson_dir, "v4/codes_cells.csv")) |> lazy_dt()
# 
# codes_country <- fread(file.path(watson_dir, "v4/codes_country.csv"))|> lazy_dt()
# 
# codes_gear <- fread(file.path(watson_dir, "v4/codes_gear.csv")) |> select(Gear, FleetGearName) |> distinct() |> lazy_dt()
# 
# codes_taxa <- fread(file.path(watson_dir, "v4/codes_taxa.csv")) |> lazy_dt()
# 
# IndexInd <- fread(file.path(watson_dir, "v4/IndexInd.csv")) |> lazy_dt()
# 

# index_2015 <- 
#   IndexInd |> 
#   filter(IYear == 2015) |> 
#   left_join(codes_taxa, by = c("Taxonkey" = "TaxonKey")) |> 
#   left_join(codes_gear |> select(-c(VBCode, FAOGearName, FAOGearCode)) |> distinct(), by = c("Gear", "FGearCode")) |> 
#   left_join(codes_country, by = c("CNumber" = "Country")) |> 
#   select(-c(NumCells, Reported, IUUTotal, Discards))
#   
#  
# catch_index_join <- catch_coords_2015 |> 
#   left_join(index_2015) |> 
#   mutate(total_catch = Reported + IUU) |> 
#   as.data.table() 


#fwrite(catch_index_join, file.path(watson_dir, "watson_2015_fisheries_catch.csv"))


```

Filter FAO Species lists for forage fish spp

```{r}
fao_list <- read_csv(file.path(fao_dir, "species_lists/CL_FI_SPECIES_GROUPS.csv"))

unique(fao_list$ISSCAAP_Group)

forage_list <- fao_list |> filter(ISSCAAP_Group == "Herrings, sardines, anchovies" )

write_csv(forage_list, here("data/raw_data/fisheries/fao_forage_fish_spp_list.csv"))
```


Tidy embodied fish data from FMFO for different forage fish species from Kok et al
```{r}
kok_etal_data <- read_csv(here("data/raw_data/fisheries/embodied_fish_kok_et_al.csv")) |> 
  mutate(Species = substring(Species, 1, nchar(Species)-1)) |> 
  mutate(common_name = case_when(grepl("Sandeels|Capelin|Boarfish", Species) ~ word(Species, start = 1, end = 1),
                                 grepl("South American pilchard", Species) ~ word(Species, start = 1, end = 3),
                                 TRUE ~ word(Species, start = 1, end = 2))) |> 
  mutate(common_name = case_when(grepl("bnchovy", common_name)~ "Peruvian anchovy",
                                TRUE ~ common_name)) |> 
  mutate(sci_name = c(unlist(str_extract_all(Species,  "(?<=\\().+?(?=\\))")), rep(NA, times = 2))) |> 
  mutate(sci_name = case_when(sci_name == "C. harengus" ~ "Clupea harengus",
                              sci_name == "M. villosus" ~ "Mallotus villosus",
                              TRUE~sci_name)) |> 
  select(-Species) |> 
  relocate(c(common_name, sci_name), .before = `Ecosystem d`)

write_csv(kok_etal_data, file = here("data/raw_data/fisheries/embodied_fish_ratio_tidy.csv"))

```



Filter Watson spatialised catch data for forage fish species so it can be stored in the project

```{r}

#THE V5 DATA

catch <- fread(file.path(watson_dir, "v5.0/watson_2017_fisheries_catch.csv"))

 #145 unique species and species groups in the FAO data
forage_spp_fao <- read_csv(here("data/raw_data/fisheries/fao_forage_fish_spp_list.csv")) |> select(Name_en, Scientific_Name) |> distinct() |> rename(common_name = Name_en, sci_name = Scientific_Name) 

#13 species in Kok et al - some not in the FAO data
forage_spp_koketal <- read_csv(here("data/raw_data/fisheries/embodied_fish_ratio_tidy.csv")) |> drop_na() |>  select(common_name, sci_name) |> distinct()
#forage_spp_koketal_common <- read_csv(here("data/raw_data/fisheries/embodied_fish_ratio_tidy.csv")) |> drop_na() |>  pull(common_name) |> unique()

#bind the two sources and save - 155 species considered in total
forage_spp_list <- bind_rows(forage_spp_fao, forage_spp_koketal) |> distinct()
write_csv(forage_spp_list, here("data/raw_data/fisheries/forage_fish_list_final.csv"))

forage_catch <- catch |> lazy_dt() |> filter(TaxonName %in% forage_spp_list$sci_name | CommonName %in% forage_spp_list$common_name ) |> mutate(total_catch = ReportedIND+IUUIND+ReportedNIND+IUUNIND, total_ind = ReportedIND+IUUIND, total_nind =ReportedNIND+IUUNIND) |> as_tibble()

#23 million tonnes, represented by 46 species across industrial and non industrial sources
sum(forage_catch$TotalCatch)
sum(forage_catch$TotalIndustrial) #22.5 mill is from industrial
sum(forage_catch$TotalNIndustrial) #1.3 mill is from non-industrial
unique(forage_catch$TaxonName) 

saveRDS(forage_catch, file = here("data/raw_data/fisheries/spatial_forage_catch_2017.rds"))






#THE V4 DATA

# #check how many of the 154 are represented - only 31 species representing over 20 million tonnes but species from the embodied fish are also missing. Might be worth filtering by relevant genus as even binomials can differ
# unique(forage_catch$TaxonName)
# sum(forage_catch$total_catch)
# 
# saveRDS(forage_catch, file = here("data/raw_data/fisheries/spatial_forage_catch_2015.rds"))
# 


```

