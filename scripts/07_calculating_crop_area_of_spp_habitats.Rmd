---
title: "Calculating area loss from species habitats"
output: html_document
---

Libraries
```{r setup, include=FALSE}

library(tidyverse)
library(here)
library(sf)
library(data.table)
library(dtplyr)
library(terra)
library(raster)
library(parallel)

source(here("src/directories.R"))

source(here("src/spatial.R"))

base_raster_ea <- rast(here("data/spatial/base_raster_gall_peters.tif"))

select <- dplyr::select

```


Import threat data
```{r}

current_severe_threats_of_interest <- read_csv(here("data/tidy_data/iucn/current_severe_threats_of_interest.csv")) |> 
  rename(id_no = id)
  
#how many species fall in to te category of being affected by these threats? 12728 species
length(unique(current_severe_threats_of_interest$id_no))

#ongoing threats represent 93.9% of all threats
current_severe_threats_of_interest |> filter(result_timing == "Ongoing") |> nrow()/(current_severe_threats_of_interest |> nrow())



```

Import area of soy production using the balanced diet 1 as an example.
```{r}

base_raster_layer <- base_raster_ea |> raster()
base_df <- rasterToPoints(base_raster_layer) |> lazy_dt() |> select(x, y)

#seclect the mammals currently threatened by AG, Aquaculture or fisheries
terrestrial_mammals <- list.files(file.path(iucn_dir, "spp_rasters/MAMMALS_TERRESTRIAL_ONLY"), full.names = TRUE)
ag_threat_index <- which(as.double(gsub("spp_", "", basename(tools::file_path_sans_ext(terrestrial_mammals)))) %in% current_severe_threats_of_interest$id_no, TRUE)
vuln_terrestrial_mammals <- terrestrial_mammals[ag_threat_index]


#soy protein concentrate
spc_files <- list.files(here("data/spatial/balanced_diet_1"), pattern = "soy protein concentrate_AllTech_", full.names = TRUE)

spc_files_top_3 <- spc_files[grepl("USA|BRA|CHN", spc_files)]


map(spc_files_top_3, \(this_country){
  
  this_country_spc_raster <- terra::rast(spc_files_short[[1]]) |> raster()
  
  this_country_spc_dt<- rasterToPoints(this_country_spc_raster) |> lazy_dt() |> rename(spc_area = 3) |> mutate(cell_area = 100)
  
  overlap_list <- mclapply(X = vuln_terrestrial_mammals, FUN = \(this_mammal){
  
  #isolate species
  #this spp id
  this_species <- as.numeric(gsub("spp_", "", basename(tools::file_path_sans_ext(this_mammal))))
  
  #import raster
  this_spp_raster <- rast(this_mammal) |> raster()
  #convert raster layer to species id
  values(this_spp_raster)[!is.na(values(this_spp_raster))] <- this_species
  #get the xyz file
  this_spp_dt <- rasterToPoints(this_spp_raster) |> lazy_dt() |> rename(spp_id = layer)
  
  #inner join species and crop files so we know if they overlap and summarise the crop portion of spp habitat
  spp_crop_overlap <-  this_spp_dt |> 
    inner_join(this_country_spc_dt, by = c("x", "y")) |> 
    group_by(spp_id) |> 
    summarise(aoh = sum(spc_area)/sum(cell_area)) |> 
    as.data.table()
  
  return(rbindlist(overlap_list))
  
},
mc.cores = detectCores()-2)
  
})















terra::as.points(r, na.rm = FALSE, crs = equal_area_gp_proj)

as.matrix(as.points(rast())) |> as.data.frame()

rast(type = "xyz")

plot(r)

plot(rast(here("data/spatial/00-country-rasters/BRA.tif")))



terr_mammals <- (list.files(file.path(iucn_dir, "spp_rasters/MAMMALS_TERRESTRIAL_ONLY"), full.names = TRUE, pattern = "\\.tif$"))

extent(r)
terra::ext(base_raster_ea)

test <- st_read(dsn = "/mnt/rdsi/raw_data/iucn/spp_shapefiles/MANGROVES/MANGROVES.shp", layer = "MANGROVES")

test_1 <- test |> filter(id_no == )

rast2 <- rasterize(vect(test_1), y = base_raster_ea, touches = TRUE) |> raster()
plot(rast2)

test2 <- test_1 |> st_transform(crs = equal_area_gp_proj)

plot(rast2)
rast2 |> raster()

terra::rasterize()

r

```

