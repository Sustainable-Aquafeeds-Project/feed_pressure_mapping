---
title: "Calculate_global_feed_demand"
author: "Rich Cottrell"
date: "14/03/2022"
output: html_document
---


```{r}
library(tidyverse)
library(here)
library(janitor)
library(countrycode)
library(data.table)
library(dtplyr)
library(raster)
library(terra)
library(sf)
library(jsonlite)
library(ggnewscale)

source(here("src/directories.R"))

select <- dplyr::select

```


Import aquaculture data and isolate Atlantic salmon. The top 10 producers produce 99.9% of global production so we can just go with that.
```{r}

aquaculture <- readRDS(here("data/tidy_data/production-data/aquaculture_production_tidy.rds"))

aquaculture_species_groups <- unique(aquaculture$species)

salmon_species <- aquaculture_species_groups[grep("salmon", aquaculture_species_groups)]

salmon_aquaculture <- aquaculture %>% filter(species == "Atlantic salmon" & year==2019)

(top_salmon_producers <- salmon_aquaculture %>% 
    group_by(country) %>% 
    summarise(value = sum(value, na.rm = TRUE)) %>% 
    arrange(-value) %>% 
    mutate(prop = value/sum(value),
           cum_prop = cumsum(prop)) %>% 
    slice(1:10)
    
    
    )


```


Import the feed conversion ratios and join to production. Where country information from tacon and metian is not available use global average for that country. And get absolute feed demand. To do this we use the min eFCR given the Tacon and Metian data is old and there is a general upward trend in feed efficiency through time. However, for countries where no specific fcr data is provided, give the mean Global FCR.
```{r}

fcrs <- read_csv(here("data/raw_data/FCR.csv"))

feed_demand <- 
  top_salmon_producers %>% 
  left_join(fcrs, by = "country") %>% 
  mutate(eFCR_min = if_else(is.na(eFCR_min), true = fcrs %>% filter(country=="Globe") %>% pull(eFCR_mean), false = eFCR_min),
         eFCR_max = if_else(is.na(eFCR_max), true = fcrs %>% filter(country=="Globe") %>% pull(eFCR_mean), false = eFCR_max),
         eFCR_mean = if_else(is.na(eFCR_mean), true = fcrs %>% filter(country=="Globe") %>% pull(eFCR_mean), false = eFCR_mean)) %>% 
  mutate(feed_demand = value*eFCR_min)
  
saveRDS(object = feed_demand, file = here("data/tidy_data/demand/global_feed_demand.rds"))

```


Bring in diet data from dowloaded from Teams (and stored in raw_data in this repo) and create separate scenario datasets for each diet. Also create a summary for reference for group totals across marine proteins, marine oils, plant proteins, plant oils, and carbohyrdate sources.

```{r}



#all_diets <- read_csv(here("data/raw_data/diet_formats.csv")) %>% dplyr::select(-Sources)
both_diets <- read_csv(here("data/raw_data/feed_composition_pressures.csv")) |> select(-X5)

diet_summaries <- 
  both_diets %>% 
  filter(grepl("totals", groups)) %>% 
  dplyr::select(c(groups, !matches('[2-9]+')), -ingredients) %>% 
  set_names(~str_replace_all(., pattern = "_1", replacement = ""))

saveRDS(object=diet_summaries, file = here("data/tidy_data/diets/diet_summaries.rds"))
  

both_diets_list <- 
  both_diets %>% 
  filter(!grepl("totals", groups)) |> 
  filter(groups != "Totals") |>  
  drop_na(ingredients) |> 
  set_names(~str_replace_all(., pattern = "_1", replacement = "")) |> 
  pivot_longer(names_to = "diet", values_to = "prop", -c(groups, ingredients)) |> 
  arrange(diet) |>  
  mutate(prop = prop/100) |> 
  group_split(diet)
   

map(.x = both_diets_list,  .f = \(this_diet){ 
  this_file_name <- unique(this_diet$diet); 
  saveRDS(object = this_diet, here(paste0(sprintf("data/tidy_data/diet-scenarios/%s", this_file_name), ".rds")))
  })



```

Now calculate ingredient demand per diet and for each salmon producing country. While we are not really interested in this project in the country-specific data, overall demand is affected by the among country differences in FCR.

```{r}
diet_files <- list.files(here("data/tidy_data/diet-scenarios"), full.names = TRUE)

feed_demand_files <- readRDS(here("data/tidy_data/demand/global_feed_demand.rds")) %>% 
  dplyr::select(country, feed_demand) %>% 
  group_split(country)


#calculate demand for each country individually because of different FCRs

map(feed_demand_files, .f = \(this_country_data){
  
  this_country <- unique(this_country_data$country)
  
  this_countrys_feed_demand <- unique(this_country_data$feed_demand)
  
  map_df(diet_files, readRDS) %>% 
  mutate(country = this_country,
         ingredient_demand = this_countrys_feed_demand * prop) %>% 
  saveRDS(here(sprintf("data/tidy_data/ingredient-demand-by-country/ingredient_demand_%s.rds", this_country)))
  
})

#Summarise and store total feed demand per ingredient, summarising all countries data

list.files(here("data/tidy_data/ingredient-demand-by-country"), full.names = TRUE) %>% 
  map_df(readRDS) %>% 
  group_by(groups, ingredients, diet) %>% 
  summarise(total_ingredient_demand = sum(ingredient_demand, na.rm = TRUE)) %>% 
  saveRDS(here("data/tidy_data/demand/total_ingredient_demand.rds"))


```


Next step is convert ingredient demand into raw material demand which will vary by processing technique (e.g. SPC vs SBM) and source. So first, we need to know where the ingredients are largely sourced from. THis may change with information that we gain from Biomar but the idea is eventually to make this flexible enough to select any from the top producing countries. This requires knowing the raw material that supports the ingredient and the major places this raw material is grown.

```{r}

#create the ingredient list to match raw materials with ingredients

ingredient_list <- tibble(ingredient = readRDS(here("data/tidy_data/demand/total_ingredient_demand.rds")) |> pull(ingredients) |> unique()) |> 
  write_csv(here("data/tidy_data/diets/ingredient_list.csv"))


```


CROP INGREDIENTS

Have added codes and FAO_names for plant ingredients in teams so join these to production data. 

```{r}

ingredient_by_raw_material <- 
  read_csv(here("data/tidy_data/diets/plant_ingredient_codes.csv")) |> 
  select(-reference) |> 
  drop_na(ingredient) |> 
  add_row(ingredient = "pea starch", raw_material = "peas", FAOSTAT_name = "Peas, green", FAO_code = 187, map_spam_code = "opul") |> 
  mutate(FAOSTAT_name = if_else(FAOSTAT_name == "Peas, dry; Peas, green", true = "Peas, dry", false = FAOSTAT_name)) 
 

crop_production_raw <- readRDS(file = here("data/tidy_data/production-data/crops_production_tidy.rds"))

(crop_production <- 
  crop_production_raw |>
  filter(element == "Production"  & area!= "China" & item %in% ingredient_by_raw_material$FAOSTAT_name & year %in% seq(from = 2015, to = 2019)) |> 
  group_by(area, item) |> 
  summarise(mean_value = mean(value, na.rm = TRUE)) |> 
    ungroup() |> 
  mutate(area = case_when(grepl("Ivoire", area) ~ "Cote d'Ivoire",
                          TRUE ~ area),
         iso3c = countrycode(sourcevar = area, origin = "country.name", destination = "iso3c", warn = TRUE)) |> 
  filter(!is.na(iso3c)) |> 
    arrange(item,-mean_value)
)


#need to decide whether we should pick the top 10 producers for things like guar so countries like pakistan are included for pulses nes
top_10_crop_producers <- 
  crop_production |> 
  group_split(item) |> 
  map_df(\(.){ 
    #this takes the top ten producers - unless it is for Guar (Pulses nes) where I used the suggestion that most guar production comes from India, Pakistan and Africa (so subsequently took the top 8 African producers of pulses nes to make up the top 10)
    
    if(unique(.$item) == "Pulses nes"){
      . |> filter(area %in% c("India", "Pakistan", "Kenya", 
                              "Ethiopia", "United Republic of Tanzania", 
                              "Sudan", "Sierra Leone", "Nigeria", 
                              "Guinea",  "Central African Republic"))
      }else{
        . |>  slice(1:10)}
  }
)


write.csv(x = top_10_crop_producers, file = here("data/tidy_data/production-data/top_crop_producers.csv"))
saveRDS(object = top_10_crop_producers, file = here("data/tidy_data/production-data/top_crop_producers.rds"))


```


Now we have the top 10 producers for each crop that is used as a raw material in feed, we need to get conversion factors from ingredients to  each of these raw materials in different places. This was done separately in the Sustainable Aquafeeds Project Teams interface and subsequently transferred to 'tidy_data' in this project. This can be combined with the global demand 

```{r}

#import codes that will be compatible with MAPSPAM layers

plant_ingredient_codes <- 
  read_csv(here("data/tidy_data/diets/plant_ingredient_codes.csv")) |> 
  select(-reference) |> 
  drop_na(ingredient) |> 
  #add_row(ingredient = "pea starch", raw_material = "peas", FAOSTAT_name = "Peas, green", FAO_code = 187, map_spam_code = "opul") |> this row is for if you want pea starch to come from green peas and dried peas - just using dried peas for simplicity
  mutate(FAOSTAT_name = if_else(FAOSTAT_name == "Peas, dry; Peas, green", true = "Peas, dry", false = FAOSTAT_name))

#join codes to top 10 producers and conversion factors data
(top_10_crop_w_cf <- read_csv(here("data/tidy_data/production-data/top_crop_producers_conversions.csv")) |> 
    select(-X7, -mean_value) |> 
  left_join(plant_ingredient_codes |> select(-raw_material), by = c("ingredient", "item" = "FAOSTAT_name"))
)


#join the ingredient demand by diet to the top 10 producer data so for each ingredient there will be an raw material demand per source, and diet scenario. Create new raw_material demand column by dividing total ingredient demand by the conversion factor (i.e. the ingredient extraction rate from the raw material in the first place)
crop_raw_material_demand <- readRDS(here("data/tidy_data/demand/total_ingredient_demand.rds")) |> 
  ungroup() |> 
  left_join(top_10_crop_w_cf, by = c("ingredients" = "ingredient")) |> 
  drop_na(item) |> 
  rename(FAOSTAT_name = item,
         source_country = area,
         source_iso3c = iso3c) |> 
  mutate(total_crop_demand = total_ingredient_demand/cf) |> 
  mutate(ingredients = if_else(ingredients == "canola/camelina oil", true = "canola_camelina oil", false = ingredients)) #to prevent file_path issues later

#export total crop demand for a woring data source
saveRDS(object = crop_raw_material_demand, file = here("data/tidy_data/demand/total_crop_demand.rds"))
  
```


FORAGE FISH INGREDIENTS

Now we need to work out how the ingredient demand converts to forage fish biomass. This will depend on species which depends on geographic region. So we need different conversions from different species. First bring in the demand data and the data from Kok et al re embodied fisg depending on species. This also requires the species list for forage fish.


```{r}
#bring in total ingredient demand data and isolate fishmeal and oil demand

total_ingredient_demand <- readRDS(here("data/tidy_data/demand/total_ingredient_demand.rds"))

fmfo_demand <- total_ingredient_demand |> filter(grepl("Marine", groups))

rm(total_ingredient_demand)

(embodied_fish_ratios <- read_csv(here("data/raw_data/fisheries/embodied_fish_ratio_tidy.csv")) |> 
  mutate(ecosystem_combined = case_when(grepl("IS|NWS|NS|BS", `Ecosystem d`) ~ "North Atlantic",
                                        `Ecosystem d` == "HC" ~ "Humboldt",
                                        `Ecosystem d` == "GM" ~ "Gulf of Mexico", 
                                        `Ecosystem d` == "SO" ~ "Southern Ocean",
                                        `Ecosystem d` == "GA" ~ "Other")) |> 
  select(common_name, sci_name, ecosystem_combined, Ingredient, `2020`) |> 
  mutate(sci_name = case_when(sci_name == "Brevoorti patronus" ~ "Brevoortia patronus",
                              TRUE ~ sci_name)) |> distinct() )

#global values for later
globalav_embodiedfish_fm <- embodied_fish_ratios |> filter(common_name == "Global average" & Ingredient == "Fishmeal") |> pull(`2020`)
globalav_embodiedfish_fo <- embodied_fish_ratios |> filter(common_name == "Global average" & Ingredient == "Fish oil") |> pull(`2020`)


forage_catch <- readRDS(here("data/raw_data/fisheries/spatial_forage_catch_2015.rds")) |> filter(!grepl("krill", CommonName))

(forage_catch_summary <- forage_catch |> 
  group_by(TaxonName, CommonName) |> 
  summarise(total_catch = sum(total_catch, na.rm=TRUE)) |> 
  arrange(-total_catch) |> 
  left_join(embodied_fish_ratios |> filter(Ingredient == "Fishmeal") |> select(-c(Ingredient, ecosystem_combined)) |> rename(fishmeal_cf =`2020`), by = c("TaxonName" = "sci_name")) |> 
    left_join(embodied_fish_ratios |> filter(Ingredient == "Fish oil") |> select(-c(Ingredient, ecosystem_combined)) |> rename(fish_oil_cf =`2020`), by = c("TaxonName" = "sci_name", "common_name"))
)


#plot forage catch to identify main regions for production. The areas I'm interested in is the Humboldt system, the caribeban coast off latin america, the gulf of mexico, the north atlantic, west africa, the western INdian Ocean (India, Red Sea) the east asia regions
forage_xyz <- forage_catch |> 
  select(LonCentre, LatCentre, total_catch) |> 
  rename(x=LonCentre, y= LatCentre, z = total_catch) 

total_forage_raster <- rast(forage_xyz, type="xyz")

plot(log10(total_forage_raster+1))


#CROP THE FISHING REGIONS BY FAO AREA

fao_areas <- c(77, 67, 87, 21, 31, 41, 27, 37, 34, 47, 51,57, 61, 71, 81) #these fao areas broadly correspond with the area of most interest above

#read in the fao area shapefiles from the FAO json
FAO_regions_shp <- read_sf("https://www.fao.org/fishery/geoserver/fifao/ows?service=WFS&request=GetFeature&version=1.0.0&typeName=fifao:FAO_AREAS_CWP_NOCOASTLINE&outputFormat=json") |> filter(F_LEVEL == "MAJOR") |> mutate(F_AREA = as.numeric(F_AREA))

#check FAO shapefile appears correctly
ggplot()+
  geom_sf(data = FAO_regions_shp, 
          aes(fill = F_AREA))


#get the xyz file for each fao region sand create one data frame to join to the forage catch data by coordinates

fao_xyz_of_interest <- map_df(.x = fao_areas, .f = \(this_area){
  
  this_area_shp <- FAO_regions_shp |> filter(F_AREA == this_area)
  
  this_area_raster <- terra::rasterize(x = vect(this_area_shp), y = total_forage_raster, field = this_area_shp$F_AREA)
  
  this_area_xyz <- terra::as.data.frame(x = this_area_raster, xy = TRUE)  |> mutate(area_name = this_area_shp$NAME_EN)
  
  return(this_area_xyz)
  
})

#check the regions
fao_areas_of_interest <- unique(fao_xyz_of_interest$area_name)

#plot the FAO regions used for a supplementary figure
forage_regions_shp <- FAO_regions_shp |> filter(F_AREA %in% fao_areas)
world_shp <- rnaturalearth::ne_countries(scale = 110, returnclass = "sf")
catch_raster <- total_forage_raster |> raster::raster() |> as("SpatialPointsDataFrame") |> as.data.frame()


ggplot()+
  geom_sf(data = forage_regions_shp |> mutate(f_area = factor(F_AREA)), aes(fill = NAME_EN), colour=NA)+
  geom_sf(data = world_shp, size=NA, fill="grey60")+
  labs(fill = "")+
  scale_fill_manual(values = colorRampPalette(RColorBrewer::brewer.pal(7, name = "Blues"))(length(fao_areas)))+
   theme_void()+
  theme(
        panel.background = element_rect(fill= "white", colour = NA),
        plot.background = element_rect(fill= "white", colour = NA),
        axis.title = element_blank(),
        legend.text = element_text(size=6),
        legend.title = element_text(size=6),
        legend.key.size = unit(0.3, "cm"))+
  new_scale_fill()+
  geom_tile(data = catch_raster, aes(x = x, y = y, fill=log10(z+1)))+
  scale_fill_gradientn(colours = RColorBrewer::brewer.pal(9, name = "YlOrRd"))+
  labs(fill = bquote(log[10]~Catch))+
   theme_void()+
  theme(
        panel.background = element_rect(fill= "white", colour=NA),
        plot.background = element_rect(fill= "white", colour = NA),
        axis.title = element_blank(),
        legend.text = element_text(size=4),
        legend.title = element_text(size=4),
        legend.key.size = unit(0.2, "cm"))
  
  
ggsave(filename = here("figures/supplementary/fao_regions_catch.jpeg"), device = "jpg", dpi = 300, width = 13, height = 5, units = "cm")


#join FAO area xyz of interest to catch data and  embodied fish factors to get the potential fmfo provisioning by each area
fao_area_production_potential <- 
  forage_catch |> 
  left_join(fao_xyz_of_interest |> rename(fao_area_code = layer, fao_area_name = area_name), 
            by = c("LonCentre" = "x", "LatCentre" = "y")) |> 
  drop_na(fao_area_name) |>
  group_by(fao_area_name) |> 
  summarise(total_catch = sum(total_catch, na.rm=TRUE)) |> 
  mutate(all_catch = sum(total_catch)) |>  # from this Atlantic Northeast, Eastern Pacific (all regions), and "Other" seem like the best options
  mutate(source_code = case_when(fao_area_name == "Atlantic, Northeast" ~ "NAT",
                                 fao_area_name %in% c("Pacific, Northeast", "Pacific, Eastern Central", "Pacific, Southeast") ~ "EPC",
                                                      TRUE ~ "OTH")) |> 
  ungroup()


#the new umbrella groups - these catch levels are about as even as they can be
source_production_potential <- 
  fao_area_production_potential |> 
  group_by(source_code, all_catch) |> 
  summarise(total_catch = sum(total_catch))



#now distribute fishmeal and oil demand by the proportion of catch the species make up in each source region
forage_catch_w_prop_supply <- 
  forage_catch |> 
  left_join(fao_xyz_of_interest |> rename(fao_area_code = layer, fao_area_name = area_name), 
            by = c("LonCentre" = "x", "LatCentre" = "y")) |> 
  drop_na(fao_area_name) |>
  mutate(source_code = case_when(fao_area_name == "Atlantic, Northeast" ~ "NAT",
                                 fao_area_name %in% c("Pacific, Northeast", "Pacific, Eastern Central", "Pacific, Southeast") ~ "EPC",
                                                      TRUE ~ "OTH")) |> 
  group_by(source_code) |> 
  nest() |> 
  mutate(prop_source_catch = map(data, ~(.$total_catch/sum(.$total_catch)))) |> 
  unnest(cols = c(data, prop_source_catch)) |> 
  ungroup() |> 
  left_join(embodied_fish_ratios |> filter(Ingredient == "Fishmeal") |> select(-c(Ingredient, ecosystem_combined)) |> rename(fishmeal_cf=`2020`), by = c("TaxonName" = "sci_name")) |> 
    left_join(embodied_fish_ratios |> filter(Ingredient == "Fish oil") |> select(-c(Ingredient, ecosystem_combined)) |> rename(fish_oil_cf=`2020`), by = c("TaxonName" = "sci_name", "common_name")) |> 
  mutate(fishmeal_cf = case_when(is.na(common_name) ~ globalav_embodiedfish_fm,
                                 TRUE ~ fishmeal_cf),
         fish_oil_cf = case_when(is.na(common_name) ~ globalav_embodiedfish_fo,
                                 TRUE ~ fish_oil_cf)) |> 
  select(-common_name) 
 


#use the proportions for each region to divide the demand up and work out how the spp_based demand converts to embodied fish

forage_supply_demand_by_diet <- 
  map_df(.x =  c("marine_diet", "plant_diet"), .f = \(this_diet){
    
    this_df <- forage_catch_w_prop_supply |> 
      mutate(diet = this_diet,
             fm_demand = fmfo_demand |> filter(diet == this_diet & ingredients == "fishmeal-wild") |> pull(total_ingredient_demand),
             fo_demand = fmfo_demand |> filter(diet == this_diet & ingredients == "fish oil-wild") |> pull(total_ingredient_demand),
             spp_fm_demand = fm_demand * prop_source_catch,
             spp_fo_demand = fo_demand * prop_source_catch,
             fm_embodied_fish = spp_fm_demand * fishmeal_cf,
             fo_embodied_fish = spp_fo_demand * fish_oil_cf,
             total_embodied_fish = fm_embodied_fish+fo_embodied_fish) |> 
      mutate(demand_vs_supply = total_embodied_fish/total_catch) |> 
      relocate(diet, .before = source_code)
    
  })
```


Now do some checks on if demand and supply match up per record i.e. by per cell-species-gear combinations. 

```{r}
#check the demand vs supply match up - are there cells where supply is outstripped by demand? 
forage_supply_demand_by_diet |> filter(demand_vs_supply>1) #lots of rows where demand exceeds supply - likely due to global average conversions, but by how much typically?
nrow(forage_supply_demand_by_diet |> filter(demand_vs_supply>1))/nrow(forage_supply_demand_by_diet) # in 4% of catch records demand exceed catch in 2015
forage_supply_demand_by_diet |> filter(demand_vs_supply>1) |> pull(demand_vs_supply) |> unique() #nothing exceeding 1.16 of catch. How much does this matter- i.e. what does that equate to in tonnes and is that within a range of variation for that cell?
nrow(forage_supply_demand_by_diet |> filter(demand_vs_supply>1.1))/nrow(forage_supply_demand_by_diet) #only in 2% of catch records was demand over 10% higher than supply

#look at what quantities and proportion demand exceeded supply by
exceedance_check <- forage_supply_demand_by_diet |> 
        mutate(exceedance = case_when(demand_vs_supply>1 ~ (demand_vs_supply-1)*total_embodied_fish,
                                      TRUE ~ total_embodied_fish-total_catch)) |>
   mutate(prop_exceedance = case_when(exceedance>0 ~ exceedance/total_catch,
                                      TRUE ~ 0))

#what is the maximum exceedance in tonnage?
max_exceedance <- exceedance_check |> pull(exceedance) |> max() #2826 tonnes - might not be so bad depending on the cell
#but what does the catch look like when max absolute exceedance occurs?
exceedance_check |> filter(exceedance == max_exceedance) # catch is 17000 tonnes when demand exceeds catch by as much as 2800 tonnes
#what is the maximum proportional exceedance?
max_prop_exceedance <- exceedance_check |> pull(prop_exceedance) |> max() #19% this is kinda high for a cell.
#hat is the catch when proportional exceedance is this high?
exceedance_check |> filter(prop_exceedance == max_prop_exceedance) # catch is tiny when proportional exceedance is maximised 
 
#plot it out to chekc the pattern
exceedance_only_df <- 
  exceedance_check |> filter(demand_vs_supply>1)

#no real pattern to the relationshoip between size and prop of exceedance  so will have redistribute
ggplot(data = exceedance_only_df)+
  aes(x=prop_exceedance, y = exceedance+1)+
  geom_point(alpha=0.3)+
  scale_y_continuous(trans = "log10")





#redistribute the demand in cells where it is greater than supply across other cells. Do this independently for each diet-source combo though, so need to split the data.
forage_supply_demand_list <- forage_supply_demand_by_diet |> 
  relocate(diet, .before = source_code) |> 
  group_split(diet, source_code)

this_df <- forage_supply_demand_list[[1]]


# forage_supply_demand_redistributed <- 
  map(.x = forage_supply_demand_list, .f = \(this_df){
    
    exceed_supply <- this_df |> filter(demand_vs_supply>1)
    below_supply <- this_df |> filter(demand_vs_supply<=1)
    
    if(nrow(exceed_supply)>0){
    exceed_supply2 <-  exceed_supply |>
        mutate(exceedance = (demand_vs_supply-1)*total_embodied_fish)
      
    below_supply2 <- below_supply |> 
        mutate(exceedance = total_embodied_fish-total_catch)
    
    total_exceedance <- sum(exceed_supply2$exceedance)


      
      
    #}
    
    
  })

```


```{r}
#Which regions can meet demand? This will decide the sourcing regions.
#Pacific Southeast and Atlantic Northeast can reach demand as regions alone. All other regions can be grouped. 
supply_vs_demand_byarea <- 
  FMFO_potential_frm_catch |> 
  group_by(fao_area_name, fao_area_code) |> 
  summarise(total_catch = sum(total_catch),
            total_fm_supply = sum(fm_potential),
            total_fo_supply = sum(fo_potential)) |> 
  mutate(marine_diet_fm_demand = fmfo_demand |> filter(diet == "marine_diet" & ingredients == "fishmeal-wild") |> pull(total_ingredient_demand), 
         plant_diet_fm_demand = fmfo_demand |> filter(diet == "plant_diet" & ingredients == "fishmeal-wild") |> pull(total_ingredient_demand)) |> 
  relocate(c(marine_diet_fm_demand, plant_diet_fm_demand), .before = total_fo_supply) |> 
  mutate(marine_diet_fo_demand = fmfo_demand |> filter(diet == "marine_diet" & ingredients == "fish oil-wild") |> pull(total_ingredient_demand), 
         plant_diet_fo_demand = fmfo_demand |> filter(diet == "plant_diet" & ingredients == "fish oil-wild") |> pull(total_ingredient_demand))


#now add source regions (Humboldt, North Atlantic, and "other")

source_region_supply_props <- 
  FMFO_potential_frm_catch |> 
  ungroup() |> 
  select(-prop_region_catch) |> 
  mutate(source_code = case_when(fao_area_name == "Pacific, Southeast" ~ "HB",
                            fao_area_name == "Atlantic, Northeast" ~ "NA",
                            TRUE ~ "OT")) |> 
  group_by(source_code) |> 
  nest() |> 
  mutate(total_source_fm_potential = map(data, ~sum(.$)),
         total_source_fo_potential = map(data, ~sum(.$fo_potential))) |> 
  unnest(cols = c(data, total_source_fm_potential, total_source_fo_potential))


    prop_regional_catch = map(data, ~(.$total_catch/sum(.$total_catch)))) |> 
  unnest(cols = c(data, prop_regional_catch)) |>
  ungroup() #



diets <- c("marine_diet", "plant_diet")

map_df(.x = diets, .f = \(this_diet){
  this_diet_supply_demand <- 
    source_region_supply_props |> 
    mutate(diet = this_diet,
           total_fm_demand = fmfo_demand |> filter(diet == this_diet & ingredients == "fishmeal-wild") |> pull(total_ingredient_demand),
           total_fo_demand = fmfo_demand |> filter(diet == this_diet & ingredients == "fish oil-wild") |> pull(total_ingredient_demand)) |> 
    mutate(spp_fm_demand = total_fm_demand*prop_fm_potential,
           spp_fo_demand = total_fo_demand*prop_fo_potential,
           spp_fm_demand = )
})
  
  
  
  
   #demand for fish meal from marine and plant diets
  mutate(marine_diet_fm_demand = fmfo_demand |> filter(diet == "marine_diet" & ingredients == "fishmeal-wild") |> pull(total_ingredient_demand), 
         plant_diet_fm_demand = fmfo_demand |> filter(diet == "plant_diet" & ingredients == "fishmeal-wild") |> pull(total_ingredient_demand),
  #demand for fish oil from marine and plant diets
  marine_diet_fo_demand = fmfo_demand |> filter(diet == "marine_diet" & ingredients == "fish oil-wild") |> pull(total_ingredient_demand), 
         plant_diet_fo_demand = fmfo_demand |> filter(diet == "plant_diet" & ingredients == "fish oil-wild") |> pull(total_ingredient_demand)) 

  group_by(source_code, marine_diet_fm_demand, plant_diet_fm_demand, marine_diet_fo_demand, plant_diet_fo_demand) |> 
  summarise(total_fm_supply = sum(total_fm_supply), total_fo_supply = sum(total_fo_supply)) |> 
  mutate(marine_diet_fm_catch_ratio = )



forage_catch |> 
  left_join(fao_xyz_of_interest |> rename(fao_area_code = layer, fao_area_name = area_name), 
            by = c("LonCentre" = "x", "LatCentre" = "y")) |> 
  drop_na(fao_area_name) |> 
  mutate(source_code = case_when(fao_area_name == "Pacific, Southeast" ~ "HB",
                            fao_area_name == "Atlantic, Northeast" ~ "NA",
                            TRUE ~ "OT"))


#marine diet
(fmfo_demand |> filter(diet == "marine_diet" & ingredients == "fishmeal-wild") |> pull(total_ingredient_demand)* globalav_embodiedfish_fm)+
  (fmfo_demand |> filter(diet == "marine_diet" & ingredients == "fish oil-wild") |> pull(total_ingredient_demand)* globalav_embodiedfish_fo)

#plant diet 
(fmfo_demand |> filter(diet == "plant_diet" & ingredients == "fishmeal-wild") |> pull(total_ingredient_demand)* globalav_embodiedfish_fm)+
  (fmfo_demand |> filter(diet == "plant_diet" & ingredients == "fish oil-wild") |> pull(total_ingredient_demand)* globalav_embodiedfish_fo)
  
  
```




  
  

