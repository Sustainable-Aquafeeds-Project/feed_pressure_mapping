---
title: "Query IUCN API"
author: "Rich Cottrell"
date: "23/02/2022"
output: html_document
---

```{r}
library(tidyverse)
library(furrr)
library(tictoc)
library(janitor)
library(here)
library(rredlist)
library(jsonlite)
library(parallel)

source(here("src/directories.R"))
source(here("src/iucn_fxs.R"))

```

Get a species list
```{r}


sppcount_url <- sprintf("https://apiv3.iucnredlist.org/api/v3/speciescount?token=%s", api_key)
nspp <- jsonlite::fromJSON(sppcount_url) %>% .$speciescount %>% as.integer()

pagelist <- c(0:(ceiling(nspp/10000)-1)) #10000 is number of species presented per page


spp_list_df <- bind_rows(mclapply(X = pagelist, FUN = get_spp_api, mc.cores = detectCores())) %>% 
  select(-infra_name, -infra_rank) %>% 
  setNames(names(.) %>% 
             str_replace("_name", ""))


saveRDS(object = spp_list_df, file = here("data/raw_data/iucn/spp_list.rds"), compress = TRUE)


```

Get species habitat data. Note - this takes days to run. Don't run if not needed.

```{r}

spp_list <- 
  readRDS(file = here("data/raw_data/iucn/spp_list.rds")) %>% pull(taxonid) %>% as.list()
  
# mclapply version - seems quicker on small lists but cannot monitor through message whether it's still processing
# tic()
# habitat_list_df <- bind_rows(mclapply(X = spp_list, FUN = get_habitat_api, mc.cores = 8))
# toc()

#future/furrr parallelisation with timer
future::plan(strategy = multisession, workers =8)
tic()
habitat_list_df <- future_map(spp_list,  get_habitat_api)
toc()




```

