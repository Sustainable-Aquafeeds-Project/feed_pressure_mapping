---
title: "11_crop_disturbance_pressures"
author: "Rich Cottrell"
date: "29/06/2022"
output: html_document
---

Here we use the MAPSPAM physical area parameter as our disturbance metric for crops following the assumptions of Halpern et al 2022 that cropland creates complete disturbance to natural systems where they exist.

```{r}
library(tidyverse)
library(terra)
library(here)

source(here("src/directories.R"))

```

Import the crop demand data to get the FAO-MAPSPAM look up names

```{r}

mapspam_fao_lookup <- 
  readRDS(here("data/tidy_data/demand/total_crop_demand.rds")) |> 
  select(FAOSTAT_name, map_spam_code, source_country) |> 
  distinct() |> 
  mutate(map_spam_code = toupper(map_spam_code),
         iso3c = countrycode(sourcevar = source_country, origin = "country.name", destination = "iso3c", warn=TRUE))


```

Import the demand-production comparisons for crops to adjust the physical area (under the assumption it is yields that have increased).

```{r}

crop_sources <- readRDS(here("data/tidy_data/demand/crop_sourcing_countries_plausible_impacts.rds")) 

demand_production_compare <- readRDS(here("data/tidy_data/demand/crop_demand_production_compare.rds")) |> group_split(ingredients, diet, map_spam_code)

this_crop <- demand_production_compare[[1]]

#filter the production compare by the sources used in the analysis

demand_production_compare_w_sources <- 
  
  map_df(demand_production_compare, \(this_crop){
  
  sources <- crop_sources |> filter(FAOSTAT_name == unique(this_crop$FAOSTAT_name)) |> pull(iso3c)
  
  this_crop_adj <- this_crop |> filter(iso3c %in% sources)
}) |> 
  filter(!(FAOSTAT_name == "Linseed" & source_iso3c %in% c("CHN", "GBR"))) |> 
  filter(demand_production_ratio>0)

```

Adjust area rasters by the demand_production ratio and save in the int folder for each diet.

```{r}

crop_area_files <- list.files(here("data/spatial/crop-layers-reprojected"), pattern = "_A_", full.names = TRUE)

country_rast_files <- list.files(here("data/spatial/country-rasters"), full.names = TRUE)

scalar_source_list <- 
  demand_production_compare_w_sources |> 
  group_split(ingredients, diet, FAOSTAT_name, source_iso3c)
  
this_file <- scalar_source_list[[1]]


#rescale area by the demand-production ratio
map(.x = scalar_source_list, \(this_file){
  
  this_ingredient <- this_file$ingredients 
  
  this_mapspam_code <- toupper(this_file$map_spam_code)
 
  this_diet <- this_file$diet
  
  this_country <- this_file$source_iso3c
  
  this_scalar <- this_file$demand_production_ratio
  
  saveName <- sprintf(here("data/spatial/%s/int/%s_disturbance_km2_%s.tif"), this_diet, this_ingredient, this_country)
  
  if(!file.exists(saveName)){
    
    #raw area rasters are already in km2 so no need to convert
    this_raw_rast <- rast(crop_area_files[grepl(this_mapspam_code, crop_area_files)]) 
  
    this_country_rast <- rast(country_rast_files[grepl(this_country, country_rast_files)])
    
    this_country_area_rast <- this_raw_rast*this_country_rast*this_scalar
    names(this_country_area_rast) <- "Disturbance (km2)"
    
    writeRaster(x= this_country_area_rast, filename = saveName, overwrite=TRUE)

  }
})

```

