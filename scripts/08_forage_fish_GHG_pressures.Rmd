---
title: "08_forage_fish_GHG_pressures"
author: "Rich Cottrell"
date: "29/06/2022"
output: html_document
---

```{r}
library(tidyverse)
library(terra)
library(sf)
library(data.table)
library(dtplyr)
library(here)

source(here("src/directories.R"))
source(here("src/spatial.R"))


```

Bringing in the emission intensity data from Halpern et al stored in RDSI and tidy to distinct categories with functional groups associated with the Watson data.
```{r}

ei_data <- 
  fread(file.path(food_systems_data_dir, "all_catch_emissions_2017.csv")) |> 
  lazy_dt(immutable = FALSE) |> 
  select(Taxonkey, Descript, species_class_int, species_class_fin, ParkerGearName = gear_type, ei_kgco2_kgcatch) |> 
  distinct() |> 
  arrange(ParkerGearName)|> 
  as_tibble()
  

```

Now join the embodied fish demand xy data with the emission intensity data and calculate the emissions from each gear in each cell. Then we can save the rasters for each diet and source

```{r}

embodied_fish <- fread(here("data/tidy_data/demand/embodied_fish_per_cell.csv"))

#take a look at the differences between gears for watson data and the ei data 
unique(ei_data$gear_type)
unique(embodied_fish$VBDesc)

#Gear classifications are different. So we need the join file with Parker Data created in Halpern et al food systems project
parker_gear_join <- read_csv(here("data/raw_data/fisheries/parker_gear_join.csv"))

#now join parker gear data to the embodied fish by the parker gear categories, species and description from watson. Adjust the emissions intensities to reflect per tonne pressures
embodied_fish_new_gear <- 
  embodied_fish |> 
  lazy_dt(immutable = FALSE) |> 
  left_join(parker_gear_join, by="Gear") |> 
  left_join(ei_data, by = c("Taxonkey", "Descript", "ParkerGearName")) |> 
  as_tibble() |> 
  mutate(adj_embodied_fish_kg = adj_embodied_fish *1000) |> 
  mutate(ei_kg_CO2_eq = adj_embodied_fish_kg*ei_kgco2_kgcatch)

#embodied_fish_new_gear |> filter(is.na(ei_kgco2_kgcatch))
#no missing emissions intensity data - what we want.


ghg_list <- embodied_fish_new_gear |> 
  select(diet, source_code, LonCentre, LatCentre, ei_kg_CO2_eq) |> 
  group_by(diet, source_code, LonCentre, LatCentre) |> 
  summarise(total_GWP_km2 = sum(ei_kg_CO2_eq, na.rm=TRUE)) |> 
  ungroup() |> 
  group_split(diet, source_code)



ghg_raw_r_list <- 
  
  map(.x = ghg_list, .f = \(this_df) {
  
  this_source <- unique(this_df$source_code)
  
  this_diet <- unique(this_df$diet)
  
  saveName <- sprintf(here("data/spatial/%s/forage_fish_ghg_raw_%s_%s.tif"), this_diet, this_diet, this_source)
  
  if(file.exists(saveName)){
    
    this_xy <- this_df |> select(LonCentre, LatCentre, total_GWP_km2)
    
    this_r <- rast(this_xy, type = "xyz", crs = "EPSG:4326") |> extend(ext(rast(res=0.5)))
    
    this_r_km2 <- this_r/cellSize(this_r, unit="km")
    
    writeRaster(x = this_r_km2, filename = saveName, overwrite=TRUE)
    
    return(this_r_km2)
  }
})

#check the rasters
plot(rast(ghg_raw_r_list))

```

Now we need to rescale all values

```{r}

```

