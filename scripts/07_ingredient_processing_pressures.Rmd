---
title: "Assign environmental pressures to processing data"
author: "Rich Cottrell"
date: '2023-08-25'
output: html_document
---


```{r setup, include=FALSE}

library(tidyverse)
library(here)
library(terra)
library(countrycode)

select <- dplyr::select

#allocation method (un-comment preference)
this_allocation_method <- "econ_allocation"
# this_allocation_method <- "ge_allocation"
# this_allocation_method <- "mass_allocation"


```


Bring in the LCA data for processing pressures for each ingredient and filter for pressures of interest

```{r}
# We are interested in the same processing pressures as those used in the crops data and we want data based on our chosen allocation factor

processing_main_pressures <- readRDS(here("data/tidy_data/LCA/processing_LCA.rds")) |> 
  filter(impact %in% c("Global warming", "Water consumption", "Land use", "Freshwater eutrophication", "Marine eutrophication")) |> 
  filter(allocation == this_allocation_method) |> 
  mutate(value_tonne = value*1000) |>  #changes value per kg to per metric tonne
  mutate(continent = countrycode(iso3c, origin = "iso3c", destination = "continent", warn = TRUE))

```


Bring in processing locations and assign pressures based on ingredient demand per diet

```{r}

ingredient_demand <- readRDS(here("data/tidy_data/demand/total_ingredient_demand.rds"))



#marine diet

diets <- c("marine_diet", "plant_diet")


this_diet <- "marine_diet"

this_ingredient_source <- these_ingredient_files[[1]]

map(.x = diets, .f = \(this_diet){
    
  this_dietary_demand <- ingredient_demand |> 
    filter(diet == this_diet & total_ingredient_demand>0) |> 
    mutate(ingredients = gsub("-wild", "", ingredients))
  
  these_dietary_processing_files <- list.files(path = sprintf(here("data/spatial/%s/processing"), this_diet), full.names = TRUE)
  
  these_ingredients <- this_dietary_demand$ingredients |> unique()
  
  map(these_ingredients, .f = \(this_ingredient){
    
    these_ingredient_files <- these_dietary_processing_files[grep(paste0(this_ingredient, "_"), these_dietary_processing_files)]
    
    map(these_ingredient_files, \(this_ingredient_source){
      
      basename_no_ext <- tools::file_path_sans_ext(basename(this_ingredient_source))
      
      this_source <- str_sub(basename_no_ext,  start = nchar(basename_no_ext)-2, end = nchar(basename_no_ext))
      
      this_continent <- countrycode(this_source, "iso3c", "continent")
      
      this_ingredient_source_raster <- rast(this_ingredient_source)
      
      this_ingredient_pressures <- processing_main_pressures |> filter(ingredient == this_ingredient)
      
      this_ingredients_unique_processing_countries <- this_ingredient_pressures |> pull(iso3c) |> unique()
      
      this_ghg_value <- if_else(this_source %in% this_ingredients_unique_processing_countries,
              true = this_ingredient_pressures |> filter(impact == "Global warming" & iso3c == this_source) |> pull(value_tonne),
              false = if_else(this_continent %in% c(this_ingredient_pressures |> pull(continent) |> unique()),
                              true = sample(x = this_ingredient_pressures |>
                                              filter(impact == "Global warming" & continent == this_continent) |> 
                                              pull(value_tonne) |> 
                                              unique(), 
                                            size=1),
                              false = sample(x = this_ingredient_pressures |>
                                              filter(impact == "Global warming") |> 
                                              pull(value_tonne) |> 
                                              unique(), 
                                            size=1)))
                
                
                this_ingredient_pressures |> filter(impact == "Global warming" & th))
      
      this_dist_value <- 
      
      
    })
    
    this_processing_quantity_raster <-  
    
    
    
    
  })
  
    
    
    
    
  })




```


